"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9135],{9745:(e,t,r)=>{r.d(t,{BN:()=>ud,H9:()=>ld,aU:()=>lv});var n,i,s,a,o=r(1055),l=r(2881),u=r(6702),h=r(1280),c=r(2107),d=r(927),f=r(9509),m=r(9641).Buffer;let g="@firebase/firestore",p="4.9.0";class y{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}y.UNAUTHENTICATED=new y(null),y.GOOGLE_CREDENTIALS=new y("google-credentials-uid"),y.FIRST_PARTY=new y("first-party-uid"),y.MOCK_USER=new y("mock-user");let w="12.0.0",v=new u.Vy("@firebase/firestore");function I(){return v.logLevel}function T(e,...t){if(v.logLevel<=u.$b.DEBUG){let r=t.map(_);v.debug(`Firestore (${w}): ${e}`,...r)}}function b(e,...t){if(v.logLevel<=u.$b.ERROR){let r=t.map(_);v.error(`Firestore (${w}): ${e}`,...r)}}function E(e,...t){if(v.logLevel<=u.$b.WARN){let r=t.map(_);v.warn(`Firestore (${w}): ${e}`,...r)}}function _(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function S(e,t,r){let n="Unexpected state";"string"==typeof t?n=t:r=t,x(e,n,r)}function x(e,t,r){let n=`FIRESTORE (${w}) INTERNAL ASSERTION FAILED: ${t} (ID: ${e.toString(16)})`;if(void 0!==r)try{n+=" CONTEXT: "+JSON.stringify(r)}catch(e){n+=" CONTEXT: "+r}throw b(n),Error(n)}function N(e,t,r,n){let i="Unexpected state";"string"==typeof r?i=r:n=r,e||x(t,i,n)}let D={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class C extends h.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class k{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class A{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class V{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(y.UNAUTHENTICATED))}shutdown(){}}class R{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class M{constructor(e){this.t=e,this.currentUser=y.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){N(void 0===this.o,42304);let r=this.i,n=e=>this.i!==r?(r=this.i,t(e)):Promise.resolve(),i=new k;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new k,e.enqueueRetryable(()=>n(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await n(this.currentUser)})},a=e=>{T("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(T("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new k)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(T("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(N("string"==typeof t.accessToken,31837,{l:t}),new A(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return N(null===e||"string"==typeof e,2055,{h:e}),new y(e)}}class O{constructor(e,t,r){this.P=e,this.T=t,this.I=r,this.type="FirstParty",this.user=y.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);let e=this.R();return e&&this.A.set("Authorization",e),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class P{constructor(e,t,r){this.P=e,this.T=t,this.I=r}getToken(){return Promise.resolve(new O(this.P,this.T,this.I))}start(e,t){e.enqueueRetryable(()=>t(y.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class F{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class L{constructor(e,t){this.V=t,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,(0,o.xZ)(e)&&e.settings.appCheckToken&&(this.p=e.settings.appCheckToken)}start(e,t){N(void 0===this.o,3512);let r=e=>{null!=e.error&&T("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let r=e.token!==this.m;return this.m=e.token,T("FirebaseAppCheckTokenProvider",`Received ${r?"new":"existing"} token.`),r?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>r(t))};let n=e=>{T("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(e=>n(e)),setTimeout(()=>{if(!this.appCheck){let e=this.V.getImmediate({optional:!0});e?n(e):T("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new F(this.p));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(N("string"==typeof e.token,44558,{tokenResult:e}),this.m=e.token,new F(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class U{static newId(){let e=62*Math.floor(256/62),t="";for(;t.length<20;){let r=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(r);else for(let e=0;e<40;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let n=0;n<r.length;++n)t.length<20&&r[n]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(r[n]%62))}return t}}function q(e,t){return e<t?-1:+(e>t)}function B(e,t){let r=Math.min(e.length,t.length);for(let n=0;n<r;n++){let r=e.charAt(n),i=t.charAt(n);if(r!==i)return z(r)===z(i)?q(r,i):z(r)?1:-1}return q(e.length,t.length)}function z(e){let t=e.charCodeAt(0);return t>=55296&&t<=57343}function K(e,t,r){return e.length===t.length&&e.every((e,n)=>r(e,t[n]))}let $="__name__";class G{constructor(e,t,r){void 0===t?t=0:t>e.length&&S(637,{offset:t,range:e.length}),void 0===r?r=e.length-t:r>e.length-t&&S(1746,{length:r,range:e.length-t}),this.segments=e,this.offset=t,this.len=r}get length(){return this.len}isEqual(e){return 0===G.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof G?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,r=this.limit();t<r;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let r=Math.min(e.length,t.length);for(let n=0;n<r;n++){let r=G.compareSegments(e.get(n),t.get(n));if(0!==r)return r}return q(e.length,t.length)}static compareSegments(e,t){let r=G.isNumericId(e),n=G.isNumericId(t);return r&&!n?-1:!r&&n?1:r&&n?G.extractNumericId(e).compare(G.extractNumericId(t)):B(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return c.jz.fromString(e.substring(4,e.length-2))}}class j extends G{construct(e,t,r){return new j(e,t,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let r of e){if(r.indexOf("//")>=0)throw new C(D.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);t.push(...r.split("/").filter(e=>e.length>0))}return new j(t)}static emptyPath(){return new j([])}}let Q=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class W extends G{construct(e,t,r){return new W(e,t,r)}static isValidIdentifier(e){return Q.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),W.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===$}static keyField(){return new W([$])}static fromServerFormat(e){let t=[],r="",n=0,i=()=>{if(0===r.length)throw new C(D.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(r),r=""},s=!1;for(;n<e.length;){let t=e[n];if("\\"===t){if(n+1===e.length)throw new C(D.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[n+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new C(D.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=t,n+=2}else"`"===t?s=!s:"."!==t||s?r+=t:i(),n++}if(i(),s)throw new C(D.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new W(t)}static emptyPath(){return new W([])}}class H{constructor(e){this.path=e}static fromPath(e){return new H(j.fromString(e))}static fromName(e){return new H(j.fromString(e).popFirst(5))}static empty(){return new H(j.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===j.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return j.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new H(new j(e.slice()))}}function J(e){if(!H.isDocumentKey(e))throw new C(D.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Y(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}function X(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let r=(t=e).constructor?t.constructor.name:null;return r?`a custom ${r} object`:"an object"}}return"function"==typeof e?"a function":S(12329,{type:typeof e})}function Z(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new C(D.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let r=X(e);throw new C(D.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${r}`)}}return e}function ee(e,t){let r={typeString:e};return t&&(r.value=t),r}function et(e,t){let r;if(!Y(e))throw new C(D.INVALID_ARGUMENT,"JSON must be an object");for(let n in t)if(t[n]){let i=t[n].typeString,s="value"in t[n]?{value:t[n].value}:void 0;if(!(n in e)){r=`JSON missing required field: '${n}'`;break}let a=e[n];if(i&&typeof a!==i){r=`JSON field '${n}' must be a ${i}.`;break}if(void 0!==s&&a!==s.value){r=`Expected '${n}' field to equal '${s.value}'`;break}}if(r)throw new C(D.INVALID_ARGUMENT,r);return!0}class er{static now(){return er.fromMillis(Date.now())}static fromDate(e){return er.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),r=Math.floor((e-1e3*t)*1e6);return new er(t,r)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new C(D.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new C(D.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?q(this.nanoseconds,e.nanoseconds):q(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:er._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(e){if(et(e,er._jsonSchema))return new er(e.seconds,e.nanoseconds)}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}er._jsonSchemaVersion="firestore/timestamp/1.0",er._jsonSchema={type:ee("string",er._jsonSchemaVersion),seconds:ee("number"),nanoseconds:ee("number")};class en{static fromTimestamp(e){return new en(e)}static min(){return new en(new er(0,0))}static max(){return new en(new er(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class ei{constructor(e,t,r,n){this.indexId=e,this.collectionGroup=t,this.fields=r,this.indexState=n}}function es(e){return e.fields.find(e=>2===e.kind)}function ea(e){return e.fields.filter(e=>2!==e.kind)}ei.UNKNOWN_ID=-1;class eo{constructor(e,t){this.fieldPath=e,this.kind=t}}class el{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new el(0,ec.min())}}function eu(e,t){let r=e.toTimestamp().seconds,n=e.toTimestamp().nanoseconds+1;return new ec(en.fromTimestamp(1e9===n?new er(r+1,0):new er(r,n)),H.empty(),t)}function eh(e){return new ec(e.readTime,e.key,-1)}class ec{constructor(e,t,r){this.readTime=e,this.documentKey=t,this.largestBatchId=r}static min(){return new ec(en.min(),H.empty(),-1)}static max(){return new ec(en.max(),H.empty(),-1)}}function ed(e,t){let r=e.readTime.compareTo(t.readTime);return 0!==r?r:0!==(r=H.comparator(e.documentKey,t.documentKey))?r:q(e.largestBatchId,t.largestBatchId)}let ef="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class em{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function eg(e){if(e.code!==D.FAILED_PRECONDITION||e.message!==ef)throw e;T("LocalStore","Unexpectedly lost primary lease")}class ep{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&S(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new ep((r,n)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(r,n)},this.catchCallback=e=>{this.wrapFailure(t,e).next(r,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof ep?t:ep.resolve(t)}catch(e){return ep.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):ep.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):ep.reject(t)}static resolve(e){return new ep((t,r)=>{t(e)})}static reject(e){return new ep((t,r)=>{r(e)})}static waitFor(e){return new ep((t,r)=>{let n=0,i=0,s=!1;e.forEach(e=>{++n,e.next(()=>{++i,s&&i===n&&t()},e=>r(e))}),s=!0,i===n&&t()})}static or(e){let t=ep.resolve(!1);for(let r of e)t=t.next(e=>e?ep.resolve(e):r());return t}static forEach(e,t){let r=[];return e.forEach((e,n)=>{r.push(t.call(this,e,n))}),this.waitFor(r)}static mapArray(e,t){return new ep((r,n)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&r(s)},e=>n(e))}})}static doWhile(e,t){return new ep((r,n)=>{let i=()=>{!0===e()?t().next(()=>{i()},n):r()};i()})}}let ey="SimpleDb";class ew{static open(e,t,r,n){try{return new ew(t,e.transaction(n,r))}catch(e){throw new eb(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.S=new k,this.transaction.oncomplete=()=>{this.S.resolve()},this.transaction.onabort=()=>{t.error?this.S.reject(new eb(e,t.error)):this.S.resolve()},this.transaction.onerror=t=>{let r=eN(t.target.error);this.S.reject(new eb(e,r))}}get D(){return this.S.promise}abort(e){e&&this.S.reject(e),this.aborted||(T(ey,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}C(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new e_(this.transaction.objectStore(e))}}class ev{static delete(e){return T(ey,"Removing database:",e),eS((0,h.mS)().indexedDB.deleteDatabase(e)).toPromise()}static v(){if(!(0,h.zW)())return!1;if(ev.F())return!0;let e=(0,h.ZQ)(),t=ev.M(e),r=eI(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<r&&r<4.5)}static F(){return void 0!==f&&"YES"===f.__PRIVATE_env?.__PRIVATE_USE_MOCK_PERSISTENCE}static O(e,t){return e.store(t)}static M(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}constructor(e,t,r){this.name=e,this.version=t,this.N=r,this.B=null,12.2===ev.M((0,h.ZQ)())&&b("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async L(e){return this.db||(T(ey,"Opening database:",this.name),this.db=await new Promise((t,r)=>{let n=indexedDB.open(this.name,this.version);n.onsuccess=e=>{t(e.target.result)},n.onblocked=()=>{r(new eb(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},n.onerror=t=>{let n=t.target.error;"VersionError"===n.name?r(new C(D.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===n.name?r(new C(D.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+n)):r(new eb(e,n))},n.onupgradeneeded=e=>{T(ey,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.N.k(t,n.transaction,e.oldVersion,this.version).next(()=>{T(ey,"Database upgrade to version "+this.version+" complete")})}})),this.q&&(this.db.onversionchange=e=>this.q(e)),this.db}$(e){this.q=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,r,n){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.L(e);let t=ew.open(this.db,e,i?"readonly":"readwrite",r),s=n(t).next(e=>(t.C(),e)).catch(e=>(t.abort(e),ep.reject(e))).toPromise();return s.catch(()=>{}),await t.D,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(T(ey,"Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function eI(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class eT{constructor(e){this.U=e,this.K=!1,this.W=null}get isDone(){return this.K}get G(){return this.W}set cursor(e){this.U=e}done(){this.K=!0}j(e){this.W=e}delete(){return eS(this.U.delete())}}class eb extends C{constructor(e,t){super(D.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function eE(e){return"IndexedDbTransactionError"===e.name}class e_{constructor(e){this.store=e}put(e,t){let r;return void 0!==t?(T(ey,"PUT",this.store.name,e,t),r=this.store.put(t,e)):(T(ey,"PUT",this.store.name,"<auto-key>",e),r=this.store.put(e)),eS(r)}add(e){return T(ey,"ADD",this.store.name,e,e),eS(this.store.add(e))}get(e){return eS(this.store.get(e)).next(t=>(void 0===t&&(t=null),T(ey,"GET",this.store.name,e,t),t))}delete(e){return T(ey,"DELETE",this.store.name,e),eS(this.store.delete(e))}count(){return T(ey,"COUNT",this.store.name),eS(this.store.count())}J(e,t){let r=this.options(e,t),n=r.index?this.store.index(r.index):this.store;if("function"==typeof n.getAll){let e=n.getAll(r.range);return new ep((t,r)=>{e.onerror=e=>{r(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(r),t=[];return this.H(e,(e,r)=>{t.push(r)}).next(()=>t)}}Y(e,t){let r=this.store.getAll(e,null===t?void 0:t);return new ep((e,t)=>{r.onerror=e=>{t(e.target.error)},r.onsuccess=t=>{e(t.target.result)}})}Z(e,t){T(ey,"DELETE ALL",this.store.name);let r=this.options(e,t);r.X=!1;let n=this.cursor(r);return this.H(n,(e,t,r)=>r.delete())}ee(e,t){let r;t?r=e:(r={},t=e);let n=this.cursor(r);return this.H(n,t)}te(e){let t=this.cursor({});return new ep((r,n)=>{t.onerror=e=>{n(eN(e.target.error))},t.onsuccess=t=>{let n=t.target.result;n?e(n.primaryKey,n.value).next(e=>{e?n.continue():r()}):r()}})}H(e,t){let r=[];return new ep((n,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void n();let s=new eT(i),a=t(i.primaryKey,i.value,s);if(a instanceof ep){let e=a.catch(e=>(s.done(),ep.reject(e)));r.push(e)}s.isDone?n():null===s.G?i.continue():i.continue(s.G)}}).next(()=>ep.waitFor(r))}options(e,t){let r;return void 0!==e&&("string"==typeof e?r=e:t=e),{index:r,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let r=this.store.index(e.index);return e.X?r.openKeyCursor(e.range,t):r.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function eS(e){return new ep((t,r)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{r(eN(e.target.error))}})}let ex=!1;function eN(e){let t=ev.M((0,h.ZQ)());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new C("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ex||(ex=!0,setTimeout(()=>{throw e},0)),e}}return e}let eD="IndexBackfiller";class eC{constructor(e,t){this.asyncQueue=e,this.ne=t,this.task=null}start(){this.re(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}re(e){T(eD,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{let e=await this.ne.ie();T(eD,`Documents written: ${e}`)}catch(e){eE(e)?T(eD,"Ignoring IndexedDB error during index backfill: ",e):await eg(e)}await this.re(6e4)})}}class ek{constructor(e,t){this.localStore=e,this.persistence=t}async ie(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.se(t,e))}se(e,t){let r=new Set,n=t,i=!0;return ep.doWhile(()=>!0===i&&n>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!r.has(t))return T(eD,`Processing collection: ${t}`),this.oe(e,t,n).next(e=>{n-=e,r.add(t)});i=!1})).next(()=>t-n)}oe(e,t,r){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(n=>this.localStore.localDocuments.getNextDocuments(e,t,n,r).next(r=>{let i=r.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this._e(n,r)).next(r=>(T(eD,`Updating offset: ${r}`),this.localStore.indexManager.updateCollectionGroup(e,t,r))).next(()=>i.size)}))}_e(e,t){let r=e;return t.changes.forEach((e,t)=>{let n=eh(t);ed(n,r)>0&&(r=n)}),new ec(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}class eA{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ae(e),this.ue=e=>t.writeSequenceNumber(e))}ae(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.ue&&this.ue(e),e}}function eV(e){return null==e}function eR(e){return 0===e&&1/e==-1/0}function eM(e){return"number"==typeof e&&Number.isInteger(e)&&!eR(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function eO(e){let t="";for(let r=0;r<e.length;r++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let r=t,n=e.length;for(let t=0;t<n;t++){let n=e.charAt(t);switch(n){case"\0":r+="\x01\x10";break;case"\x01":r+="\x01\x11";break;default:r+=n}}return r}(e.get(r),t);return t+"\x01\x01"}eA.ce=-1;function eP(e){let t=e.length;if(N(t>=2,64408,{path:e}),2===t)return N("\x01"===e.charAt(0)&&"\x01"===e.charAt(1),56145,{path:e}),j.emptyPath();let r=t-2,n=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>r)&&S(50515,{path:e}),e.charAt(t+1)){case"\x01":let a;let o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),n.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:S(61167,{path:e})}s=t+2}return new j(n)}let eF="remoteDocuments",eL="owner",eU="owner",eq="mutationQueues",eB="mutations",ez="batchId",eK="userMutationsIndex",e$=["userId","batchId"],eG={},ej="documentMutations",eQ="remoteDocumentsV14",eW=["prefixPath","collectionGroup","readTime","documentId"],eH="documentKeyIndex",eJ=["prefixPath","collectionGroup","documentId"],eY="collectionGroupIndex",eX=["collectionGroup","readTime","prefixPath","documentId"],eZ="remoteDocumentGlobal",e0="remoteDocumentGlobalKey",e1="targets",e2="queryTargetsIndex",e5=["canonicalId","targetId"],e4="targetDocuments",e3=["targetId","path"],e6="documentTargetsIndex",e8=["path","targetId"],e9="targetGlobalKey",e7="targetGlobal",te="collectionParents",tt=["collectionId","parent"],tr="clientMetadata",tn="bundles",ti="namedQueries",ts="indexConfiguration",ta="collectionGroupIndex",to="indexState",tl=["indexId","uid"],tu="sequenceNumberIndex",th=["uid","sequenceNumber"],tc="indexEntries",td=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],tf="documentKeyIndex",tm=["indexId","uid","orderedDocumentKey"],tg="documentOverlays",tp=["userId","collectionPath","documentId"],ty="collectionPathOverlayIndex",tw=["userId","collectionPath","largestBatchId"],tv="collectionGroupOverlayIndex",tI=["userId","collectionGroup","largestBatchId"],tT="globals",tb=[eq,eB,ej,eF,e1,eL,e7,e4,tr,eZ,te,tn,ti],tE=[...tb,tg],t_=[eq,eB,ej,eQ,e1,eL,e7,e4,tr,eZ,te,tn,ti,tg],tS=[...t_,ts,to,tc],tx=[...tS,tT];class tN extends em{constructor(e,t){super(),this.le=e,this.currentSequenceNumber=t}}function tD(e,t){return ev.O(e.le,t)}function tC(e){let t=0;for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&t++;return t}function tk(e,t){for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&t(r,e[r])}function tA(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tV{constructor(e,t){this.comparator=e,this.root=t||tM.EMPTY}insert(e,t){return new tV(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,tM.BLACK,null,null))}remove(e){return new tV(this.comparator,this.root.remove(e,this.comparator).copy(null,null,tM.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let r=this.comparator(e,t.key);if(0===r)return t.value;r<0?t=t.left:r>0&&(t=t.right)}return null}indexOf(e){let t=0,r=this.root;for(;!r.isEmpty();){let n=this.comparator(e,r.key);if(0===n)return t+r.left.size;n<0?r=r.left:(t+=r.left.size+1,r=r.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,r)=>(e(t,r),!1))}toString(){let e=[];return this.inorderTraversal((t,r)=>(e.push(`${t}:${r}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new tR(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new tR(this.root,e,this.comparator,!1)}getReverseIterator(){return new tR(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new tR(this.root,e,this.comparator,!0)}}class tR{constructor(e,t,r,n){this.isReverse=n,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?r(e.key,t):1,t&&n&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class tM{constructor(e,t,r,n,i){this.key=e,this.value=t,this.color=null!=r?r:tM.RED,this.left=null!=n?n:tM.EMPTY,this.right=null!=i?i:tM.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,r,n,i){return new tM(null!=e?e:this.key,null!=t?t:this.value,null!=r?r:this.color,null!=n?n:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,r){let n=this,i=r(e,n.key);return(n=i<0?n.copy(null,null,null,n.left.insert(e,t,r),null):0===i?n.copy(null,t,null,null,null):n.copy(null,null,null,null,n.right.insert(e,t,r))).fixUp()}removeMin(){if(this.left.isEmpty())return tM.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let r,n=this;if(0>t(e,n.key))n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(e,t),null);else{if(n.left.isRed()&&(n=n.rotateRight()),n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight()),0===t(e,n.key)){if(n.right.isEmpty())return tM.EMPTY;r=n.right.min(),n=n.copy(r.key,r.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(e,t))}return n.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,tM.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,tM.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw S(43730,{key:this.key,value:this.value});if(this.right.isRed())throw S(14113,{key:this.key,value:this.value});let e=this.left.check();if(e!==this.right.check())throw S(27949);return e+ +!this.isRed()}}tM.EMPTY=null,tM.RED=!0,tM.BLACK=!1,tM.EMPTY=new class{constructor(){this.size=0}get key(){throw S(57766)}get value(){throw S(16141)}get color(){throw S(16727)}get left(){throw S(29726)}get right(){throw S(36894)}copy(e,t,r,n,i){return this}insert(e,t,r){return new tM(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tO{constructor(e){this.comparator=e,this.data=new tV(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,r)=>(e(t),!1))}forEachInRange(e,t){let r=this.data.getIteratorFrom(e[0]);for(;r.hasNext();){let n=r.getNext();if(this.comparator(n.key,e[1])>=0)return;t(n.key)}}forEachWhile(e,t){let r;for(r=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();r.hasNext();)if(!e(r.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tP(this.data.getIterator())}getIteratorFrom(e){return new tP(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof tO)||this.size!==e.size)return!1;let t=this.data.getIterator(),r=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,n=r.getNext().key;if(0!==this.comparator(e,n))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new tO(this.comparator);return t.data=e,t}}class tP{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function tF(e){return e.hasNext()?e.getNext():void 0}class tL{constructor(e){this.fields=e,e.sort(W.comparator)}static empty(){return new tL([])}unionWith(e){let t=new tO(W.comparator);for(let e of this.fields)t=t.add(e);for(let r of e)t=t.add(r);return new tL(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return K(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class tU extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class tq{constructor(e){this.binaryString=e}static fromBase64String(e){return new tq(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new tU("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new tq(function(e){let t="";for(let r=0;r<e.length;++r)t+=String.fromCharCode(e[r]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){return function(e){let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return q(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}tq.EMPTY_BYTE_STRING=new tq("");let tB=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function tz(e){if(N(!!e,39018),"string"==typeof e){let t=0,r=tB.exec(e);if(N(!!r,46558,{timestamp:e}),r[1]){let e=r[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:tK(e.seconds),nanos:tK(e.nanos)}}function tK(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function t$(e){return"string"==typeof e?tq.fromBase64String(e):tq.fromUint8Array(e)}let tG="server_timestamp",tj="__type__",tQ="__previous_value__",tW="__local_write_time__";function tH(e){return(e?.mapValue?.fields||{})[tj]?.stringValue===tG}function tJ(e){let t=e.mapValue.fields[tQ];return tH(t)?tJ(t):t}function tY(e){let t=tz(e.mapValue.fields[tW].timestampValue);return new er(t.seconds,t.nanos)}class tX{constructor(e,t,r,n,i,s,a,o,l,u){this.databaseId=e,this.appId=t,this.persistenceKey=r,this.host=n,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l,this.isUsingEmulator=u}}let tZ="(default)";class t0{constructor(e,t){this.projectId=e,this.database=t||tZ}static empty(){return new t0("","")}get isDefaultDatabase(){return this.database===tZ}isEqual(e){return e instanceof t0&&e.projectId===this.projectId&&e.database===this.database}}let t1="__type__",t2="__max__",t5={mapValue:{fields:{__type__:{stringValue:t2}}}},t4="__vector__",t3="value",t6={nullValue:"NULL_VALUE"};function t8(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?tH(e)?4:rd(e)?0x1fffffffffffff:rh(e)?10:11:S(28295,{value:e})}function t9(e,t){if(e===t)return!0;let r=t8(e);if(r!==t8(t))return!1;switch(r){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return tY(e).isEqual(tY(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let r=tz(e.timestampValue),n=tz(t.timestampValue);return r.seconds===n.seconds&&r.nanos===n.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return t$(e.bytesValue).isEqual(t$(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return tK(e.geoPointValue.latitude)===tK(t.geoPointValue.latitude)&&tK(e.geoPointValue.longitude)===tK(t.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return tK(e.integerValue)===tK(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let r=tK(e.doubleValue),n=tK(t.doubleValue);return r===n?eR(r)===eR(n):isNaN(r)&&isNaN(n)}return!1}(e,t);case 9:return K(e.arrayValue.values||[],t.arrayValue.values||[],t9);case 10:case 11:return function(e,t){let r=e.mapValue.fields||{},n=t.mapValue.fields||{};if(tC(r)!==tC(n))return!1;for(let e in r)if(r.hasOwnProperty(e)&&(void 0===n[e]||!t9(r[e],n[e])))return!1;return!0}(e,t);default:return S(52216,{left:e})}}function t7(e,t){return void 0!==(e.values||[]).find(e=>t9(e,t))}function re(e,t){if(e===t)return 0;let r=t8(e),n=t8(t);if(r!==n)return q(r,n);switch(r){case 0:case 0x1fffffffffffff:return 0;case 1:return q(e.booleanValue,t.booleanValue);case 2:return function(e,t){let r=tK(e.integerValue||e.doubleValue),n=tK(t.integerValue||t.doubleValue);return r<n?-1:r>n?1:r===n?0:isNaN(r)?isNaN(n)?0:-1:1}(e,t);case 3:return rt(e.timestampValue,t.timestampValue);case 4:return rt(tY(e),tY(t));case 5:return B(e.stringValue,t.stringValue);case 6:return function(e,t){let r=t$(e),n=t$(t);return r.compareTo(n)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let r=e.split("/"),n=t.split("/");for(let e=0;e<r.length&&e<n.length;e++){let t=q(r[e],n[e]);if(0!==t)return t}return q(r.length,n.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let r=q(tK(e.latitude),tK(t.latitude));return 0!==r?r:q(tK(e.longitude),tK(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return rr(e.arrayValue,t.arrayValue);case 10:return function(e,t){let r=e.fields||{},n=t.fields||{},i=r[t3]?.arrayValue,s=n[t3]?.arrayValue,a=q(i?.values?.length||0,s?.values?.length||0);return 0!==a?a:rr(i,s)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===t5.mapValue&&t===t5.mapValue)return 0;if(e===t5.mapValue)return 1;if(t===t5.mapValue)return -1;let r=e.fields||{},n=Object.keys(r),i=t.fields||{},s=Object.keys(i);n.sort(),s.sort();for(let e=0;e<n.length&&e<s.length;++e){let t=B(n[e],s[e]);if(0!==t)return t;let a=re(r[n[e]],i[s[e]]);if(0!==a)return a}return q(n.length,s.length)}(e.mapValue,t.mapValue);default:throw S(23264,{he:r})}}function rt(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return q(e,t);let r=tz(e),n=tz(t),i=q(r.seconds,n.seconds);return 0!==i?i:q(r.nanos,n.nanos)}function rr(e,t){let r=e.values||[],n=t.values||[];for(let e=0;e<r.length&&e<n.length;++e){let t=re(r[e],n[e]);if(t)return t}return q(r.length,n.length)}function rn(e){var t,r;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=tz(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?t$(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,H.fromName(t).toString()):"geoPointValue"in e?(r=e.geoPointValue,`geo(${r.latitude},${r.longitude})`):"arrayValue"in e?function(e){let t="[",r=!0;for(let n of e.values||[])r?r=!1:t+=",",t+=rn(n);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),r="{",n=!0;for(let i of t)n?n=!1:r+=",",r+=`${i}:${rn(e.fields[i])}`;return r+"}"}(e.mapValue):S(61005,{value:e})}function ri(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function rs(e){return!!e&&"integerValue"in e}function ra(e){return!!e&&"arrayValue"in e}function ro(e){return!!e&&"nullValue"in e}function rl(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function ru(e){return!!e&&"mapValue"in e}function rh(e){return(e?.mapValue?.fields||{})[t1]?.stringValue===t4}function rc(e){if(e.geoPointValue)return{geoPointValue:{...e.geoPointValue}};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:{...e.timestampValue}};if(e.mapValue){let t={mapValue:{fields:{}}};return tk(e.mapValue.fields,(e,r)=>t.mapValue.fields[e]=rc(r)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let r=0;r<(e.arrayValue.values||[]).length;++r)t.arrayValue.values[r]=rc(e.arrayValue.values[r]);return t}return{...e}}function rd(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===t2}let rf={mapValue:{fields:{[t1]:{stringValue:t4},[t3]:{arrayValue:{}}}}};function rm(e,t){let r=re(e.value,t.value);return 0!==r?r:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function rg(e,t){let r=re(e.value,t.value);return 0!==r?r:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class rp{constructor(e){this.value=e}static empty(){return new rp({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let r=0;r<e.length-1;++r)if(!ru(t=(t.mapValue.fields||{})[e.get(r)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=rc(t)}setAll(e){let t=W.emptyPath(),r={},n=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,r,n),r={},n=[],t=i.popLast()}e?r[i.lastSegment()]=rc(e):n.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,r,n)}delete(e){let t=this.field(e.popLast());ru(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return t9(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let r=0;r<e.length;++r){let n=t.mapValue.fields[e.get(r)];ru(n)&&n.mapValue.fields||(n={mapValue:{fields:{}}},t.mapValue.fields[e.get(r)]=n),t=n}return t.mapValue.fields}applyChanges(e,t,r){for(let n of(tk(t,(t,r)=>e[t]=r),r))delete e[n]}clone(){return new rp(rc(this.value))}}class ry{constructor(e,t,r,n,i,s,a){this.key=e,this.documentType=t,this.version=r,this.readTime=n,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new ry(e,0,en.min(),en.min(),en.min(),rp.empty(),0)}static newFoundDocument(e,t,r,n){return new ry(e,1,t,en.min(),r,n,0)}static newNoDocument(e,t){return new ry(e,2,t,en.min(),en.min(),rp.empty(),0)}static newUnknownDocument(e,t){return new ry(e,3,t,en.min(),en.min(),rp.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual(en.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=rp.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=rp.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=en.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof ry&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new ry(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class rw{constructor(e,t){this.position=e,this.inclusive=t}}function rv(e,t,r){let n=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(n=s.field.isKeyField()?H.comparator(H.fromName(a.referenceValue),r.key):re(a,r.data.field(s.field)),"desc"===s.dir&&(n*=-1),0!==n)break}return n}function rI(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let r=0;r<e.position.length;r++)if(!t9(e.position[r],t.position[r]))return!1;return!0}class rT{constructor(e,t="asc"){this.field=e,this.dir=t}}class rb{}class rE extends rb{constructor(e,t,r){super(),this.field=e,this.op=t,this.value=r}static create(e,t,r){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,r):new rk(e,t,r):"array-contains"===t?new rM(e,r):"in"===t?new rO(e,r):"not-in"===t?new rP(e,r):"array-contains-any"===t?new rF(e,r):new rE(e,t,r)}static createKeyFieldInFilter(e,t,r){return"in"===t?new rA(e,r):new rV(e,r)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&void 0===t.nullValue&&this.matchesComparison(re(t,this.value)):null!==t&&t8(this.value)===t8(t)&&this.matchesComparison(re(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return S(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class r_ extends rb{constructor(e,t){super(),this.filters=e,this.op=t,this.Pe=null}static create(e,t){return new r_(e,t)}matches(e){return rS(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.Pe||(this.Pe=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.Pe}getFilters(){return Object.assign([],this.filters)}}function rS(e){return"and"===e.op}function rx(e){return"or"===e.op}function rN(e){return rD(e)&&rS(e)}function rD(e){for(let t of e.filters)if(t instanceof r_)return!1;return!0}function rC(e,t){let r=e.filters.concat(t);return r_.create(r,e.op)}class rk extends rE{constructor(e,t,r){super(e,t,r),this.key=H.fromName(r.referenceValue)}matches(e){let t=H.comparator(e.key,this.key);return this.matchesComparison(t)}}class rA extends rE{constructor(e,t){super(e,"in",t),this.keys=rR("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class rV extends rE{constructor(e,t){super(e,"not-in",t),this.keys=rR("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function rR(e,t){return(t.arrayValue?.values||[]).map(e=>H.fromName(e.referenceValue))}class rM extends rE{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return ra(t)&&t7(t.arrayValue,this.value)}}class rO extends rE{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&t7(this.value.arrayValue,t)}}class rP extends rE{constructor(e,t){super(e,"not-in",t)}matches(e){if(t7(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&void 0===t.nullValue&&!t7(this.value.arrayValue,t)}}class rF extends rE{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!ra(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>t7(this.value.arrayValue,e))}}class rL{constructor(e,t=null,r=[],n=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=r,this.filters=n,this.limit=i,this.startAt=s,this.endAt=a,this.Te=null}}function rU(e,t=null,r=[],n=[],i=null,s=null,a=null){return new rL(e,t,r,n,i,s,a)}function rq(e){if(null===e.Te){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof rE)return t.field.canonicalString()+t.op.toString()+rn(t.value);if(rN(t))return t.filters.map(t=>e(t)).join(",");{let r=t.filters.map(t=>e(t)).join(",");return`${t.op}(${r})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),eV(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>rn(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>rn(e)).join(",")),e.Te=t}return e.Te}function rB(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var r,n;if(r=e.orderBy[i],n=t.orderBy[i],!(r.dir===n.dir&&r.field.isEqual(n.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let r=0;r<e.filters.length;r++)if(!function e(t,r){return t instanceof rE?r instanceof rE&&t.op===r.op&&t.field.isEqual(r.field)&&t9(t.value,r.value):t instanceof r_?r instanceof r_&&t.op===r.op&&t.filters.length===r.filters.length&&t.filters.reduce((t,n,i)=>t&&e(n,r.filters[i]),!0):void S(19439)}(e.filters[r],t.filters[r]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!rI(e.startAt,t.startAt)&&rI(e.endAt,t.endAt)}function rz(e){return H.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function rK(e,t){return e.filters.filter(e=>e instanceof rE&&e.field.isEqual(t))}function r$(e,t,r){let n=t6,i=!0;for(let r of rK(e,t)){let e=t6,t=!0;switch(r.op){case"<":case"<=":var s;e="nullValue"in(s=r.value)?t6:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?ri(t0.empty(),H.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?rh(s)?rf:{mapValue:{}}:S(35942,{value:s});break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=t6}0>rm({value:n,inclusive:i},{value:e,inclusive:t})&&(n=e,i=t)}if(null!==r){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=r.position[s];0>rm({value:n,inclusive:i},{value:e,inclusive:r.inclusive})&&(n=e,i=r.inclusive);break}}return{value:n,inclusive:i}}function rG(e,t,r){let n=t5,i=!0;for(let r of rK(e,t)){let e=t5,t=!0;switch(r.op){case">=":case">":var s;e="nullValue"in(s=r.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?ri(t0.empty(),H.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?rf:"mapValue"in s?rh(s)?{mapValue:{}}:t5:S(61959,{value:s}),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=t5}rg({value:n,inclusive:i},{value:e,inclusive:t})>0&&(n=e,i=t)}if(null!==r){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=r.position[s];rg({value:n,inclusive:i},{value:e,inclusive:r.inclusive})>0&&(n=e,i=r.inclusive);break}}return{value:n,inclusive:i}}class rj{constructor(e,t=null,r=[],n=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=r,this.filters=n,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.Ie=null,this.Ee=null,this.de=null,this.startAt,this.endAt}}function rQ(e){return new rj(e)}function rW(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function rH(e){return null!==e.collectionGroup}function rJ(e){if(null===e.Ie){let t;e.Ie=[];let r=new Set;for(let t of e.explicitOrderBy)e.Ie.push(t),r.add(t.field.canonicalString());let n=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new tO(W.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{r.has(t.canonicalString())||t.isKeyField()||e.Ie.push(new rT(t,n))}),r.has(W.keyField().canonicalString())||e.Ie.push(new rT(W.keyField(),n))}return e.Ie}function rY(e){return e.Ee||(e.Ee=rX(e,rJ(e))),e.Ee}function rX(e,t){if("F"===e.limitType)return rU(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new rT(e.field,t)});let r=e.endAt?new rw(e.endAt.position,e.endAt.inclusive):null,n=e.startAt?new rw(e.startAt.position,e.startAt.inclusive):null;return rU(e.path,e.collectionGroup,t,e.filters,e.limit,r,n)}}function rZ(e,t){let r=e.filters.concat([t]);return new rj(e.path,e.collectionGroup,e.explicitOrderBy.slice(),r,e.limit,e.limitType,e.startAt,e.endAt)}function r0(e,t,r){return new rj(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,r,e.startAt,e.endAt)}function r1(e,t){return rB(rY(e),rY(t))&&e.limitType===t.limitType}function r2(e){return`${rq(rY(e))}|lt:${e.limitType}`}function r5(e){var t;let r;return`Query(target=${r=(t=rY(e)).path.canonicalString(),null!==t.collectionGroup&&(r+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(r+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof rE?`${t.field.canonicalString()} ${t.op} ${rn(t.value)}`:t instanceof r_?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),eV(t.limit)||(r+=", limit: "+t.limit),t.orderBy.length>0&&(r+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(r+=", startAt: ",r+=t.startAt.inclusive?"b:":"a:",r+=t.startAt.position.map(e=>rn(e)).join(",")),t.endAt&&(r+=", endAt: ",r+=t.endAt.inclusive?"a:":"b:",r+=t.endAt.position.map(e=>rn(e)).join(",")),`Target(${r})`}; limitType=${e.limitType})`}function r4(e,t){return t.isFoundDocument()&&function(e,t){let r=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(r):H.isDocumentKey(e.path)?e.path.isEqual(r):e.path.isImmediateParentOf(r)}(e,t)&&function(e,t){for(let r of rJ(e))if(!r.field.isKeyField()&&null===t.data.field(r.field))return!1;return!0}(e,t)&&function(e,t){for(let r of e.filters)if(!r.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,r){let n=rv(e,t,r);return e.inclusive?n<=0:n<0}(e.startAt,rJ(e),t))&&(!e.endAt||!!function(e,t,r){let n=rv(e,t,r);return e.inclusive?n>=0:n>0}(e.endAt,rJ(e),t))}function r3(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function r6(e){return(t,r)=>{let n=!1;for(let i of rJ(e)){let e=function(e,t,r){let n=e.field.isKeyField()?H.comparator(t.key,r.key):function(e,t,r){let n=t.data.field(e),i=r.data.field(e);return null!==n&&null!==i?re(n,i):S(42886)}(e.field,t,r);switch(e.dir){case"asc":return n;case"desc":return -1*n;default:return S(19790,{direction:e.dir})}}(i,t,r);if(0!==e)return e;n=n||i.field.isKeyField()}return 0}}class r8{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),r=this.inner[t];if(void 0!==r){for(let[t,n]of r)if(this.equalsFn(t,e))return n}}has(e){return void 0!==this.get(e)}set(e,t){let r=this.mapKeyFn(e),n=this.inner[r];if(void 0===n)return this.inner[r]=[[e,t]],void this.innerSize++;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return void(n[r]=[e,t]);n.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),r=this.inner[t];if(void 0===r)return!1;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return 1===r.length?delete this.inner[t]:r.splice(n,1),this.innerSize--,!0;return!1}forEach(e){tk(this.inner,(t,r)=>{for(let[t,n]of r)e(t,n)})}isEmpty(){return tA(this.inner)}size(){return this.innerSize}}let r9=new tV(H.comparator),r7=new tV(H.comparator);function ne(...e){let t=r7;for(let r of e)t=t.insert(r.key,r);return t}function nt(e){let t=r7;return e.forEach((e,r)=>t=t.insert(e,r.overlayedDocument)),t}function nr(){return new r8(e=>e.toString(),(e,t)=>e.isEqual(t))}let nn=new tV(H.comparator),ni=new tO(H.comparator);function ns(...e){let t=ni;for(let r of e)t=t.add(r);return t}let na=new tO(q);function no(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:eR(t)?"-0":t}}function nl(e){return{integerValue:""+e}}function nu(e,t){return eM(t)?nl(t):no(e,t)}class nh{constructor(){this._=void 0}}function nc(e,t){return e instanceof ny?rs(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class nd extends nh{}class nf extends nh{constructor(e){super(),this.elements=e}}function nm(e,t){let r=nv(t);for(let t of e.elements)r.some(e=>t9(e,t))||r.push(t);return{arrayValue:{values:r}}}class ng extends nh{constructor(e){super(),this.elements=e}}function np(e,t){let r=nv(t);for(let t of e.elements)r=r.filter(e=>!t9(e,t));return{arrayValue:{values:r}}}class ny extends nh{constructor(e,t){super(),this.serializer=e,this.Ae=t}}function nw(e){return tK(e.integerValue||e.doubleValue)}function nv(e){return ra(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class nI{constructor(e,t){this.field=e,this.transform=t}}class nT{constructor(e,t){this.version=e,this.transformResults=t}}class nb{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new nb}static exists(e){return new nb(void 0,e)}static updateTime(e){return new nb(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function nE(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class n_{}function nS(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new nR(e.key,nb.none()):new nD(e.key,e.data,nb.none());{let r=e.data,n=rp.empty(),i=new tO(W.comparator);for(let e of t.fields)if(!i.has(e)){let t=r.field(e);null===t&&e.length>1&&(e=e.popLast(),t=r.field(e)),null===t?n.delete(e):n.set(e,t),i=i.add(e)}return new nC(e.key,n,new tL(i.toArray()),nb.none())}}function nx(e,t,r,n){return e instanceof nD?function(e,t,r,n){if(!nE(e.precondition,t))return r;let i=e.value.clone(),s=nV(e.fieldTransforms,n,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,r,n):e instanceof nC?function(e,t,r,n){if(!nE(e.precondition,t))return r;let i=nV(e.fieldTransforms,n,t),s=t.data;return(s.setAll(nk(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===r)?null:r.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,r,n):nE(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):r}function nN(e,t){var r,n;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(r=e.fieldTransforms,n=t.fieldTransforms,!!(void 0===r&&void 0===n||!(!r||!n)&&K(r,n,(e,t)=>{var r,n;return e.field.isEqual(t.field)&&(r=e.transform,n=t.transform,r instanceof nf&&n instanceof nf||r instanceof ng&&n instanceof ng?K(r.elements,n.elements,t9):r instanceof ny&&n instanceof ny?t9(r.Ae,n.Ae):r instanceof nd&&n instanceof nd)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class nD extends n_{constructor(e,t,r,n=[]){super(),this.key=e,this.value=t,this.precondition=r,this.fieldTransforms=n,this.type=0}getFieldMask(){return null}}class nC extends n_{constructor(e,t,r,n,i=[]){super(),this.key=e,this.data=t,this.fieldMask=r,this.precondition=n,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function nk(e){let t=new Map;return e.fieldMask.fields.forEach(r=>{if(!r.isEmpty()){let n=e.data.field(r);t.set(r,n)}}),t}function nA(e,t,r){let n=new Map;N(e.length===r.length,32656,{Re:r.length,Ve:e.length});for(let s=0;s<r.length;s++){var i;let a=e[s],o=a.transform,l=t.data.field(a.field);n.set(a.field,(i=r[s],o instanceof nf?nm(o,l):o instanceof ng?np(o,l):i))}return n}function nV(e,t,r){let n=new Map;for(let i of e){let e=i.transform,s=r.data.field(i.field);n.set(i.field,e instanceof nd?function(e,t){let r={fields:{[tj]:{stringValue:tG},[tW]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&tH(t)&&(t=tJ(t)),t&&(r.fields[tQ]=t),{mapValue:r}}(t,s):e instanceof nf?nm(e,s):e instanceof ng?np(e,s):function(e,t){let r=nc(e,t),n=nw(r)+nw(e.Ae);return rs(r)&&rs(e.Ae)?nl(n):no(e.serializer,n)}(e,s))}return n}class nR extends n_{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class nM extends n_{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class nO{constructor(e,t,r,n){this.batchId=e,this.localWriteTime=t,this.baseMutations=r,this.mutations=n}applyToRemoteDocument(e,t){let r=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let i=this.mutations[t];if(i.key.isEqual(e.key)){var n;n=r[t],i instanceof nD?function(e,t,r){let n=e.value.clone(),i=nA(e.fieldTransforms,t,r.transformResults);n.setAll(i),t.convertToFoundDocument(r.version,n).setHasCommittedMutations()}(i,e,n):i instanceof nC?function(e,t,r){if(!nE(e.precondition,t))return void t.convertToUnknownDocument(r.version);let n=nA(e.fieldTransforms,t,r.transformResults),i=t.data;i.setAll(nk(e)),i.setAll(n),t.convertToFoundDocument(r.version,i).setHasCommittedMutations()}(i,e,n):function(e,t,r){t.convertToNoDocument(r.version).setHasCommittedMutations()}(0,e,n)}}}applyToLocalView(e,t){for(let r of this.baseMutations)r.key.isEqual(e.key)&&(t=nx(r,e,t,this.localWriteTime));for(let r of this.mutations)r.key.isEqual(e.key)&&(t=nx(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let r=nr();return this.mutations.forEach(n=>{let i=e.get(n.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=nS(s,a=t.has(n.key)?null:a);null!==o&&r.set(n.key,o),s.isValidDocument()||s.convertToNoDocument(en.min())}),r}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),ns())}isEqual(e){return this.batchId===e.batchId&&K(this.mutations,e.mutations,(e,t)=>nN(e,t))&&K(this.baseMutations,e.baseMutations,(e,t)=>nN(e,t))}}class nP{constructor(e,t,r,n){this.batch=e,this.commitVersion=t,this.mutationResults=r,this.docVersions=n}static from(e,t,r){N(e.mutations.length===r.length,58842,{me:e.mutations.length,fe:r.length});let n=nn,i=e.mutations;for(let e=0;e<i.length;e++)n=n.insert(i[e].key,r[e].version);return new nP(e,t,r,n)}}class nF{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class nL{constructor(e,t){this.count=e,this.unchangedNames=t}}function nU(e){switch(e){case D.OK:return S(64938);case D.CANCELLED:case D.UNKNOWN:case D.DEADLINE_EXCEEDED:case D.RESOURCE_EXHAUSTED:case D.INTERNAL:case D.UNAVAILABLE:case D.UNAUTHENTICATED:return!1;case D.INVALID_ARGUMENT:case D.NOT_FOUND:case D.ALREADY_EXISTS:case D.PERMISSION_DENIED:case D.FAILED_PRECONDITION:case D.ABORTED:case D.OUT_OF_RANGE:case D.UNIMPLEMENTED:case D.DATA_LOSS:return!0;default:return S(15467,{code:e})}}function nq(e){if(void 0===e)return b("GRPC error has no .code"),D.UNKNOWN;switch(e){case n.OK:return D.OK;case n.CANCELLED:return D.CANCELLED;case n.UNKNOWN:return D.UNKNOWN;case n.DEADLINE_EXCEEDED:return D.DEADLINE_EXCEEDED;case n.RESOURCE_EXHAUSTED:return D.RESOURCE_EXHAUSTED;case n.INTERNAL:return D.INTERNAL;case n.UNAVAILABLE:return D.UNAVAILABLE;case n.UNAUTHENTICATED:return D.UNAUTHENTICATED;case n.INVALID_ARGUMENT:return D.INVALID_ARGUMENT;case n.NOT_FOUND:return D.NOT_FOUND;case n.ALREADY_EXISTS:return D.ALREADY_EXISTS;case n.PERMISSION_DENIED:return D.PERMISSION_DENIED;case n.FAILED_PRECONDITION:return D.FAILED_PRECONDITION;case n.ABORTED:return D.ABORTED;case n.OUT_OF_RANGE:return D.OUT_OF_RANGE;case n.UNIMPLEMENTED:return D.UNIMPLEMENTED;case n.DATA_LOSS:return D.DATA_LOSS;default:return S(39323,{code:e})}}function nB(){return new TextEncoder}(i=n||(n={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let nz=new c.jz([0xffffffff,0xffffffff],0);function nK(e){let t=nB().encode(e),r=new c.VV;return r.update(t),new Uint8Array(r.digest())}function n$(e){let t=new DataView(e.buffer),r=t.getUint32(0,!0),n=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new c.jz([r,n],0),new c.jz([i,s],0)]}class nG{constructor(e,t,r){if(this.bitmap=e,this.padding=t,this.hashCount=r,t<0||t>=8)throw new nj(`Invalid padding: ${t}`);if(r<0||e.length>0&&0===this.hashCount)throw new nj(`Invalid hash count: ${r}`);if(0===e.length&&0!==t)throw new nj(`Invalid padding when bitmap length is 0: ${t}`);this.ge=8*e.length-t,this.pe=c.jz.fromNumber(this.ge)}ye(e,t,r){let n=e.add(t.multiply(c.jz.fromNumber(r)));return 1===n.compare(nz)&&(n=new c.jz([n.getBits(0),n.getBits(1)],0)),n.modulo(this.pe).toNumber()}we(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.ge)return!1;let[t,r]=n$(nK(e));for(let e=0;e<this.hashCount;e++){let n=this.ye(t,r,e);if(!this.we(n))return!1}return!0}static create(e,t,r){let n=new nG(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return r.forEach(e=>n.insert(e)),n}insert(e){if(0===this.ge)return;let[t,r]=n$(nK(e));for(let e=0;e<this.hashCount;e++){let n=this.ye(t,r,e);this.Se(n)}}Se(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class nj extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class nQ{constructor(e,t,r,n,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=r,this.documentUpdates=n,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,r){let n=new Map;return n.set(e,nW.createSynthesizedTargetChangeForCurrentChange(e,t,r)),new nQ(en.min(),n,new tV(q),r9,ns())}}class nW{constructor(e,t,r,n,i){this.resumeToken=e,this.current=t,this.addedDocuments=r,this.modifiedDocuments=n,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,r){return new nW(r,t,ns(),ns(),ns())}}class nH{constructor(e,t,r,n){this.be=e,this.removedTargetIds=t,this.key=r,this.De=n}}class nJ{constructor(e,t){this.targetId=e,this.Ce=t}}class nY{constructor(e,t,r=tq.EMPTY_BYTE_STRING,n=null){this.state=e,this.targetIds=t,this.resumeToken=r,this.cause=n}}class nX{constructor(){this.ve=0,this.Fe=n1(),this.Me=tq.EMPTY_BYTE_STRING,this.xe=!1,this.Oe=!0}get current(){return this.xe}get resumeToken(){return this.Me}get Ne(){return 0!==this.ve}get Be(){return this.Oe}Le(e){e.approximateByteSize()>0&&(this.Oe=!0,this.Me=e)}ke(){let e=ns(),t=ns(),r=ns();return this.Fe.forEach((n,i)=>{switch(i){case 0:e=e.add(n);break;case 2:t=t.add(n);break;case 1:r=r.add(n);break;default:S(38017,{changeType:i})}}),new nW(this.Me,this.xe,e,t,r)}qe(){this.Oe=!1,this.Fe=n1()}Qe(e,t){this.Oe=!0,this.Fe=this.Fe.insert(e,t)}$e(e){this.Oe=!0,this.Fe=this.Fe.remove(e)}Ue(){this.ve+=1}Ke(){this.ve-=1,N(this.ve>=0,3241,{ve:this.ve})}We(){this.Oe=!0,this.xe=!0}}class nZ{constructor(e){this.Ge=e,this.ze=new Map,this.je=r9,this.Je=n0(),this.He=n0(),this.Ye=new tV(q)}Ze(e){for(let t of e.be)e.De&&e.De.isFoundDocument()?this.Xe(t,e.De):this.et(t,e.key,e.De);for(let t of e.removedTargetIds)this.et(t,e.key,e.De)}tt(e){this.forEachTarget(e,t=>{let r=this.nt(t);switch(e.state){case 0:this.rt(t)&&r.Le(e.resumeToken);break;case 1:r.Ke(),r.Ne||r.qe(),r.Le(e.resumeToken);break;case 2:r.Ke(),r.Ne||this.removeTarget(t);break;case 3:this.rt(t)&&(r.We(),r.Le(e.resumeToken));break;case 4:this.rt(t)&&(this.it(t),r.Le(e.resumeToken));break;default:S(56790,{state:e.state})}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.ze.forEach((e,r)=>{this.rt(r)&&t(r)})}st(e){let t=e.targetId,r=e.Ce.count,n=this.ot(t);if(n){let i=n.target;if(rz(i)){if(0===r){let e=new H(i.path);this.et(t,e,ry.newNoDocument(e,en.min()))}else N(1===r,20013,{expectedCount:r})}else{let n=this._t(t);if(n!==r){let r=this.ut(e),i=r?this.ct(r,e,n):1;0!==i&&(this.it(t),this.Ye=this.Ye.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch"))}}}}ut(e){let t,r;let n=e.Ce.unchangedNames;if(!n||!n.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=n;try{t=t$(i).toUint8Array()}catch(e){if(e instanceof tU)return E("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{r=new nG(t,s,a)}catch(e){return E(e instanceof nj?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===r.ge?null:r}ct(e,t,r){return 2*(t.Ce.count!==r-this.Pt(e,t.targetId))}Pt(e,t){let r=this.Ge.getRemoteKeysForTarget(t),n=0;return r.forEach(r=>{let i=this.Ge.ht(),s=`projects/${i.projectId}/databases/${i.database}/documents/${r.path.canonicalString()}`;e.mightContain(s)||(this.et(t,r,null),n++)}),n}Tt(e){let t=new Map;this.ze.forEach((r,n)=>{let i=this.ot(n);if(i){if(r.current&&rz(i.target)){let t=new H(i.target.path);this.It(t).has(n)||this.Et(n,t)||this.et(n,t,ry.newNoDocument(t,e))}r.Be&&(t.set(n,r.ke()),r.qe())}});let r=ns();this.He.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{let t=this.ot(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(n=!1,!1)}),n&&(r=r.add(e))}),this.je.forEach((t,r)=>r.setReadTime(e));let n=new nQ(e,t,this.Ye,this.je,r);return this.je=r9,this.Je=n0(),this.He=n0(),this.Ye=new tV(q),n}Xe(e,t){if(!this.rt(e))return;let r=2*!!this.Et(e,t.key);this.nt(e).Qe(t.key,r),this.je=this.je.insert(t.key,t),this.Je=this.Je.insert(t.key,this.It(t.key).add(e)),this.He=this.He.insert(t.key,this.dt(t.key).add(e))}et(e,t,r){if(!this.rt(e))return;let n=this.nt(e);this.Et(e,t)?n.Qe(t,1):n.$e(t),this.He=this.He.insert(t,this.dt(t).delete(e)),this.He=this.He.insert(t,this.dt(t).add(e)),r&&(this.je=this.je.insert(t,r))}removeTarget(e){this.ze.delete(e)}_t(e){let t=this.nt(e).ke();return this.Ge.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ue(e){this.nt(e).Ue()}nt(e){let t=this.ze.get(e);return t||(t=new nX,this.ze.set(e,t)),t}dt(e){let t=this.He.get(e);return t||(t=new tO(q),this.He=this.He.insert(e,t)),t}It(e){let t=this.Je.get(e);return t||(t=new tO(q),this.Je=this.Je.insert(e,t)),t}rt(e){let t=null!==this.ot(e);return t||T("WatchChangeAggregator","Detected inactive target",e),t}ot(e){let t=this.ze.get(e);return t&&t.Ne?null:this.Ge.At(e)}it(e){this.ze.set(e,new nX),this.Ge.getRemoteKeysForTarget(e).forEach(t=>{this.et(e,t,null)})}Et(e,t){return this.Ge.getRemoteKeysForTarget(e).has(t)}}function n0(){return new tV(H.comparator)}function n1(){return new tV(H.comparator)}let n2={asc:"ASCENDING",desc:"DESCENDING"},n5={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},n4={and:"AND",or:"OR"};class n3{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function n6(e,t){return e.useProto3Json||eV(t)?t:{value:t}}function n8(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function n9(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function n7(e){return N(!!e,49232),en.fromTimestamp(function(e){let t=tz(e);return new er(t.seconds,t.nanos)}(e))}function ie(e,t){return it(e,t).canonicalString()}function it(e,t){let r=new j(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?r:r.child(t)}function ir(e){let t=j.fromString(e);return N(iI(t),10190,{key:t.toString()}),t}function ii(e,t){return ie(e.databaseId,t.path)}function is(e,t){let r=ir(t);if(r.get(1)!==e.databaseId.projectId)throw new C(D.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+r.get(1)+" vs "+e.databaseId.projectId);if(r.get(3)!==e.databaseId.database)throw new C(D.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+r.get(3)+" vs "+e.databaseId.database);return new H(iu(r))}function ia(e,t){return ie(e.databaseId,t)}function io(e){let t=ir(e);return 4===t.length?j.emptyPath():iu(t)}function il(e){return new j(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function iu(e){return N(e.length>4&&"documents"===e.get(4),29091,{key:e.toString()}),e.popFirst(5)}function ih(e,t,r){return{name:ii(e,t),fields:r.value.mapValue.fields}}function ic(e,t,r){let n=is(e,t.name),i=n7(t.updateTime),s=t.createTime?n7(t.createTime):en.min(),a=new rp({mapValue:{fields:t.fields}}),o=ry.newFoundDocument(n,i,s,a);return r&&o.setHasCommittedMutations(),r?o.setHasCommittedMutations():o}function id(e,t){var r;let n;if(t instanceof nD)n={update:ih(e,t.key,t.value)};else if(t instanceof nR)n={delete:ii(e,t.key)};else if(t instanceof nC)n={update:ih(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof nM))return S(16599,{Vt:t.type});n={verify:ii(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let r=t.transform;if(r instanceof nd)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(r instanceof nf)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:r.elements}};if(r instanceof ng)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:r.elements}};if(r instanceof ny)return{fieldPath:t.field.canonicalString(),increment:r.Ae};throw S(20930,{transform:t.transform})})(0,e))),t.precondition.isNone||(n.currentDocument=void 0!==(r=t.precondition).updateTime?{updateTime:n8(e,r.updateTime.toTimestamp())}:void 0!==r.exists?{exists:r.exists}:S(27497)),n}function im(e,t){var r;let n=t.currentDocument?void 0!==(r=t.currentDocument).updateTime?nb.updateTime(n7(r.updateTime)):void 0!==r.exists?nb.exists(r.exists):nb.none():nb.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{let r;return r=null,"setToServerValue"in t?(N("REQUEST_TIME"===t.setToServerValue,16630,{proto:t}),r=new nd):"appendMissingElements"in t?r=new nf(t.appendMissingElements.values||[]):"removeAllFromArray"in t?r=new ng(t.removeAllFromArray.values||[]):"increment"in t?r=new ny(e,t.increment):S(16584,{proto:t}),new nI(W.fromServerFormat(t.fieldPath),r)}):[];if(t.update){t.update.name;let r=is(e,t.update.name),s=new rp({mapValue:{fields:t.update.fields}});return t.updateMask?new nC(r,s,new tL((t.updateMask.fieldPaths||[]).map(e=>W.fromServerFormat(e))),n,i):new nD(r,s,n,i)}return t.delete?new nR(is(e,t.delete),n):t.verify?new nM(is(e,t.verify),n):S(1463,{proto:t})}function ig(e,t){return{documents:[ia(e,t.path)]}}function ip(e,t){var r,n;let i;let s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=ia(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof rE?function(e){if("=="===e.op){if(rl(e.value))return{unaryFilter:{field:iw(e.field),op:"IS_NAN"}};if(ro(e.value))return{unaryFilter:{field:iw(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(rl(e.value))return{unaryFilter:{field:iw(e.field),op:"IS_NOT_NAN"}};if(ro(e.value))return{unaryFilter:{field:iw(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:iw(e.field),op:n5[e.op],value:e.value}}}(t):t instanceof r_?function(t){let r=t.getFilters().map(t=>e(t));return 1===r.length?r[0]:{compositeFilter:{op:n4[t.op],filters:r}}}(t):S(54877,{filter:t})}(r_.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:iw(e.field),direction:n2[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=n6(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(r=t.startAt).inclusive,values:r.position}),t.endAt&&(s.structuredQuery.endAt={before:!(n=t.endAt).inclusive,values:n.position}),{ft:s,parent:i}}function iy(e){var t;let r,n=io(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){N(1===s,65062);let e=i.from[0];e.allDescendants?a=e.collectionId:n=n.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=iv(e.unaryFilter.field);return rE.create(t,"==",{doubleValue:NaN});case"IS_NULL":let r=iv(e.unaryFilter.field);return rE.create(r,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let n=iv(e.unaryFilter.field);return rE.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=iv(e.unaryFilter.field);return rE.create(i,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return S(61313);default:return S(60726)}}(t):void 0!==t.fieldFilter?rE.create(iv(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return S(58110);default:return S(50506)}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?r_.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return S(1026)}}(t.compositeFilter.op)):S(30097,{filter:t})}(e);return t instanceof r_&&rN(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new rT(iv(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=eV(r="object"==typeof(t=i.limit)?t.value:t)?null:r);let h=null;i.startAt&&(h=function(e){let t=!!e.before;return new rw(e.values||[],t)}(i.startAt));let c=null;return i.endAt&&(c=function(e){let t=!e.before;return new rw(e.values||[],t)}(i.endAt)),new rj(n,a,l,o,u,"F",h,c)}function iw(e){return{fieldPath:e.canonicalString()}}function iv(e){return W.fromServerFormat(e.fieldPath)}function iI(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class iT{constructor(e,t,r,n,i=en.min(),s=en.min(),a=tq.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=r,this.sequenceNumber=n,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new iT(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new iT(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new iT(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new iT(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class ib{constructor(e){this.yt=e}}function iE(e,t){let r=t.key,n={prefixPath:r.getCollectionPath().popLast().toArray(),collectionGroup:r.collectionGroup,documentId:r.path.lastSegment(),readTime:i_(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;n.document={name:ii(i=e.yt,t.key),fields:t.data.value.mapValue.fields,updateTime:n8(i,t.version.toTimestamp()),createTime:n8(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())n.noDocument={path:r.path.toArray(),readTime:iS(t.version)};else{if(!t.isUnknownDocument())return S(57904,{document:t});n.unknownDocument={path:r.path.toArray(),version:iS(t.version)}}return n}function i_(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function iS(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function ix(e){let t=new er(e.seconds,e.nanoseconds);return en.fromTimestamp(t)}function iN(e,t){let r=(t.baseMutations||[]).map(t=>im(e.yt,t));for(let e=0;e<t.mutations.length-1;++e){let r=t.mutations[e];e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform&&(r.updateTransforms=t.mutations[e+1].transform.fieldTransforms,t.mutations.splice(e+1,1),++e)}let n=t.mutations.map(t=>im(e.yt,t)),i=er.fromMillis(t.localWriteTimeMs);return new nO(t.batchId,i,r,n)}function iD(e){let t=ix(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?ix(e.lastLimboFreeSnapshotVersion):en.min();return new iT(void 0!==e.query.documents?function(e){let t=e.documents.length;return N(1===t,1966,{count:t}),rY(rQ(io(e.documents[0])))}(e.query):rY(iy(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,r,tq.fromBase64String(e.resumeToken))}function iC(e,t){let r;let n=iS(t.snapshotVersion),i=iS(t.lastLimboFreeSnapshotVersion);r=rz(t.target)?ig(e.yt,t.target):ip(e.yt,t.target).ft;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:rq(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:r}}function ik(e){let t=iy({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?r0(t,t.limit,"L"):t}function iA(e,t){return new nF(t.largestBatchId,im(e.yt,t.overlayMutation))}function iV(e,t){let r=t.path.lastSegment();return[e,eO(t.path.popLast()),r]}function iR(e,t,r,n){return{indexId:e,uid:t,sequenceNumber:r,readTime:iS(n.readTime),documentKey:eO(n.documentKey.path),largestBatchId:n.largestBatchId}}class iM{getBundleMetadata(e,t){return tD(e,tn).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:ix(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return tD(e,tn).put({bundleId:t.id,createTime:iS(n7(t.createTime)),version:t.version})}getNamedQuery(e,t){return tD(e,ti).get(t).next(e=>{if(e)return{name:e.name,query:ik(e.bundledQuery),readTime:ix(e.readTime)}})}saveNamedQuery(e,t){return tD(e,ti).put({name:t.name,readTime:iS(n7(t.readTime)),bundledQuery:t.bundledQuery})}}class iO{constructor(e,t){this.serializer=e,this.userId=t}static wt(e,t){return new iO(e,t.uid||"")}getOverlay(e,t){return tD(e,tg).get(iV(this.userId,t)).next(e=>e?iA(this.serializer,e):null)}getOverlays(e,t){let r=nr();return ep.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&r.set(t,e)})).next(()=>r)}saveOverlays(e,t,r){let n=[];return r.forEach((r,i)=>{let s=new nF(t,i);n.push(this.St(e,s))}),ep.waitFor(n)}removeOverlaysForBatchId(e,t,r){let n=new Set;t.forEach(e=>n.add(eO(e.getCollectionPath())));let i=[];return n.forEach(t=>{let n=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,r+1],!1,!0);i.push(tD(e,tg).Z(ty,n))}),ep.waitFor(i)}getOverlaysForCollection(e,t,r){let n=nr(),i=eO(t),s=IDBKeyRange.bound([this.userId,i,r],[this.userId,i,Number.POSITIVE_INFINITY],!0);return tD(e,tg).J(ty,s).next(e=>{for(let t of e){let e=iA(this.serializer,t);n.set(e.getKey(),e)}return n})}getOverlaysForCollectionGroup(e,t,r,n){let i;let s=nr(),a=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,Number.POSITIVE_INFINITY],!0);return tD(e,tg).ee({index:tv,range:a},(e,t,r)=>{let a=iA(this.serializer,t);s.size()<n||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):r.done()}).next(()=>s)}St(e,t){return tD(e,tg).put(function(e,t,r){let[n,i,s]=iV(t,r.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:r.mutation.key.getCollectionGroup(),largestBatchId:r.largestBatchId,overlayMutation:id(e.yt,r.mutation)}}(this.serializer,this.userId,t))}}class iP{bt(e){return tD(e,tT)}getSessionToken(e){return this.bt(e).get("sessionToken").next(e=>{let t=e?.value;return t?tq.fromUint8Array(t):tq.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.bt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class iF{constructor(){}Dt(e,t){this.Ct(e,t),t.vt()}Ct(e,t){if("nullValue"in e)this.Ft(t,5);else if("booleanValue"in e)this.Ft(t,10),t.Mt(+!!e.booleanValue);else if("integerValue"in e)this.Ft(t,15),t.Mt(tK(e.integerValue));else if("doubleValue"in e){let r=tK(e.doubleValue);isNaN(r)?this.Ft(t,13):(this.Ft(t,15),eR(r)?t.Mt(0):t.Mt(r))}else if("timestampValue"in e){let r=e.timestampValue;this.Ft(t,20),"string"==typeof r&&(r=tz(r)),t.xt(`${r.seconds||""}`),t.Mt(r.nanos||0)}else if("stringValue"in e)this.Ot(e.stringValue,t),this.Nt(t);else if("bytesValue"in e)this.Ft(t,30),t.Bt(t$(e.bytesValue)),this.Nt(t);else if("referenceValue"in e)this.Lt(e.referenceValue,t);else if("geoPointValue"in e){let r=e.geoPointValue;this.Ft(t,45),t.Mt(r.latitude||0),t.Mt(r.longitude||0)}else"mapValue"in e?rd(e)?this.Ft(t,Number.MAX_SAFE_INTEGER):rh(e)?this.kt(e.mapValue,t):(this.qt(e.mapValue,t),this.Nt(t)):"arrayValue"in e?(this.Qt(e.arrayValue,t),this.Nt(t)):S(19022,{$t:e})}Ot(e,t){this.Ft(t,25),this.Ut(e,t)}Ut(e,t){t.xt(e)}qt(e,t){let r=e.fields||{};for(let e of(this.Ft(t,55),Object.keys(r)))this.Ot(e,t),this.Ct(r[e],t)}kt(e,t){let r=e.fields||{};this.Ft(t,53);let n=r[t3].arrayValue?.values?.length||0;this.Ft(t,15),t.Mt(tK(n)),this.Ot(t3,t),this.Ct(r[t3],t)}Qt(e,t){let r=e.values||[];for(let e of(this.Ft(t,50),r))this.Ct(e,t)}Lt(e,t){this.Ft(t,37),H.fromName(e).path.forEach(e=>{this.Ft(t,60),this.Ut(e,t)})}Ft(e,t){e.Mt(t)}Nt(e){e.Mt(2)}}function iL(e){return Math.ceil((64-function(e){let t=0;for(let r=0;r<8;++r){let n=function(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e))/8)}iF.Kt=new iF;class iU{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Wt(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Gt(r.value),r=t.next();this.zt()}jt(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Jt(r.value),r=t.next();this.Ht()}Yt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Gt(e);else if(e<2048)this.Gt(960|e>>>6),this.Gt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Gt(480|e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e);else{let e=t.codePointAt(0);this.Gt(240|e>>>18),this.Gt(128|63&e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e)}}this.zt()}Zt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Jt(e);else if(e<2048)this.Jt(960|e>>>6),this.Jt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Jt(480|e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e);else{let e=t.codePointAt(0);this.Jt(240|e>>>18),this.Jt(128|63&e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e)}}this.Ht()}Xt(e){let t=this.en(e),r=iL(t);this.tn(1+r),this.buffer[this.position++]=255&r;for(let e=t.length-r;e<t.length;++e)this.buffer[this.position++]=255&t[e]}nn(e){let t=this.en(e),r=iL(t);this.tn(1+r),this.buffer[this.position++]=~(255&r);for(let e=t.length-r;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}rn(){this.sn(255),this.sn(255)}_n(){this.an(255),this.an(255)}reset(){this.position=0}seed(e){this.tn(e.length),this.buffer.set(e,this.position),this.position+=e.length}un(){return this.buffer.slice(0,this.position)}en(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),r=!!(128&t[0]);t[0]^=r?255:128;for(let e=1;e<t.length;++e)t[e]^=255*!!r;return t}Gt(e){let t=255&e;0===t?(this.sn(0),this.sn(255)):255===t?(this.sn(255),this.sn(0)):this.sn(t)}Jt(e){let t=255&e;0===t?(this.an(0),this.an(255)):255===t?(this.an(255),this.an(0)):this.an(e)}zt(){this.sn(0),this.sn(1)}Ht(){this.an(0),this.an(1)}sn(e){this.tn(1),this.buffer[this.position++]=e}an(e){this.tn(1),this.buffer[this.position++]=~e}tn(e){let t=e+this.position;if(t<=this.buffer.length)return;let r=2*this.buffer.length;r<t&&(r=t);let n=new Uint8Array(r);n.set(this.buffer),this.buffer=n}}class iq{constructor(e){this.cn=e}Bt(e){this.cn.Wt(e)}xt(e){this.cn.Yt(e)}Mt(e){this.cn.Xt(e)}vt(){this.cn.rn()}}class iB{constructor(e){this.cn=e}Bt(e){this.cn.jt(e)}xt(e){this.cn.Zt(e)}Mt(e){this.cn.nn(e)}vt(){this.cn._n()}}class iz{constructor(){this.cn=new iU,this.ln=new iq(this.cn),this.hn=new iB(this.cn)}seed(e){this.cn.seed(e)}Pn(e){return 0===e?this.ln:this.hn}un(){return this.cn.un()}reset(){this.cn.reset()}}class iK{constructor(e,t,r,n){this.Tn=e,this.In=t,this.En=r,this.dn=n}An(){let e=this.dn.length,t=0===e||255===this.dn[e-1]?e+1:e,r=new Uint8Array(t);return r.set(this.dn,0),t!==e?r.set([0],this.dn.length):++r[r.length-1],new iK(this.Tn,this.In,this.En,r)}Rn(e,t,r){return{indexId:this.Tn,uid:e,arrayValue:ij(this.En),directionalValue:ij(this.dn),orderedDocumentKey:ij(t),documentKey:r.path.toArray()}}Vn(e,t,r){let n=this.Rn(e,t,r);return[n.indexId,n.uid,n.arrayValue,n.directionalValue,n.orderedDocumentKey,n.documentKey]}}function i$(e,t){let r=e.Tn-t.Tn;return 0!==r?r:0!==(r=iG(e.En,t.En))?r:0!==(r=iG(e.dn,t.dn))?r:H.comparator(e.In,t.In)}function iG(e,t){for(let r=0;r<e.length&&r<t.length;++r){let n=e[r]-t[r];if(0!==n)return n}return e.length-t.length}function ij(e){return(0,h.Ov)()?function(e){let t="";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}(e):e}function iQ(e){return"string"!=typeof e?e:function(e){let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}(e)}class iW{constructor(e){for(let t of(this.mn=new tO((e,t)=>W.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.fn=e.orderBy,this.gn=[],e.filters))t.isInequality()?this.mn=this.mn.add(t):this.gn.push(t)}get pn(){return this.mn.size>1}yn(e){if(N(e.collectionGroup===this.collectionId,49279),this.pn)return!1;let t=es(e);if(void 0!==t&&!this.wn(t))return!1;let r=ea(e),n=new Set,i=0,s=0;for(;i<r.length&&this.wn(r[i]);++i)n=n.add(r[i].fieldPath.canonicalString());if(i===r.length)return!0;if(this.mn.size>0){let e=this.mn.getIterator().getNext();if(!n.has(e.field.canonicalString())){let t=r[i];if(!this.Sn(e,t)||!this.bn(this.fn[s++],t))return!1}++i}for(;i<r.length;++i){let e=r[i];if(s>=this.fn.length||!this.bn(this.fn[s++],e))return!1}return!0}Dn(){if(this.pn)return null;let e=new tO(W.comparator),t=[];for(let r of this.gn)if(!r.field.isKeyField()){if("array-contains"===r.op||"array-contains-any"===r.op)t.push(new eo(r.field,2));else{if(e.has(r.field))continue;e=e.add(r.field),t.push(new eo(r.field,0))}}for(let r of this.fn)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new eo(r.field,+("asc"!==r.dir))));return new ei(ei.UNKNOWN_ID,this.collectionId,t,el.empty())}wn(e){for(let t of this.gn)if(this.Sn(t,e))return!0;return!1}Sn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let r="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===r}bn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function iH(e){return e instanceof rE}function iJ(e){return e instanceof r_&&rN(e)}function iY(e){return iH(e)||iJ(e)||function(e){if(e instanceof r_&&rx(e)){for(let t of e.getFilters())if(!iH(t)&&!iJ(t))return!1;return!0}return!1}(e)}function iX(e,t){return N(e instanceof rE||e instanceof r_,38388),N(t instanceof rE||t instanceof r_,25473),i0(e instanceof rE?t instanceof rE?r_.create([e,t],"and"):iZ(e,t):t instanceof rE?iZ(t,e):function(e,t){if(N(e.filters.length>0&&t.filters.length>0,48005),rS(e)&&rS(t))return rC(e,t.getFilters());let r=rx(e)?e:t,n=rx(e)?t:e,i=r.filters.map(e=>iX(e,n));return r_.create(i,"or")}(e,t))}function iZ(e,t){if(rS(t))return rC(t,e.getFilters());{let r=t.filters.map(t=>iX(e,t));return r_.create(r,"or")}}function i0(e){if(N(e instanceof rE||e instanceof r_,11850),e instanceof rE)return e;let t=e.getFilters();if(1===t.length)return i0(t[0]);if(rD(e))return e;let r=t.map(e=>i0(e)),n=[];return r.forEach(t=>{t instanceof rE?n.push(t):t instanceof r_&&(t.op===e.op?n.push(...t.filters):n.push(t))}),1===n.length?n[0]:r_.create(n,e.op)}class i1{constructor(){this.Cn=new i2}addToCollectionParentIndex(e,t){return this.Cn.add(t),ep.resolve()}getCollectionParents(e,t){return ep.resolve(this.Cn.getEntries(t))}addFieldIndex(e,t){return ep.resolve()}deleteFieldIndex(e,t){return ep.resolve()}deleteAllFieldIndexes(e){return ep.resolve()}createTargetIndexes(e,t){return ep.resolve()}getDocumentsMatchingTarget(e,t){return ep.resolve(null)}getIndexType(e,t){return ep.resolve(0)}getFieldIndexes(e,t){return ep.resolve([])}getNextCollectionGroupToUpdate(e){return ep.resolve(null)}getMinOffset(e,t){return ep.resolve(ec.min())}getMinOffsetFromCollectionGroup(e,t){return ep.resolve(ec.min())}updateCollectionGroup(e,t,r){return ep.resolve()}updateIndexEntries(e,t){return ep.resolve()}}class i2{constructor(){this.index={}}add(e){let t=e.lastSegment(),r=e.popLast(),n=this.index[t]||new tO(j.comparator),i=!n.has(r);return this.index[t]=n.add(r),i}has(e){let t=e.lastSegment(),r=e.popLast(),n=this.index[t];return n&&n.has(r)}getEntries(e){return(this.index[e]||new tO(j.comparator)).toArray()}}let i5="IndexedDbIndexManager",i4=new Uint8Array(0);class i3{constructor(e,t){this.databaseId=t,this.vn=new i2,this.Fn=new r8(e=>rq(e),(e,t)=>rB(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.vn.has(t)){let r=t.lastSegment(),n=t.popLast();e.addOnCommittedListener(()=>{this.vn.add(t)});let i={collectionId:r,parent:eO(n)};return tD(e,te).put(i)}return ep.resolve()}getCollectionParents(e,t){let r=[],n=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return tD(e,te).J(n).next(e=>{for(let n of e){if(n.collectionId!==t)break;r.push(eP(n.parent))}return r})}addFieldIndex(e,t){let r=tD(e,ts),n={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete n.indexId;let i=r.add(n);if(t.indexState){let r=tD(e,to);return i.next(e=>{r.put(iR(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let r=tD(e,ts),n=tD(e,to),i=tD(e,tc);return r.delete(t.indexId).next(()=>n.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=tD(e,ts),r=tD(e,tc),n=tD(e,to);return t.Z().next(()=>r.Z()).next(()=>n.Z())}createTargetIndexes(e,t){return ep.forEach(this.Mn(t),t=>this.getIndexType(e,t).next(r=>{if(0===r||1===r){let r=new iW(t).Dn();if(null!=r)return this.addFieldIndex(e,r)}}))}getDocumentsMatchingTarget(e,t){let r=tD(e,tc),n=!0,i=new Map;return ep.forEach(this.Mn(t),t=>this.xn(e,t).next(e=>{n&&(n=!!e),i.set(t,e)})).next(()=>{if(n){let e=ns(),n=[];return ep.forEach(i,(i,s)=>{T(i5,`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${rq(t)}`);let a=function(e,t){let r=es(t);if(void 0===r)return null;for(let t of rK(e,r.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let r=new Map;for(let n of ea(t))for(let t of rK(e,n.fieldPath))switch(t.op){case"==":case"in":r.set(n.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return r.set(n.fieldPath.canonicalString(),t.value),Array.from(r.values())}return null}(s,i),l=function(e,t){let r=[],n=!0;for(let i of ea(t)){let t=0===i.kind?r$(e,i.fieldPath,e.startAt):rG(e,i.fieldPath,e.startAt);r.push(t.value),n&&(n=t.inclusive)}return new rw(r,n)}(s,i),u=function(e,t){let r=[],n=!0;for(let i of ea(t)){let t=0===i.kind?rG(e,i.fieldPath,e.endAt):r$(e,i.fieldPath,e.endAt);r.push(t.value),n&&(n=t.inclusive)}return new rw(r,n)}(s,i),h=this.On(i,s,l),c=this.On(i,s,u),d=this.Nn(i,s,o),f=this.Bn(i.indexId,a,h,l.inclusive,c,u.inclusive,d);return ep.forEach(f,i=>r.Y(i,t.limit).next(t=>{t.forEach(t=>{let r=H.fromSegments(t.documentKey);e.has(r)||(e=e.add(r),n.push(r))})}))}).next(()=>n)}return ep.resolve(null)})}Mn(e){let t=this.Fn.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(N(t instanceof rE||t instanceof r_,34018),t instanceof rE)return t;if(1===t.filters.length)return e(t.filters[0]);let r=t.filters.map(t=>e(t)),n=r_.create(r,t.op);return iY(n=i0(n))?n:(N(n instanceof r_,64498),N(rS(n),40251),N(n.filters.length>1,57927),n.filters.reduce((e,t)=>iX(e,t)))}(function e(t){if(N(t instanceof rE||t instanceof r_,20012),t instanceof rE){if(t instanceof rO){let e=t.value.arrayValue?.values?.map(e=>rE.create(t.field,"==",e))||[];return r_.create(e,"or")}return t}let r=t.filters.map(t=>e(t));return r_.create(r,t.op)}(e));return N(iY(t),7391),iH(t)||iJ(t)?[t]:t.getFilters()})(r_.create(e.filters,"and")).map(t=>rU(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.Fn.set(e,t)),t}Bn(e,t,r,n,i,s,a){let o=(null!=t?t.length:1)*Math.max(r.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let h=0;h<o;++h){let o=t?this.Ln(t[h/l]):i4,c=this.kn(e,o,r[h%l],n),d=this.qn(e,o,i[h%l],s),f=a.map(t=>this.kn(e,o,t,!0));u.push(...this.createRange(c,d,f))}return u}kn(e,t,r,n){let i=new iK(e,H.empty(),t,r);return n?i:i.An()}qn(e,t,r,n){let i=new iK(e,H.empty(),t,r);return n?i.An():i}xn(e,t){let r=new iW(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(let n of e)r.yn(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let r=2,n=this.Mn(t);return ep.forEach(n,t=>this.xn(e,t).next(e=>{e?0!==r&&e.fields.length<function(e){let t=new tO(W.comparator),r=!1;for(let n of e.filters)for(let e of n.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?r=!0:t=t.add(e.field));for(let r of e.orderBy)r.field.isKeyField()||(t=t.add(r.field));return t.size+ +!!r}(t)&&(r=1):r=0})).next(()=>null!==t.limit&&n.length>1&&2===r?1:r)}Qn(e,t){let r=new iz;for(let n of ea(e)){let e=t.data.field(n.fieldPath);if(null==e)return null;let i=r.Pn(n.kind);iF.Kt.Dt(e,i)}return r.un()}Ln(e){let t=new iz;return iF.Kt.Dt(e,t.Pn(0)),t.un()}$n(e,t){let r=new iz;return iF.Kt.Dt(ri(this.databaseId,t),r.Pn(function(e){let t=ea(e);return 0===t.length?0:t[t.length-1].kind}(e))),r.un()}Nn(e,t,r){if(null===r)return[];let n=[];n.push(new iz);let i=0;for(let s of ea(e)){let e=r[i++];for(let r of n)if(this.Un(t,s.fieldPath)&&ra(e))n=this.Kn(n,s,e);else{let t=r.Pn(s.kind);iF.Kt.Dt(e,t)}}return this.Wn(n)}On(e,t,r){return this.Nn(e,t,r.position)}Wn(e){let t=[];for(let r=0;r<e.length;++r)t[r]=e[r].un();return t}Kn(e,t,r){let n=[...e],i=[];for(let e of r.arrayValue.values||[])for(let r of n){let n=new iz;n.seed(r.un()),iF.Kt.Dt(e,n.Pn(t.kind)),i.push(n)}return i}Un(e,t){return!!e.filters.find(e=>e instanceof rE&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let r=tD(e,ts),n=tD(e,to);return(t?r.J(ta,IDBKeyRange.bound(t,t)):r.J()).next(e=>{let t=[];return ep.forEach(e,e=>n.get([e.indexId,this.uid]).next(r=>{t.push(function(e,t){let r=t?new el(t.sequenceNumber,new ec(ix(t.readTime),new H(eP(t.documentKey)),t.largestBatchId)):el.empty(),n=e.fields.map(([e,t])=>new eo(W.fromServerFormat(e),t));return new ei(e.indexId,e.collectionGroup,n,r)}(e,r))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let r=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==r?r:q(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,r){let n=tD(e,ts),i=tD(e,to);return this.Gn(e).next(e=>n.J(ta,IDBKeyRange.bound(t,t)).next(t=>ep.forEach(t,t=>i.put(iR(t.indexId,this.uid,e,r)))))}updateIndexEntries(e,t){let r=new Map;return ep.forEach(t,(t,n)=>{let i=r.get(t.collectionGroup);return(i?ep.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(r.set(t.collectionGroup,i),ep.forEach(i,r=>this.zn(e,t,r).next(t=>{let i=this.jn(n,r);return t.isEqual(i)?ep.resolve():this.Jn(e,n,r,t,i)}))))})}Hn(e,t,r,n){return tD(e,tc).put(n.Rn(this.uid,this.$n(r,t.key),t.key))}Yn(e,t,r,n){return tD(e,tc).delete(n.Vn(this.uid,this.$n(r,t.key),t.key))}zn(e,t,r){let n=tD(e,tc),i=new tO(i$);return n.ee({index:tf,range:IDBKeyRange.only([r.indexId,this.uid,ij(this.$n(r,t))])},(e,n)=>{i=i.add(new iK(r.indexId,t,iQ(n.arrayValue),iQ(n.directionalValue)))}).next(()=>i)}jn(e,t){let r=new tO(i$),n=this.Qn(t,e);if(null==n)return r;let i=es(t);if(null!=i){let s=e.data.field(i.fieldPath);if(ra(s))for(let i of s.arrayValue.values||[])r=r.add(new iK(t.indexId,e.key,this.Ln(i),n))}else r=r.add(new iK(t.indexId,e.key,i4,n));return r}Jn(e,t,r,n,i){T(i5,"Updating index entries for document '%s'",t.key);let s=[];return function(e,t,r,n,i){let s=e.getIterator(),a=t.getIterator(),o=tF(s),l=tF(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let n=r(o,l);n<0?t=!0:n>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(n(l),l=tF(a)):t?(i(o),o=tF(s)):(o=tF(s),l=tF(a))}}(n,i,i$,n=>{s.push(this.Hn(e,t,r,n))},n=>{s.push(this.Yn(e,t,r,n))}),ep.waitFor(s)}Gn(e){let t=1;return tD(e,to).ee({index:tu,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,r,n)=>{n.done(),t=r.sequenceNumber+1}).next(()=>t)}createRange(e,t,r){r=r.sort((e,t)=>i$(e,t)).filter((e,t,r)=>!t||0!==i$(e,r[t-1]));let n=[];for(let i of(n.push(e),r)){let r=i$(i,e),s=i$(i,t);if(0===r)n[0]=e.An();else if(r>0&&s<0)n.push(i),n.push(i.An());else if(s>0)break}n.push(t);let i=[];for(let e=0;e<n.length;e+=2){if(this.Zn(n[e],n[e+1]))return[];let t=n[e].Vn(this.uid,i4,H.empty()),r=n[e+1].Vn(this.uid,i4,H.empty());i.push(IDBKeyRange.bound(t,r))}return i}Zn(e,t){return i$(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(i6)}getMinOffset(e,t){return ep.mapArray(this.Mn(t),t=>this.xn(e,t).next(e=>e||S(44426))).next(i6)}}function i6(e){N(0!==e.length,28825);let t=e[0].indexState.offset,r=t.largestBatchId;for(let n=1;n<e.length;n++){let i=e[n].indexState.offset;0>ed(i,t)&&(t=i),r<i.largestBatchId&&(r=i.largestBatchId)}return new ec(t.readTime,t.documentKey,r)}let i8={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class i9{static withCacheSize(e){return new i9(e,i9.DEFAULT_COLLECTION_PERCENTILE,i9.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,r){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=r}}function i7(e,t,r){let n=e.store(eB),i=e.store(ej),s=[],a=IDBKeyRange.only(r.batchId),o=0,l=n.ee({range:a},(e,t,r)=>(o++,r.delete()));s.push(l.next(()=>{N(1===o,47070,{batchId:r.batchId})}));let u=[];for(let e of r.mutations){var h,c;let n=(h=e.key.path,c=r.batchId,[t,eO(h),c]);s.push(i.delete(n)),u.push(e.key)}return ep.waitFor(s).next(()=>u)}function se(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw S(14731);t=e.noDocument}return JSON.stringify(t).length}i9.DEFAULT_COLLECTION_PERCENTILE=10,i9.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,i9.DEFAULT=new i9(0x2800000,i9.DEFAULT_COLLECTION_PERCENTILE,i9.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),i9.DISABLED=new i9(-1,0,0);class st{constructor(e,t,r,n){this.userId=e,this.serializer=t,this.indexManager=r,this.referenceDelegate=n,this.Xn={}}static wt(e,t,r,n){return N(""!==e.uid,64387),new st(e.isAuthenticated()?e.uid:"",t,r,n)}checkEmpty(e){let t=!0,r=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return sn(e).ee({index:eK,range:r},(e,r,n)=>{t=!1,n.done()}).next(()=>t)}addMutationBatch(e,t,r,n){let i=tD(e,ej),s=sn(e);return s.add({}).next(a=>{N("number"==typeof a,49019);let o=new nO(a,t,r,n),l=function(e,t,r){let n=r.baseMutations.map(t=>id(e.yt,t)),i=r.mutations.map(t=>id(e.yt,t));return{userId:t,batchId:r.batchId,localWriteTimeMs:r.localWriteTime.toMillis(),baseMutations:n,mutations:i}}(this.serializer,this.userId,o),u=[],h=new tO((e,t)=>q(e.canonicalString(),t.canonicalString()));for(let e of n){var c;let t=(c=this.userId,[c,eO(e.key.path),a]);h=h.add(e.key.path.popLast()),u.push(s.put(l)),u.push(i.put(t,eG))}return h.forEach(t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Xn[a]=o.keys()}),ep.waitFor(u).next(()=>o)})}lookupMutationBatch(e,t){return sn(e).get(t).next(e=>e?(N(e.userId===this.userId,48,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),iN(this.serializer,e)):null)}er(e,t){return this.Xn[t]?ep.resolve(this.Xn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let r=e.keys();return this.Xn[t]=r,r}return null})}getNextMutationBatchAfterBatchId(e,t){let r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]),i=null;return sn(e).ee({index:eK,range:n},(e,t,n)=>{t.userId===this.userId&&(N(t.batchId>=r,47524,{tr:r}),i=iN(this.serializer,t)),n.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return sn(e).ee({index:eK,range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return sn(e).J(eK,t).next(e=>e.map(e=>iN(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let r=[this.userId,eO(t.path)],n=IDBKeyRange.lowerBound(r),i=[];return tD(e,ej).ee({range:n},(r,n,s)=>{let[a,o,l]=r,u=eP(o);if(a===this.userId&&t.path.isEqual(u))return sn(e).get(l).next(e=>{if(!e)throw S(61480,{nr:r,batchId:l});N(e.userId===this.userId,10503,"Unexpected user for mutation batch",{userId:e.userId,batchId:l}),i.push(iN(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new tO(q),n=[];return t.forEach(t=>{let i=[this.userId,eO(t.path)],s=IDBKeyRange.lowerBound(i),a=tD(e,ej).ee({range:s},(e,n,i)=>{let[s,a,o]=e,l=eP(a);s===this.userId&&t.path.isEqual(l)?r=r.add(o):i.done()});n.push(a)}),ep.waitFor(n).next(()=>this.rr(e,r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,n=r.length+1,i=[this.userId,eO(r)],s=IDBKeyRange.lowerBound(i),a=new tO(q);return tD(e,ej).ee({range:s},(e,t,i)=>{let[s,o,l]=e,u=eP(o);s===this.userId&&r.isPrefixOf(u)?u.length===n&&(a=a.add(l)):i.done()}).next(()=>this.rr(e,a))}rr(e,t){let r=[],n=[];return t.forEach(t=>{n.push(sn(e).get(t).next(e=>{if(null===e)throw S(35274,{batchId:t});N(e.userId===this.userId,9748,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),r.push(iN(this.serializer,e))}))}),ep.waitFor(n).next(()=>r)}removeMutationBatch(e,t){return i7(e.le,this.userId,t).next(r=>(e.addOnCommittedListener(()=>{this.ir(t.batchId)}),ep.forEach(r,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}ir(e){delete this.Xn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return ep.resolve();let r=IDBKeyRange.lowerBound([this.userId]),n=[];return tD(e,ej).ee({range:r},(e,t,r)=>{if(e[0]===this.userId){let t=eP(e[1]);n.push(t)}else r.done()}).next(()=>{N(0===n.length,56720,{sr:n.map(e=>e.canonicalString())})})})}containsKey(e,t){return sr(e,this.userId,t)}_r(e){return tD(e,eq).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function sr(e,t,r){let n=[t,eO(r.path)],i=n[1],s=IDBKeyRange.lowerBound(n),a=!1;return tD(e,ej).ee({range:s,X:!0},(e,r,n)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),n.done()}).next(()=>a)}function sn(e){return tD(e,eB)}class si{constructor(e){this.ar=e}next(){return this.ar+=2,this.ar}static ur(){return new si(0)}static cr(){return new si(-1)}}class ss{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.lr(e).next(t=>{let r=new si(t.highestTargetId);return t.highestTargetId=r.next(),this.hr(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.lr(e).next(e=>en.fromTimestamp(new er(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.lr(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,r){return this.lr(e).next(n=>(n.highestListenSequenceNumber=t,r&&(n.lastRemoteSnapshotVersion=r.toTimestamp()),t>n.highestListenSequenceNumber&&(n.highestListenSequenceNumber=t),this.hr(e,n)))}addTargetData(e,t){return this.Pr(e,t).next(()=>this.lr(e).next(r=>(r.targetCount+=1,this.Tr(t,r),this.hr(e,r))))}updateTargetData(e,t){return this.Pr(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>tD(e,e1).delete(t.targetId)).next(()=>this.lr(e)).next(t=>(N(t.targetCount>0,8065),t.targetCount-=1,this.hr(e,t)))}removeTargets(e,t,r){let n=0,i=[];return tD(e,e1).ee((s,a)=>{let o=iD(a);o.sequenceNumber<=t&&null===r.get(o.targetId)&&(n++,i.push(this.removeTargetData(e,o)))}).next(()=>ep.waitFor(i)).next(()=>n)}forEachTarget(e,t){return tD(e,e1).ee((e,r)=>{t(iD(r))})}lr(e){return tD(e,e7).get(e9).next(e=>(N(null!==e,2888),e))}hr(e,t){return tD(e,e7).put(e9,t)}Pr(e,t){return tD(e,e1).put(iC(this.serializer,t))}Tr(e,t){let r=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,r=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,r=!0),r}getTargetCount(e){return this.lr(e).next(e=>e.targetCount)}getTargetData(e,t){let r=rq(t),n=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),i=null;return tD(e,e1).ee({range:n,index:e2},(e,r,n)=>{let s=iD(r);rB(t,s.target)&&(i=s,n.done())}).next(()=>i)}addMatchingKeys(e,t,r){let n=[],i=sa(e);return t.forEach(t=>{let s=eO(t.path);n.push(i.put({targetId:r,path:s})),n.push(this.referenceDelegate.addReference(e,r,t))}),ep.waitFor(n)}removeMatchingKeys(e,t,r){let n=sa(e);return ep.forEach(t,t=>{let i=eO(t.path);return ep.waitFor([n.delete([r,i]),this.referenceDelegate.removeReference(e,r,t)])})}removeMatchingKeysForTargetId(e,t){let r=sa(e),n=IDBKeyRange.bound([t],[t+1],!1,!0);return r.delete(n)}getMatchingKeysForTargetId(e,t){let r=IDBKeyRange.bound([t],[t+1],!1,!0),n=sa(e),i=ns();return n.ee({range:r,X:!0},(e,t,r)=>{let n=new H(eP(e[1]));i=i.add(n)}).next(()=>i)}containsKey(e,t){let r=eO(t.path),n=IDBKeyRange.bound([r],[r+"\0"],!1,!0),i=0;return sa(e).ee({index:e6,X:!0,range:n},([e,t],r,n)=>{0!==e&&(i++,n.done())}).next(()=>i>0)}At(e,t){return tD(e,e1).get(t).next(e=>e?iD(e):null)}}function sa(e){return tD(e,e4)}let so="LruGarbageCollector";function sl([e,t],[r,n]){let i=q(e,r);return 0===i?q(t,n):i}class su{constructor(e){this.Ir=e,this.buffer=new tO(sl),this.Er=0}dr(){return++this.Er}Ar(e){let t=[e,this.dr()];if(this.buffer.size<this.Ir)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>sl(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class sh{constructor(e,t,r){this.garbageCollector=e,this.asyncQueue=t,this.localStore=r,this.Rr=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Vr(6e4)}stop(){this.Rr&&(this.Rr.cancel(),this.Rr=null)}get started(){return null!==this.Rr}Vr(e){T(so,`Garbage collection scheduled in ${e}ms`),this.Rr=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Rr=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){eE(e)?T(so,"Ignoring IndexedDB error during garbage collection: ",e):await eg(e)}await this.Vr(3e5)})}}class sc{constructor(e,t){this.mr=e,this.params=t}calculateTargetCount(e,t){return this.mr.gr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return ep.resolve(eA.ce);let r=new su(t);return this.mr.forEachTarget(e,e=>r.Ar(e.sequenceNumber)).next(()=>this.mr.pr(e,e=>r.Ar(e))).next(()=>r.maxValue)}removeTargets(e,t,r){return this.mr.removeTargets(e,t,r)}removeOrphanedDocuments(e,t){return this.mr.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector","Garbage collection skipped; disabled"),ep.resolve(i8)):this.getCacheSize(e).next(r=>r<this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),i8):this.yr(e,t))}getCacheSize(e){return this.mr.getCacheSize(e)}yr(e,t){let r,n,i,s,a,o,l;let h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(T("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),n=this.params.maximumSequenceNumbersToCollect):n=t,s=Date.now(),this.nthSequenceNumber(e,n))).next(n=>(r=n,a=Date.now(),this.removeTargets(e,r,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,r))).next(e=>(l=Date.now(),I()<=u.$b.DEBUG&&T("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-h}ms
	Determined least recently used ${n} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-h}ms`),ep.resolve({didRun:!0,sequenceNumbersCollected:n,targetsRemoved:i,documentsRemoved:e})))}}class sd{constructor(e,t){this.db=e,this.garbageCollector=new sc(this,t)}gr(e){let t=this.wr(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}wr(e){let t=0;return this.pr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}pr(e,t){return this.Sr(e,(e,r)=>t(r))}addReference(e,t,r){return sf(e,r)}removeReference(e,t,r){return sf(e,r)}removeTargets(e,t,r){return this.db.getTargetCache().removeTargets(e,t,r)}markPotentiallyOrphaned(e,t){return sf(e,t)}br(e,t){let r;return r=!1,tD(e,eq).te(n=>sr(e,n,t).next(e=>(e&&(r=!0),ep.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(e,t){let r=this.db.getRemoteDocumentCache().newChangeBuffer(),n=[],i=0;return this.Sr(e,(s,a)=>{if(a<=t){let t=this.br(e,s).next(t=>{if(!t)return i++,r.getEntry(e,s).next(()=>(r.removeEntry(s,en.min()),sa(e).delete([0,eO(s.path)])))});n.push(t)}}).next(()=>ep.waitFor(n)).next(()=>r.apply(e)).next(()=>i)}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,r)}updateLimboDocument(e,t){return sf(e,t)}Sr(e,t){let r=sa(e),n,i=eA.ce;return r.ee({index:e6},([e,r],{path:s,sequenceNumber:a})=>{0===e?(i!==eA.ce&&t(new H(eP(n)),i),i=a,n=s):i=eA.ce}).next(()=>{i!==eA.ce&&t(new H(eP(n)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function sf(e,t){var r;return sa(e).put((r=e.currentSequenceNumber,{targetId:0,path:eO(t.path),sequenceNumber:r}))}class sm{constructor(){this.changes=new r8(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,ry.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let r=this.changes.get(t);return void 0!==r?ep.resolve(r):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class sg{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,r){return tD(e,eQ).put(r)}removeEntry(e,t,r){return tD(e,eQ).delete(function(e,t){let r=e.path.toArray();return[r.slice(0,r.length-2),r[r.length-2],i_(t),r[r.length-1]]}(t,r))}updateMetadata(e,t){return this.getMetadata(e).next(r=>(r.byteSize+=t,this.Dr(e,r)))}getEntry(e,t){let r=ry.newInvalidDocument(t);return tD(e,eQ).ee({index:eH,range:IDBKeyRange.only(sy(t))},(e,n)=>{r=this.Cr(t,n)}).next(()=>r)}vr(e,t){let r={size:0,document:ry.newInvalidDocument(t)};return tD(e,eQ).ee({index:eH,range:IDBKeyRange.only(sy(t))},(e,n)=>{r={document:this.Cr(t,n),size:se(n)}}).next(()=>r)}getEntries(e,t){let r=r9;return this.Fr(e,t,(e,t)=>{let n=this.Cr(e,t);r=r.insert(e,n)}).next(()=>r)}Mr(e,t){let r=r9,n=new tV(H.comparator);return this.Fr(e,t,(e,t)=>{let i=this.Cr(e,t);r=r.insert(e,i),n=n.insert(e,se(t))}).next(()=>({documents:r,Or:n}))}Fr(e,t,r){if(t.isEmpty())return ep.resolve();let n=new tO(sv);t.forEach(e=>n=n.add(e));let i=IDBKeyRange.bound(sy(n.first()),sy(n.last())),s=n.getIterator(),a=s.getNext();return tD(e,eQ).ee({index:eH,range:i},(e,t,n)=>{let i=H.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>sv(a,i);)r(a,null),a=s.getNext();a&&a.isEqual(i)&&(r(a,t),a=s.hasNext()?s.getNext():null),a?n.j(sy(a)):n.done()}).next(()=>{for(;a;)r(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,r,n,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),i_(r.readTime),r.documentKey.path.isEmpty()?"":r.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tD(e,eQ).J(IDBKeyRange.bound(a,o,!0)).next(e=>{i?.incrementDocumentReadCount(e.length);let r=r9;for(let i of e){let e=this.Cr(H.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(r4(t,e)||n.has(e.key))&&(r=r.insert(e.key,e))}return r})}getAllFromCollectionGroup(e,t,r,n){let i=r9,s=sw(t,r),a=sw(t,ec.max());return tD(e,eQ).ee({index:eY,range:IDBKeyRange.bound(s,a,!0)},(e,t,r)=>{let s=this.Cr(H.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===n&&r.done()}).next(()=>i)}newChangeBuffer(e){return new sp(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return tD(e,eZ).get(e0).next(e=>(N(!!e,20021),e))}Dr(e,t){return tD(e,eZ).put(e0,t)}Cr(e,t){if(t){let e=function(e,t){let r;if(t.document)r=ic(e.yt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=H.fromSegments(t.noDocument.path),n=ix(t.noDocument.readTime);r=ry.newNoDocument(e,n),t.hasCommittedMutations&&r.setHasCommittedMutations()}else{if(!t.unknownDocument)return S(56709);{let e=H.fromSegments(t.unknownDocument.path),n=ix(t.unknownDocument.version);r=ry.newUnknownDocument(e,n)}}return t.readTime&&r.setReadTime(function(e){let t=new er(e[0],e[1]);return en.fromTimestamp(t)}(t.readTime)),r}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(en.min())))return e}return ry.newInvalidDocument(e)}}class sp extends sm{constructor(e,t){super(),this.Nr=e,this.trackRemovals=t,this.Br=new r8(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],r=0,n=new tO((e,t)=>q(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.Br.get(i);if(t.push(this.Nr.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=iE(this.Nr.serializer,s);n=n.add(i.path.popLast());let l=se(o);r+=l-a.size,t.push(this.Nr.addEntry(e,i,o))}else if(r-=a.size,this.trackRemovals){let r=iE(this.Nr.serializer,s.convertToNoDocument(en.min()));t.push(this.Nr.addEntry(e,i,r))}}),n.forEach(r=>{t.push(this.Nr.indexManager.addToCollectionParentIndex(e,r))}),t.push(this.Nr.updateMetadata(e,r)),ep.waitFor(t)}getFromCache(e,t){return this.Nr.vr(e,t).next(e=>(this.Br.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Nr.Mr(e,t).next(({documents:e,Or:t})=>(t.forEach((t,r)=>{this.Br.set(t,{size:r,readTime:e.get(t).readTime})}),e))}}function sy(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function sw(e,t){let r=t.documentKey.path.toArray();return[e,i_(t.readTime),r.slice(0,r.length-2),r.length>0?r[r.length-1]:""]}function sv(e,t){let r=e.path.toArray(),n=t.path.toArray(),i=0;for(let e=0;e<r.length-2&&e<n.length-2;++e)if(i=q(r[e],n[e]))return i;return(i=q(r.length,n.length))||(i=q(r[r.length-2],n[n.length-2]))||q(r[r.length-1],n[n.length-1])}class sI{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class sT{constructor(e,t,r,n){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=r,this.indexManager=n}getDocument(e,t){let r=null;return this.documentOverlayCache.getOverlay(e,t).next(n=>(r=n,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==r&&nx(r.mutation,e,tL.empty(),er.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,ns()).next(()=>t))}getLocalViewOfDocuments(e,t,r=ns()){let n=nr();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,r).next(e=>{let t=ne();return e.forEach((e,r)=>{t=t.insert(e,r.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let r=nr();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,ns()))}populateOverlays(e,t,r){let n=[];return r.forEach(e=>{t.has(e)||n.push(e)}),this.documentOverlayCache.getOverlays(e,n).next(e=>{e.forEach((e,r)=>{t.set(e,r)})})}computeViews(e,t,r,n){let i=r9,s=nr(),a=nr();return t.forEach((e,t)=>{let a=r.get(t.key);n.has(t.key)&&(void 0===a||a.mutation instanceof nC)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),nx(a.mutation,t,a.mutation.getFieldMask(),er.now())):s.set(t.key,tL.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>a.set(e,new sI(t,s.get(e)??null))),a))}recalculateAndSaveOverlays(e,t){let r=nr(),n=new tV((e,t)=>e-t),i=ns();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=r.get(e)||tL.empty();a=i.applyToLocalView(s,a),r.set(e,a);let o=(n.get(i.batchId)||ns()).add(e);n=n.insert(i.batchId,o)})}).next(()=>{let s=[],a=n.getReverseIterator();for(;a.hasNext();){let n=a.getNext(),o=n.key,l=n.value,u=nr();l.forEach(e=>{if(!i.has(e)){let n=nS(t.get(e),r.get(e));null!==n&&u.set(e,n),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return ep.waitFor(s)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,r,n){return H.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):rH(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,r,n):this.getDocumentsMatchingCollectionQuery(e,t,r,n)}getNextDocuments(e,t,r,n){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,r,n).next(i=>{let s=n-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,r.largestBatchId,n-i.size):ep.resolve(nr()),a=-1,o=i;return s.next(t=>ep.forEach(t,(t,r)=>(a<r.largestBatchId&&(a=r.largestBatchId),i.get(t)?ep.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,ns())).next(e=>({batchId:a,changes:nt(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new H(t)).next(e=>{let t=ne();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,r,n){let i=t.collectionGroup,s=ne();return this.indexManager.getCollectionParents(e,i).next(a=>ep.forEach(a,a=>{let o=new rj(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,r,n).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,r,n){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,r.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,r,i,n))).next(e=>{i.forEach((t,r)=>{let n=r.getKey();null===e.get(n)&&(e=e.insert(n,ry.newInvalidDocument(n)))});let r=ne();return e.forEach((e,n)=>{let s=i.get(e);void 0!==s&&nx(s.mutation,n,tL.empty(),er.now()),r4(t,n)&&(r=r.insert(e,n))}),r})}}class sb{constructor(e){this.serializer=e,this.Lr=new Map,this.kr=new Map}getBundleMetadata(e,t){return ep.resolve(this.Lr.get(t))}saveBundleMetadata(e,t){return this.Lr.set(t.id,{id:t.id,version:t.version,createTime:n7(t.createTime)}),ep.resolve()}getNamedQuery(e,t){return ep.resolve(this.kr.get(t))}saveNamedQuery(e,t){return this.kr.set(t.name,{name:t.name,query:ik(t.bundledQuery),readTime:n7(t.readTime)}),ep.resolve()}}class sE{constructor(){this.overlays=new tV(H.comparator),this.qr=new Map}getOverlay(e,t){return ep.resolve(this.overlays.get(t))}getOverlays(e,t){let r=nr();return ep.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&r.set(t,e)})).next(()=>r)}saveOverlays(e,t,r){return r.forEach((r,n)=>{this.St(e,t,n)}),ep.resolve()}removeOverlaysForBatchId(e,t,r){let n=this.qr.get(r);return void 0!==n&&(n.forEach(e=>this.overlays=this.overlays.remove(e)),this.qr.delete(r)),ep.resolve()}getOverlaysForCollection(e,t,r){let n=nr(),i=t.length+1,s=new H(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>r&&n.set(e.getKey(),e)}return ep.resolve(n)}getOverlaysForCollectionGroup(e,t,r,n){let i=new tV((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>r){let t=i.get(e.largestBatchId);null===t&&(t=nr(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=nr(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=n)););return ep.resolve(a)}St(e,t,r){let n=this.overlays.get(r.key);if(null!==n){let e=this.qr.get(n.largestBatchId).delete(r.key);this.qr.set(n.largestBatchId,e)}this.overlays=this.overlays.insert(r.key,new nF(t,r));let i=this.qr.get(t);void 0===i&&(i=ns(),this.qr.set(t,i)),this.qr.set(t,i.add(r.key))}}class s_{constructor(){this.sessionToken=tq.EMPTY_BYTE_STRING}getSessionToken(e){return ep.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,ep.resolve()}}class sS{constructor(){this.Qr=new tO(sx.$r),this.Ur=new tO(sx.Kr)}isEmpty(){return this.Qr.isEmpty()}addReference(e,t){let r=new sx(e,t);this.Qr=this.Qr.add(r),this.Ur=this.Ur.add(r)}Wr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Gr(new sx(e,t))}zr(e,t){e.forEach(e=>this.removeReference(e,t))}jr(e){let t=new H(new j([])),r=new sx(t,e),n=new sx(t,e+1),i=[];return this.Ur.forEachInRange([r,n],e=>{this.Gr(e),i.push(e.key)}),i}Jr(){this.Qr.forEach(e=>this.Gr(e))}Gr(e){this.Qr=this.Qr.delete(e),this.Ur=this.Ur.delete(e)}Hr(e){let t=new H(new j([])),r=new sx(t,e),n=new sx(t,e+1),i=ns();return this.Ur.forEachInRange([r,n],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new sx(e,0),r=this.Qr.firstAfterOrEqual(t);return null!==r&&e.isEqual(r.key)}}class sx{constructor(e,t){this.key=e,this.Yr=t}static $r(e,t){return H.comparator(e.key,t.key)||q(e.Yr,t.Yr)}static Kr(e,t){return q(e.Yr,t.Yr)||H.comparator(e.key,t.key)}}class sN{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.tr=1,this.Zr=new tO(sx.$r)}checkEmpty(e){return ep.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,r,n){let i=this.tr;this.tr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new nO(i,t,r,n);for(let t of(this.mutationQueue.push(s),n))this.Zr=this.Zr.add(new sx(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ep.resolve(s)}lookupMutationBatch(e,t){return ep.resolve(this.Xr(t))}getNextMutationBatchAfterBatchId(e,t){let r=this.ei(t+1),n=r<0?0:r;return ep.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return ep.resolve(0===this.mutationQueue.length?-1:this.tr-1)}getAllMutationBatches(e){return ep.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let r=new sx(t,0),n=new sx(t,Number.POSITIVE_INFINITY),i=[];return this.Zr.forEachInRange([r,n],e=>{let t=this.Xr(e.Yr);i.push(t)}),ep.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new tO(q);return t.forEach(e=>{let t=new sx(e,0),n=new sx(e,Number.POSITIVE_INFINITY);this.Zr.forEachInRange([t,n],e=>{r=r.add(e.Yr)})}),ep.resolve(this.ti(r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,n=r.length+1,i=r;H.isDocumentKey(i)||(i=i.child(""));let s=new sx(new H(i),0),a=new tO(q);return this.Zr.forEachWhile(e=>{let t=e.key.path;return!!r.isPrefixOf(t)&&(t.length===n&&(a=a.add(e.Yr)),!0)},s),ep.resolve(this.ti(a))}ti(e){let t=[];return e.forEach(e=>{let r=this.Xr(e);null!==r&&t.push(r)}),t}removeMutationBatch(e,t){N(0===this.ni(t.batchId,"removed"),55003),this.mutationQueue.shift();let r=this.Zr;return ep.forEach(t.mutations,n=>{let i=new sx(n.key,t.batchId);return r=r.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,n.key)}).next(()=>{this.Zr=r})}ir(e){}containsKey(e,t){let r=new sx(t,0),n=this.Zr.firstAfterOrEqual(r);return ep.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,ep.resolve()}ni(e,t){return this.ei(e)}ei(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Xr(e){let t=this.ei(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class sD{constructor(e){this.ri=e,this.docs=new tV(H.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let r=t.key,n=this.docs.get(r),i=n?n.size:0,s=this.ri(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let r=this.docs.get(t);return ep.resolve(r?r.document.mutableCopy():ry.newInvalidDocument(t))}getEntries(e,t){let r=r9;return t.forEach(e=>{let t=this.docs.get(e);r=r.insert(e,t?t.document.mutableCopy():ry.newInvalidDocument(e))}),ep.resolve(r)}getDocumentsMatchingQuery(e,t,r,n){let i=r9,s=t.path,a=new H(s.child("__id-9223372036854775808__")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=ed(eh(a),r)||(n.has(a.key)||r4(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return ep.resolve(i)}getAllFromCollectionGroup(e,t,r,n){S(9500)}ii(e,t){return ep.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new sC(this)}getSize(e){return ep.resolve(this.size)}}class sC extends sm{constructor(e){super(),this.Nr=e}applyChanges(e){let t=[];return this.changes.forEach((r,n)=>{n.isValidDocument()?t.push(this.Nr.addEntry(e,n)):this.Nr.removeEntry(r)}),ep.waitFor(t)}getFromCache(e,t){return this.Nr.getEntry(e,t)}getAllFromCache(e,t){return this.Nr.getEntries(e,t)}}class sk{constructor(e){this.persistence=e,this.si=new r8(e=>rq(e),rB),this.lastRemoteSnapshotVersion=en.min(),this.highestTargetId=0,this.oi=0,this._i=new sS,this.targetCount=0,this.ai=si.ur()}forEachTarget(e,t){return this.si.forEach((e,r)=>t(r)),ep.resolve()}getLastRemoteSnapshotVersion(e){return ep.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ep.resolve(this.oi)}allocateTargetId(e){return this.highestTargetId=this.ai.next(),ep.resolve(this.highestTargetId)}setTargetsMetadata(e,t,r){return r&&(this.lastRemoteSnapshotVersion=r),t>this.oi&&(this.oi=t),ep.resolve()}Pr(e){this.si.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.ai=new si(t),this.highestTargetId=t),e.sequenceNumber>this.oi&&(this.oi=e.sequenceNumber)}addTargetData(e,t){return this.Pr(t),this.targetCount+=1,ep.resolve()}updateTargetData(e,t){return this.Pr(t),ep.resolve()}removeTargetData(e,t){return this.si.delete(t.target),this._i.jr(t.targetId),this.targetCount-=1,ep.resolve()}removeTargets(e,t,r){let n=0,i=[];return this.si.forEach((s,a)=>{a.sequenceNumber<=t&&null===r.get(a.targetId)&&(this.si.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),n++)}),ep.waitFor(i).next(()=>n)}getTargetCount(e){return ep.resolve(this.targetCount)}getTargetData(e,t){let r=this.si.get(t)||null;return ep.resolve(r)}addMatchingKeys(e,t,r){return this._i.Wr(t,r),ep.resolve()}removeMatchingKeys(e,t,r){this._i.zr(t,r);let n=this.persistence.referenceDelegate,i=[];return n&&t.forEach(t=>{i.push(n.markPotentiallyOrphaned(e,t))}),ep.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this._i.jr(t),ep.resolve()}getMatchingKeysForTargetId(e,t){let r=this._i.Hr(t);return ep.resolve(r)}containsKey(e,t){return ep.resolve(this._i.containsKey(t))}}class sA{constructor(e,t){this.ui={},this.overlays={},this.ci=new eA(0),this.li=!1,this.li=!0,this.hi=new s_,this.referenceDelegate=e(this),this.Pi=new sk(this),this.indexManager=new i1,this.remoteDocumentCache=new sD(e=>this.referenceDelegate.Ti(e)),this.serializer=new ib(t),this.Ii=new sb(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.li=!1,Promise.resolve()}get started(){return this.li}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new sE,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let r=this.ui[e.toKey()];return r||(r=new sN(t,this.referenceDelegate),this.ui[e.toKey()]=r),r}getGlobalsCache(){return this.hi}getTargetCache(){return this.Pi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ii}runTransaction(e,t,r){T("MemoryPersistence","Starting transaction:",e);let n=new sV(this.ci.next());return this.referenceDelegate.Ei(),r(n).next(e=>this.referenceDelegate.di(n).next(()=>e)).toPromise().then(e=>(n.raiseOnCommittedEvent(),e))}Ai(e,t){return ep.or(Object.values(this.ui).map(r=>()=>r.containsKey(e,t)))}}class sV extends em{constructor(e){super(),this.currentSequenceNumber=e}}class sR{constructor(e){this.persistence=e,this.Ri=new sS,this.Vi=null}static mi(e){return new sR(e)}get fi(){if(this.Vi)return this.Vi;throw S(60996)}addReference(e,t,r){return this.Ri.addReference(r,t),this.fi.delete(r.toString()),ep.resolve()}removeReference(e,t,r){return this.Ri.removeReference(r,t),this.fi.add(r.toString()),ep.resolve()}markPotentiallyOrphaned(e,t){return this.fi.add(t.toString()),ep.resolve()}removeTarget(e,t){this.Ri.jr(t.targetId).forEach(e=>this.fi.add(e.toString()));let r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.fi.add(e.toString()))}).next(()=>r.removeTargetData(e,t))}Ei(){this.Vi=new Set}di(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ep.forEach(this.fi,r=>{let n=H.fromPath(r);return this.gi(e,n).next(e=>{e||t.removeEntry(n,en.min())})}).next(()=>(this.Vi=null,t.apply(e)))}updateLimboDocument(e,t){return this.gi(e,t).next(e=>{e?this.fi.delete(t.toString()):this.fi.add(t.toString())})}Ti(e){return 0}gi(e,t){return ep.or([()=>ep.resolve(this.Ri.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ai(e,t)])}}class sM{constructor(e,t){this.persistence=e,this.pi=new r8(e=>eO(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new sc(this,t)}static mi(e,t){return new sM(e,t)}Ei(){}di(e){return ep.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}gr(e){let t=this.wr(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}wr(e){let t=0;return this.pr(e,e=>{t++}).next(()=>t)}pr(e,t){return ep.forEach(this.pi,(r,n)=>this.br(e,r,n).next(e=>e?ep.resolve():t(n)))}removeTargets(e,t,r){return this.persistence.getTargetCache().removeTargets(e,t,r)}removeOrphanedDocuments(e,t){let r=0,n=this.persistence.getRemoteDocumentCache(),i=n.newChangeBuffer();return n.ii(e,n=>this.br(e,n,t).next(e=>{e||(r++,i.removeEntry(n,en.min()))})).next(()=>i.apply(e)).next(()=>r)}markPotentiallyOrphaned(e,t){return this.pi.set(t,e.currentSequenceNumber),ep.resolve()}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,r)}addReference(e,t,r){return this.pi.set(r,e.currentSequenceNumber),ep.resolve()}removeReference(e,t,r){return this.pi.set(r,e.currentSequenceNumber),ep.resolve()}updateLimboDocument(e,t){return this.pi.set(t,e.currentSequenceNumber),ep.resolve()}Ti(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(t8(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let r=tJ(t);return r?16+e(r):16;case 5:return 2*t.stringValue.length;case 6:return t$(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,r)=>t+e(r),0);case 10:case 11:var n;let i;return n=t.mapValue,i=0,tk(n.fields,(t,r)=>{i+=t.length+e(r)}),i;default:throw S(13486,{value:t})}}(e.data.value)),t}br(e,t,r){return ep.or([()=>this.persistence.Ai(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.pi.get(t);return ep.resolve(void 0!==e&&e>r)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class sO{constructor(e){this.serializer=e}k(e,t,r,n){let i=new ew("createOrUpgrade",t);r<1&&n>=1&&(!function(e){e.createObjectStore(eL)}(e),e.createObjectStore(eq,{keyPath:"userId"}),e.createObjectStore(eB,{keyPath:ez,autoIncrement:!0}).createIndex(eK,e$,{unique:!0}),e.createObjectStore(ej),sP(e),function(e){e.createObjectStore(eF)}(e));let s=ep.resolve();return r<3&&n>=3&&(0!==r&&(e.deleteObjectStore(e4),e.deleteObjectStore(e1),e.deleteObjectStore(e7),sP(e)),s=s.next(()=>(function(e){let t=e.store(e7),r={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:en.min().toTimestamp(),targetCount:0};return t.put(e9,r)})(i))),r<4&&n>=4&&(0!==r&&(s=s.next(()=>i.store(eB).J().next(t=>{e.deleteObjectStore(eB),e.createObjectStore(eB,{keyPath:ez,autoIncrement:!0}).createIndex(eK,e$,{unique:!0});let r=i.store(eB),n=t.map(e=>r.put(e));return ep.waitFor(n)}))),s=s.next(()=>{!function(e){e.createObjectStore(tr,{keyPath:"clientId"})}(e)})),r<5&&n>=5&&(s=s.next(()=>this.yi(i))),r<6&&n>=6&&(s=s.next(()=>((function(e){e.createObjectStore(eZ)})(e),this.wi(i)))),r<7&&n>=7&&(s=s.next(()=>this.Si(i))),r<8&&n>=8&&(s=s.next(()=>this.bi(e,i))),r<9&&n>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),r<10&&n>=10&&(s=s.next(()=>this.Di(i))),r<11&&n>=11&&(s=s.next(()=>{(function(e){e.createObjectStore(tn,{keyPath:"bundleId"})})(e),function(e){e.createObjectStore(ti,{keyPath:"name"})}(e)})),r<12&&n>=12&&(s=s.next(()=>{!function(e){let t=e.createObjectStore(tg,{keyPath:tp});t.createIndex(ty,tw,{unique:!1}),t.createIndex(tv,tI,{unique:!1})}(e)})),r<13&&n>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore(eQ,{keyPath:eW});t.createIndex(eH,eJ),t.createIndex(eY,eX)})(e)).next(()=>this.Ci(e,i)).next(()=>e.deleteObjectStore(eF))),r<14&&n>=14&&(s=s.next(()=>this.Fi(e,i))),r<15&&n>=15&&(s=s.next(()=>{e.createObjectStore(ts,{keyPath:"indexId",autoIncrement:!0}).createIndex(ta,"collectionGroup",{unique:!1}),e.createObjectStore(to,{keyPath:tl}).createIndex(tu,th,{unique:!1}),e.createObjectStore(tc,{keyPath:td}).createIndex(tf,tm,{unique:!1})})),r<16&&n>=16&&(s=s.next(()=>{t.objectStore(to).clear()}).next(()=>{t.objectStore(tc).clear()})),r<17&&n>=17&&(s=s.next(()=>{!function(e){e.createObjectStore(tT,{keyPath:"name"})}(e)})),r<18&&n>=18&&(0,h.Ov)()&&(s=s.next(()=>{t.objectStore(to).clear()}).next(()=>{t.objectStore(tc).clear()})),s}wi(e){let t=0;return e.store(eF).ee((e,r)=>{t+=se(r)}).next(()=>{let r={byteSize:t};return e.store(eZ).put(e0,r)})}yi(e){let t=e.store(eq),r=e.store(eB);return t.J().next(t=>ep.forEach(t,t=>{let n=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return r.J(eK,n).next(r=>ep.forEach(r,r=>{N(r.userId===t.userId,18650,"Cannot process batch from unexpected user",{batchId:r.batchId});let n=iN(this.serializer,r);return i7(e,t.userId,n).next(()=>{})}))}))}Si(e){let t=e.store(e4),r=e.store(eF);return e.store(e7).get(e9).next(e=>{let n=[];return r.ee((r,i)=>{let s=new j(r),a=[0,eO(s)];n.push(t.get(a).next(r=>r?ep.resolve():t.put({targetId:0,path:eO(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>ep.waitFor(n))})}bi(e,t){e.createObjectStore(te,{keyPath:tt});let r=t.store(te),n=new i2,i=e=>{if(n.add(e)){let t=e.lastSegment(),n=e.popLast();return r.put({collectionId:t,parent:eO(n)})}};return t.store(eF).ee({X:!0},(e,t)=>i(new j(e).popLast())).next(()=>t.store(ej).ee({X:!0},([e,t,r],n)=>i(eP(t).popLast())))}Di(e){let t=e.store(e1);return t.ee((e,r)=>{let n=iD(r),i=iC(this.serializer,n);return t.put(i)})}Ci(e,t){let r=t.store(eF),n=[];return r.ee((e,r)=>{let i=t.store(eQ),s=(r.document?new H(j.fromString(r.document.name).popFirst(5)):r.noDocument?H.fromSegments(r.noDocument.path):r.unknownDocument?H.fromSegments(r.unknownDocument.path):S(36783)).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:r.readTime||[0,0],unknownDocument:r.unknownDocument,noDocument:r.noDocument,document:r.document,hasCommittedMutations:!!r.hasCommittedMutations};n.push(i.put(a))}).next(()=>ep.waitFor(n))}Fi(e,t){let r=t.store(eB),n=new sg(this.serializer),i=new sA(sR.mi,this.serializer.yt);return r.J().next(e=>{let r=new Map;return e.forEach(e=>{let t=r.get(e.userId)??ns();iN(this.serializer,e).keys().forEach(e=>t=t.add(e)),r.set(e.userId,t)}),ep.forEach(r,(e,r)=>{let s=new y(r),a=iO.wt(this.serializer,s),o=i.getIndexManager(s);return new sT(n,st.wt(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new tN(t,eA.ce),e).next()})})}}function sP(e){e.createObjectStore(e4,{keyPath:e3}).createIndex(e6,e8,{unique:!0}),e.createObjectStore(e1,{keyPath:"targetId"}).createIndex(e2,e5,{unique:!0}),e.createObjectStore(e7)}let sF="IndexedDbPersistence",sL="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class sU{constructor(e,t,r,n,i,s,a,o,l,u,h=18){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=r,this.Mi=i,this.window=s,this.document=a,this.xi=l,this.Oi=u,this.Ni=h,this.ci=null,this.li=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Bi=null,this.inForeground=!1,this.Li=null,this.ki=null,this.qi=Number.NEGATIVE_INFINITY,this.Qi=e=>Promise.resolve(),!sU.v())throw new C(D.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new sd(this,n),this.$i=t+"main",this.serializer=new ib(o),this.Ui=new ev(this.$i,this.Ni,new sO(this.serializer)),this.hi=new iP,this.Pi=new ss(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new sg(this.serializer),this.Ii=new iM,this.window&&this.window.localStorage?this.Ki=this.window.localStorage:(this.Ki=null,!1===u&&b(sF,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Wi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new C(D.FAILED_PRECONDITION,sL);return this.Gi(),this.zi(),this.ji(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Pi.getHighestSequenceNumber(e))}).then(e=>{this.ci=new eA(e,this.xi)}).then(()=>{this.li=!0}).catch(e=>(this.Ui&&this.Ui.close(),Promise.reject(e)))}Ji(e){return this.Qi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ui.$(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Mi.enqueueAndForget(async()=>{this.started&&await this.Wi()}))}Wi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>tD(e,tr).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Hi(e).next(e=>{e||(this.isPrimary=!1,this.Mi.enqueueRetryable(()=>this.Qi(!1)))})}).next(()=>this.Yi(e)).next(t=>this.isPrimary&&!t?this.Zi(e).next(()=>!1):!!t&&this.Xi(e).next(()=>!0))).catch(e=>{if(eE(e))return T(sF,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return T(sF,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Mi.enqueueRetryable(()=>this.Qi(e)),this.isPrimary=e})}Hi(e){return tD(e,eL).get(eU).next(e=>ep.resolve(this.es(e)))}ts(e){return tD(e,tr).delete(this.clientId)}async ns(){if(this.isPrimary&&!this.rs(this.qi,18e5)){this.qi=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=tD(e,tr);return t.J().next(e=>{let r=this.ss(e,18e5),n=e.filter(e=>-1===r.indexOf(e));return ep.forEach(n,e=>t.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ki)for(let t of e)this.Ki.removeItem(this._s(t.clientId))}}ji(){this.ki=this.Mi.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Wi().then(()=>this.ns()).then(()=>this.ji()))}es(e){return!!e&&e.ownerId===this.clientId}Yi(e){return this.Oi?ep.resolve(!0):tD(e,eL).get(eU).next(t=>{if(null!==t&&this.rs(t.leaseTimestampMs,5e3)&&!this.us(t.ownerId)){if(this.es(t)&&this.networkEnabled)return!0;if(!this.es(t)){if(!t.allowTabSynchronization)throw new C(D.FAILED_PRECONDITION,sL);return!1}}return!(!this.networkEnabled||!this.inForeground)||tD(e,tr).J().next(e=>void 0===this.ss(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,r=!this.inForeground&&e.inForeground,n=this.networkEnabled===e.networkEnabled;if(t||r&&n)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&T(sF,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.li=!1,this.cs(),this.ki&&(this.ki.cancel(),this.ki=null),this.ls(),this.hs(),await this.Ui.runTransaction("shutdown","readwrite",[eL,tr],e=>{let t=new tN(e,eA.ce);return this.Zi(t).next(()=>this.ts(t))}),this.Ui.close(),this.Ps()}ss(e,t){return e.filter(e=>this.rs(e.updateTimeMs,t)&&!this.us(e.clientId))}Ts(){return this.runTransaction("getActiveClients","readonly",e=>tD(e,tr).J().next(e=>this.ss(e,18e5).map(e=>e.clientId)))}get started(){return this.li}getGlobalsCache(){return this.hi}getMutationQueue(e,t){return st.wt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Pi}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new i3(e,this.serializer.yt.databaseId)}getDocumentOverlayCache(e){return iO.wt(this.serializer,e)}getBundleCache(){return this.Ii}runTransaction(e,t,r){var n;let i;T(sF,"Starting transaction:",e);let s=18===(n=this.Ni)?tx:17===n?tx:16===n?tS:15===n?tS:14===n?t_:13===n?t_:12===n?tE:11===n?tb:void S(60245);return this.Ui.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,n=>(i=new tN(n,this.ci?this.ci.next():eA.ce),"readwrite-primary"===t?this.Hi(i).next(e=>!!e||this.Yi(i)).next(t=>{if(!t)throw b(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Mi.enqueueRetryable(()=>this.Qi(!1)),new C(D.FAILED_PRECONDITION,ef);return r(i)}).next(e=>this.Xi(i).next(()=>e)):this.Is(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Is(e){return tD(e,eL).get(eU).next(e=>{if(null!==e&&this.rs(e.leaseTimestampMs,5e3)&&!this.us(e.ownerId)&&!this.es(e)&&!(this.Oi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new C(D.FAILED_PRECONDITION,sL)})}Xi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tD(e,eL).put(eU,t)}static v(){return ev.v()}Zi(e){let t=tD(e,eL);return t.get(eU).next(e=>this.es(e)?(T(sF,"Releasing primary lease."),t.delete(eU)):ep.resolve())}rs(e,t){let r=Date.now();return!(e<r-t)&&(!(e>r)||(b(`Detected an update time that is in the future: ${e} > ${r}`),!1))}Gi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Li=()=>{this.Mi.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Wi()))},this.document.addEventListener("visibilitychange",this.Li),this.inForeground="visible"===this.document.visibilityState)}ls(){this.Li&&(this.document.removeEventListener("visibilitychange",this.Li),this.Li=null)}zi(){"function"==typeof this.window?.addEventListener&&(this.Bi=()=>{this.cs();let e=/(?:Version|Mobile)\/1[456]/;(0,h.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Mi.enterRestrictedMode(!0),this.Mi.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Bi))}hs(){this.Bi&&(this.window.removeEventListener("pagehide",this.Bi),this.Bi=null)}us(e){try{let t=null!==this.Ki?.getItem(this._s(e));return T(sF,`Client '${e}' ${t?"is":"is not"} zombied in LocalStorage`),t}catch(e){return b(sF,"Failed to get zombied client id.",e),!1}}cs(){if(this.Ki)try{this.Ki.setItem(this._s(this.clientId),String(Date.now()))}catch(e){b("Failed to set zombie client id.",e)}}Ps(){if(this.Ki)try{this.Ki.removeItem(this._s(this.clientId))}catch(e){}}_s(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function sq(e,t){let r=e.projectId;return e.isDefaultDatabase||(r+="."+e.database),"firestore/"+t+"/"+r+"/"}class sB{constructor(e,t,r,n){this.targetId=e,this.fromCache=t,this.Es=r,this.ds=n}static As(e,t){let r=ns(),n=ns();for(let e of t.docChanges)switch(e.type){case 0:r=r.add(e.doc.key);break;case 1:n=n.add(e.doc.key)}return new sB(e,t.fromCache,r,n)}}class sz{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class sK{constructor(){this.Rs=!1,this.Vs=!1,this.fs=100,this.gs=(0,h.nr)()?8:eI((0,h.ZQ)())>0?6:4}initialize(e,t){this.ps=e,this.indexManager=t,this.Rs=!0}getDocumentsMatchingQuery(e,t,r,n){let i={result:null};return this.ys(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ws(e,t,n,r).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let r=new sz;return this.Ss(e,t,r).next(n=>{if(i.result=n,this.Vs)return this.bs(e,t,r,n.size)})}).next(()=>i.result)}bs(e,t,r,n){return r.documentReadCount<this.fs?(I()<=u.$b.DEBUG&&T("QueryEngine","SDK will not create cache indexes for query:",r5(t),"since it only creates cache indexes for collection contains","more than or equal to",this.fs,"documents"),ep.resolve()):(I()<=u.$b.DEBUG&&T("QueryEngine","Query:",r5(t),"scans",r.documentReadCount,"local documents and returns",n,"documents as results."),r.documentReadCount>this.gs*n?(I()<=u.$b.DEBUG&&T("QueryEngine","The SDK decides to create cache indexes for query:",r5(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,rY(t))):ep.resolve())}ys(e,t){if(rW(t))return ep.resolve(null);let r=rY(t);return this.indexManager.getIndexType(e,r).next(n=>0===n?null:(null!==t.limit&&1===n&&(r=rY(t=r0(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,r).next(n=>{let i=ns(...n);return this.ps.getDocuments(e,i).next(n=>this.indexManager.getMinOffset(e,r).next(r=>{let s=this.Ds(t,n);return this.Cs(t,s,i,r.readTime)?this.ys(e,r0(t,null,"F")):this.vs(e,s,t,r)}))})))}ws(e,t,r,n){return rW(t)||n.isEqual(en.min())?ep.resolve(null):this.ps.getDocuments(e,r).next(i=>{let s=this.Ds(t,i);return this.Cs(t,s,r,n)?ep.resolve(null):(I()<=u.$b.DEBUG&&T("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),r5(t)),this.vs(e,s,t,eu(n,-1)).next(e=>e))})}Ds(e,t){let r=new tO(r6(e));return t.forEach((t,n)=>{r4(e,n)&&(r=r.add(n))}),r}Cs(e,t,r,n){if(null===e.limit)return!1;if(r.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(n)>0)}Ss(e,t,r){return I()<=u.$b.DEBUG&&T("QueryEngine","Using full collection scan to execute query:",r5(t)),this.ps.getDocumentsMatchingQuery(e,t,ec.min(),r)}vs(e,t,r,n){return this.ps.getDocumentsMatchingQuery(e,r,n).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}let s$="LocalStore";class sG{constructor(e,t,r,n){this.persistence=e,this.Fs=t,this.serializer=n,this.Ms=new tV(q),this.xs=new r8(e=>rq(e),rB),this.Os=new Map,this.Ns=e.getRemoteDocumentCache(),this.Pi=e.getTargetCache(),this.Ii=e.getBundleCache(),this.Bs(r)}Bs(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new sT(this.Ns,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ns.setIndexManager(this.indexManager),this.Fs.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ms))}}async function sj(e,t){return await e.persistence.runTransaction("Handle user change","readonly",r=>{let n;return e.mutationQueue.getAllMutationBatches(r).next(i=>(n=i,e.Bs(t),e.mutationQueue.getAllMutationBatches(r))).next(t=>{let i=[],s=[],a=ns();for(let e of n)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(r,a).next(e=>({Ls:e,removedBatchIds:i,addedBatchIds:s}))})})}function sQ(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Pi.getLastRemoteSnapshotVersion(t))}function sW(e,t,r){let n=ns(),i=ns();return r.forEach(e=>n=n.add(e)),t.getEntries(e,n).next(e=>{let n=r9;return r.forEach((r,s)=>{let a=e.get(r);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(r)),s.isNoDocument()&&s.version.isEqual(en.min())?(t.removeEntry(r,s.readTime),n=n.insert(r,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),n=n.insert(r,s)):T(s$,"Ignoring outdated watch update for ",r,". Current version:",a.version," Watch version:",s.version)}),{ks:n,qs:i}})}function sH(e,t){return e.persistence.runTransaction("Allocate target","readwrite",r=>{let n;return e.Pi.getTargetData(r,t).next(i=>i?(n=i,ep.resolve(n)):e.Pi.allocateTargetId(r).next(i=>(n=new iT(t,i,"TargetPurposeListen",r.currentSequenceNumber),e.Pi.addTargetData(r,n).next(()=>n))))}).then(r=>{let n=e.Ms.get(r.targetId);return(null===n||r.snapshotVersion.compareTo(n.snapshotVersion)>0)&&(e.Ms=e.Ms.insert(r.targetId,r),e.xs.set(t,r.targetId)),r})}async function sJ(e,t,r){let n=e.Ms.get(t);try{r||await e.persistence.runTransaction("Release target",r?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,n))}catch(e){if(!eE(e))throw e;T(s$,`Failed to update sequence numbers for target ${t}: ${e}`)}e.Ms=e.Ms.remove(t),e.xs.delete(n.target)}function sY(e,t,r){let n=en.min(),i=ns();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,r){let n=e.xs.get(r);return void 0!==n?ep.resolve(e.Ms.get(n)):e.Pi.getTargetData(t,r)})(e,s,rY(t)).next(t=>{if(t)return n=t.lastLimboFreeSnapshotVersion,e.Pi.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.Fs.getDocumentsMatchingQuery(s,t,r?n:en.min(),r?i:ns())).next(r=>(s0(e,r3(t),r),{documents:r,Qs:i})))}function sX(e,t){let r=e.Pi,n=e.Ms.get(t);return n?Promise.resolve(n.target):e.persistence.runTransaction("Get target data","readonly",e=>r.At(e,t).next(e=>e?e.target:null))}function sZ(e,t){let r=e.Os.get(t)||en.min();return e.persistence.runTransaction("Get new document changes","readonly",n=>e.Ns.getAllFromCollectionGroup(n,t,eu(r,-1),Number.MAX_SAFE_INTEGER)).then(r=>(s0(e,t,r),r))}function s0(e,t,r){let n=e.Os.get(t)||en.min();r.forEach((e,t)=>{t.readTime.compareTo(n)>0&&(n=t.readTime)}),e.Os.set(t,n)}async function s1(e,t,r,n){let i=ns(),s=r9;for(let e of r){let r=t.$s(e.metadata.name);e.document&&(i=i.add(r));let n=t.Us(e);n.setReadTime(t.Ks(e.metadata.readTime)),s=s.insert(r,n)}let a=e.Ns.newChangeBuffer({trackRemovals:!0}),o=await sH(e,rY(rQ(j.fromString(`__bundle__/docs/${n}`))));return e.persistence.runTransaction("Apply bundle documents","readwrite",t=>sW(t,a,s).next(e=>(a.apply(t),e)).next(r=>e.Pi.removeMatchingKeysForTargetId(t,o.targetId).next(()=>e.Pi.addMatchingKeys(t,i,o.targetId)).next(()=>e.localDocuments.getLocalViewOfDocuments(t,r.ks,r.qs)).next(()=>r.ks)))}async function s2(e,t,r=ns()){let n=await sH(e,rY(ik(t.bundledQuery)));return e.persistence.runTransaction("Save named query","readwrite",i=>{let s=n7(t.readTime);if(n.snapshotVersion.compareTo(s)>=0)return e.Ii.saveNamedQuery(i,t);let a=n.withResumeToken(tq.EMPTY_BYTE_STRING,s);return e.Ms=e.Ms.insert(a.targetId,a),e.Pi.updateTargetData(i,a).next(()=>e.Pi.removeMatchingKeysForTargetId(i,n.targetId)).next(()=>e.Pi.addMatchingKeys(i,r,n.targetId)).next(()=>e.Ii.saveNamedQuery(i,t))})}let s5="firestore_clients";function s4(e,t){return`${s5}_${e}_${t}`}let s3="firestore_mutations";function s6(e,t,r){let n=`${s3}_${e}_${r}`;return t.isAuthenticated()&&(n+=`_${t.uid}`),n}let s8="firestore_targets";function s9(e,t){return`${s8}_${e}_${t}`}let s7="SharedClientState";class ae{constructor(e,t,r,n){this.user=e,this.batchId=t,this.state=r,this.error=n}static Ws(e,t,r){let n=JSON.parse(r),i,s="object"==typeof n&&-1!==["pending","acknowledged","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(i=new C(n.error.code,n.error.message)),s?new ae(e,t,n.state,i):(b(s7,`Failed to parse mutation state for ID '${t}': ${r}`),null)}Gs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class at{constructor(e,t,r){this.targetId=e,this.state=t,this.error=r}static Ws(e,t){let r=JSON.parse(t),n,i="object"==typeof r&&-1!==["not-current","current","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(n=new C(r.error.code,r.error.message)),i?new at(e,r.state,n):(b(s7,`Failed to parse target state for ID '${e}': ${t}`),null)}Gs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ar{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ws(e,t){let r=JSON.parse(t),n="object"==typeof r&&r.activeTargetIds instanceof Array,i=na;for(let e=0;n&&e<r.activeTargetIds.length;++e)n=eM(r.activeTargetIds[e]),i=i.add(r.activeTargetIds[e]);return n?new ar(e,i):(b(s7,`Failed to parse client data for instance '${e}': ${t}`),null)}}class an{constructor(e,t){this.clientId=e,this.onlineState=t}static Ws(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new an(t.clientId,t.onlineState):(b(s7,`Failed to parse online state: ${e}`),null)}}class ai{constructor(){this.activeTargetIds=na}zs(e){this.activeTargetIds=this.activeTargetIds.add(e)}js(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Gs(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class as{constructor(e,t,r,n,i){var s,a,o;this.window=e,this.Mi=t,this.persistenceKey=r,this.Js=n,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Hs=this.Ys.bind(this),this.Zs=new tV(q),this.started=!1,this.Xs=[];let l=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.eo=s4(this.persistenceKey,this.Js),this.no=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.Zs=this.Zs.insert(this.Js,new ai),this.ro=RegExp(`^${s5}_${l}_([^_]*)$`),this.io=RegExp(`^${s3}_${l}_(\\d+)(?:_(.*))?$`),this.so=RegExp(`^${s8}_${l}_(\\d+)$`),this.oo=(a=this.persistenceKey,`firestore_online_state_${a}`),this._o=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.Hs)}static v(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.Ts())){if(e===this.Js)continue;let t=this.getItem(s4(this.persistenceKey,e));if(t){let r=ar.Ws(e,t);r&&(this.Zs=this.Zs.insert(r.clientId,r))}}this.ao();let e=this.storage.getItem(this.oo);if(e){let t=this.uo(e);t&&this.co(t)}for(let e of this.Xs)this.Ys(e);this.Xs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.no,JSON.stringify(e))}getAllActiveQueryTargets(){return this.lo(this.Zs)}isActiveQueryTarget(e){let t=!1;return this.Zs.forEach((r,n)=>{n.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.ho(e,"pending")}updateMutationState(e,t,r){this.ho(e,t,r),this.Po(e)}addLocalQueryTarget(e,t=!0){let r="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(s9(this.persistenceKey,e));if(t){let n=at.Ws(e,t);n&&(r=n.state)}}return t&&this.To.zs(e),this.ao(),r}removeLocalQueryTarget(e){this.To.js(e),this.ao()}isLocalQueryTarget(e){return this.To.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(s9(this.persistenceKey,e))}updateQueryState(e,t,r){this.Io(e,t,r)}handleUserChange(e,t,r){t.forEach(e=>{this.Po(e)}),this.currentUser=e,r.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Eo(e)}notifyBundleLoaded(e){this.Ao(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Hs),this.removeItem(this.eo),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return T(s7,"READ",e,t),t}setItem(e,t){T(s7,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){T(s7,"REMOVE",e),this.storage.removeItem(e)}Ys(e){if(e.storageArea===this.storage){if(T(s7,"EVENT",e.key,e.newValue),e.key===this.eo)return void b("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Mi.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.ro.test(e.key)){if(null==e.newValue){let t=this.Ro(e.key);return this.Vo(t,null)}{let t=this.mo(e.key,e.newValue);if(t)return this.Vo(t.clientId,t)}}else if(this.io.test(e.key)){if(null!==e.newValue){let t=this.fo(e.key,e.newValue);if(t)return this.po(t)}}else if(this.so.test(e.key)){if(null!==e.newValue){let t=this.yo(e.key,e.newValue);if(t)return this.wo(t)}}else if(e.key===this.oo){if(null!==e.newValue){let t=this.uo(e.newValue);if(t)return this.co(t)}}else if(e.key===this.no){let t=function(e){let t=eA.ce;if(null!=e)try{let r=JSON.parse(e);N("number"==typeof r,30636,{So:e}),t=r}catch(e){b(s7,"Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==eA.ce&&this.sequenceNumberHandler(t)}else if(e.key===this._o){let t=this.bo(e.newValue);await Promise.all(t.map(e=>this.syncEngine.Do(e)))}}}else this.Xs.push(e)})}}get To(){return this.Zs.get(this.Js)}ao(){this.setItem(this.eo,this.To.Gs())}ho(e,t,r){let n=new ae(this.currentUser,e,t,r),i=s6(this.persistenceKey,this.currentUser,e);this.setItem(i,n.Gs())}Po(e){let t=s6(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Eo(e){let t={clientId:this.Js,onlineState:e};this.storage.setItem(this.oo,JSON.stringify(t))}Io(e,t,r){let n=s9(this.persistenceKey,e),i=new at(e,t,r);this.setItem(n,i.Gs())}Ao(e){let t=JSON.stringify(Array.from(e));this.setItem(this._o,t)}Ro(e){let t=this.ro.exec(e);return t?t[1]:null}mo(e,t){let r=this.Ro(e);return ar.Ws(r,t)}fo(e,t){let r=this.io.exec(e),n=Number(r[1]),i=void 0!==r[2]?r[2]:null;return ae.Ws(new y(i),n,t)}yo(e,t){let r=Number(this.so.exec(e)[1]);return at.Ws(r,t)}uo(e){return an.Ws(e)}bo(e){return JSON.parse(e)}async po(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Co(e.batchId,e.state,e.error);T(s7,`Ignoring mutation for non-active user ${e.user.uid}`)}wo(e){return this.syncEngine.vo(e.targetId,e.state,e.error)}Vo(e,t){let r=t?this.Zs.insert(e,t):this.Zs.remove(e),n=this.lo(this.Zs),i=this.lo(r),s=[],a=[];return i.forEach(e=>{n.has(e)||s.push(e)}),n.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.Fo(s,a).then(()=>{this.Zs=r})}co(e){this.Zs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}lo(e){let t=na;return e.forEach((e,r)=>{t=t.unionWith(r.activeTargetIds)}),t}}class aa{constructor(){this.Mo=new ai,this.xo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,r){}addLocalQueryTarget(e,t=!0){return t&&this.Mo.zs(e),this.xo[e]||"not-current"}updateQueryState(e,t,r){this.xo[e]=t}removeLocalQueryTarget(e){this.Mo.js(e)}isLocalQueryTarget(e){return this.Mo.activeTargetIds.has(e)}clearQueryState(e){delete this.xo[e]}getAllActiveQueryTargets(){return this.Mo.activeTargetIds}isActiveQueryTarget(e){return this.Mo.activeTargetIds.has(e)}start(){return this.Mo=new ai,Promise.resolve()}handleUserChange(e,t,r){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class ao{Oo(e){}shutdown(){}}let al="ConnectivityMonitor";class au{constructor(){this.No=()=>this.Bo(),this.Lo=()=>this.ko(),this.qo=[],this.Qo()}Oo(e){this.qo.push(e)}shutdown(){window.removeEventListener("online",this.No),window.removeEventListener("offline",this.Lo)}Qo(){window.addEventListener("online",this.No),window.addEventListener("offline",this.Lo)}Bo(){for(let e of(T(al,"Network connectivity changed: AVAILABLE"),this.qo))e(0)}ko(){for(let e of(T(al,"Network connectivity changed: UNAVAILABLE"),this.qo))e(1)}static v(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let ah=null;function ac(){return null===ah?ah=0x10000000+Math.round(0x80000000*Math.random()):ah++,"0x"+ah.toString(16)}let ad="RestConnection",af={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class am{get $o(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",r=encodeURIComponent(this.databaseId.projectId),n=encodeURIComponent(this.databaseId.database);this.Uo=t+"://"+e.host,this.Ko=`projects/${r}/databases/${n}`,this.Wo=this.databaseId.database===tZ?`project_id=${r}`:`project_id=${r}&database_id=${n}`}Go(e,t,r,n,i){let s=ac(),a=this.zo(e,t.toUriEncodedString());T(ad,`Sending RPC '${e}' ${s}:`,a,r);let o={"google-cloud-resource-prefix":this.Ko,"x-goog-request-params":this.Wo};this.jo(o,n,i);let{host:l}=new URL(a),u=(0,h.zJ)(l);return this.Jo(e,a,o,r,u).then(t=>(T(ad,`Received RPC '${e}' ${s}: `,t),t),t=>{throw E(ad,`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",r),t})}Ho(e,t,r,n,i,s){return this.Go(e,t,r,n,i)}jo(e,t,r){e["X-Goog-Api-Client"]="gl-js/ fire/"+w,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,r)=>e[r]=t),r&&r.headers.forEach((t,r)=>e[r]=t)}zo(e,t){let r=af[e];return`${this.Uo}/v1/${t}:${r}`}terminate(){}}class ag{constructor(e){this.Yo=e.Yo,this.Zo=e.Zo}Xo(e){this.e_=e}t_(e){this.n_=e}r_(e){this.i_=e}onMessage(e){this.s_=e}close(){this.Zo()}send(e){this.Yo(e)}o_(){this.e_()}__(){this.n_()}a_(e){this.i_(e)}u_(e){this.s_(e)}}let ap="WebChannelConnection";class ay extends am{constructor(e){super(e),this.c_=[],this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Jo(e,t,r,n,i){let s=ac();return new Promise((i,a)=>{let o=new d.ZS;o.setWithCredentials(!0),o.listenOnce(d.Bx.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case d.O4.NO_ERROR:let t=o.getResponseJson();T(ap,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case d.O4.TIMEOUT:T(ap,`RPC '${e}' ${s} timed out`),a(new C(D.DEADLINE_EXCEEDED,"Request time out"));break;case d.O4.HTTP_ERROR:let r=o.getStatus();if(T(ap,`RPC '${e}' ${s} failed with status:`,r,"response text:",o.getResponseText()),r>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=e?.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(D).indexOf(t)>=0?t:D.UNKNOWN}(t.status);a(new C(e,t.message))}else a(new C(D.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new C(D.UNAVAILABLE,"Connection failed."));break;default:S(9055,{l_:e,streamId:s,h_:o.getLastErrorCode(),P_:o.getLastError()})}}finally{T(ap,`RPC '${e}' ${s} completed.`)}});let l=JSON.stringify(n);T(ap,`RPC '${e}' ${s} sending request:`,n),o.send(t,"POST",l,r,15)})}T_(e,t,r){let i=ac(),s=[this.Uo,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=(0,d.fF)(),o=(0,d.Ao)(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.jo(l.initMessageHeaders,t,r),l.encodeInitMessageHeaders=!0;let h=s.join("");T(ap,`Creating RPC '${e}' stream ${i}: ${h}`,l);let c=a.createWebChannel(h,l);this.I_(c);let f=!1,m=!1,g=new ag({Yo:t=>{m?T(ap,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(f||(T(ap,`Opening RPC '${e}' stream ${i} transport.`),c.open(),f=!0),T(ap,`RPC '${e}' stream ${i} sending:`,t),c.send(t))},Zo:()=>c.close()}),p=(e,t,r)=>{e.listen(t,e=>{try{r(e)}catch(e){setTimeout(()=>{throw e},0)}})};return p(c,d.iO.EventType.OPEN,()=>{m||(T(ap,`RPC '${e}' stream ${i} transport opened.`),g.o_())}),p(c,d.iO.EventType.CLOSE,()=>{m||(m=!0,T(ap,`RPC '${e}' stream ${i} transport closed`),g.a_(),this.E_(c))}),p(c,d.iO.EventType.ERROR,t=>{m||(m=!0,E(ap,`RPC '${e}' stream ${i} transport errored. Name:`,t.name,"Message:",t.message),g.a_(new C(D.UNAVAILABLE,"The operation could not be completed")))}),p(c,d.iO.EventType.MESSAGE,t=>{if(!m){let r=t.data[0];N(!!r,16349);let s=r?.error||r[0]?.error;if(s){T(ap,`RPC '${e}' stream ${i} received error:`,s);let t=s.status,r=function(e){let t=n[e];if(void 0!==t)return nq(t)}(t),a=s.message;void 0===r&&(r=D.INTERNAL,a="Unknown error status: "+t+" with message "+s.message),m=!0,g.a_(new C(r,a)),c.close()}else T(ap,`RPC '${e}' stream ${i} received:`,r),g.u_(r)}}),p(o,d.Jh.STAT_EVENT,t=>{t.stat===d.ro.PROXY?T(ap,`RPC '${e}' stream ${i} detected buffering proxy`):t.stat===d.ro.NOPROXY&&T(ap,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{g.__()},0),g}terminate(){this.c_.forEach(e=>e.close()),this.c_=[]}I_(e){this.c_.push(e)}E_(e){this.c_=this.c_.filter(t=>t===e)}}function aw(){return"undefined"!=typeof window?window:null}function av(){return"undefined"!=typeof document?document:null}function aI(e){return new n3(e,!0)}class aT{constructor(e,t,r=1e3,n=1.5,i=6e4){this.Mi=e,this.timerId=t,this.d_=r,this.A_=n,this.R_=i,this.V_=0,this.m_=null,this.f_=Date.now(),this.reset()}reset(){this.V_=0}g_(){this.V_=this.R_}p_(e){this.cancel();let t=Math.floor(this.V_+this.y_()),r=Math.max(0,Date.now()-this.f_),n=Math.max(0,t-r);n>0&&T("ExponentialBackoff",`Backing off for ${n} ms (base delay: ${this.V_} ms, delay with jitter: ${t} ms, last attempt: ${r} ms ago)`),this.m_=this.Mi.enqueueAfterDelay(this.timerId,n,()=>(this.f_=Date.now(),e())),this.V_*=this.A_,this.V_<this.d_&&(this.V_=this.d_),this.V_>this.R_&&(this.V_=this.R_)}w_(){null!==this.m_&&(this.m_.skipDelay(),this.m_=null)}cancel(){null!==this.m_&&(this.m_.cancel(),this.m_=null)}y_(){return(Math.random()-.5)*this.V_}}let ab="PersistentStream";class aE{constructor(e,t,r,n,i,s,a,o){this.Mi=e,this.S_=r,this.b_=n,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.D_=0,this.C_=null,this.v_=null,this.stream=null,this.F_=0,this.M_=new aT(e,t)}x_(){return 1===this.state||5===this.state||this.O_()}O_(){return 2===this.state||3===this.state}start(){this.F_=0,4!==this.state?this.auth():this.N_()}async stop(){this.x_()&&await this.close(0)}B_(){this.state=0,this.M_.reset()}L_(){this.O_()&&null===this.C_&&(this.C_=this.Mi.enqueueAfterDelay(this.S_,6e4,()=>this.k_()))}q_(e){this.Q_(),this.stream.send(e)}async k_(){if(this.O_())return this.close(0)}Q_(){this.C_&&(this.C_.cancel(),this.C_=null)}U_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(e,t){this.Q_(),this.U_(),this.M_.cancel(),this.D_++,4!==e?this.M_.reset():t&&t.code===D.RESOURCE_EXHAUSTED?(b(t.toString()),b("Using maximum backoff delay to prevent overloading the backend."),this.M_.g_()):t&&t.code===D.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.K_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.r_(t)}K_(){}auth(){this.state=1;let e=this.W_(this.D_),t=this.D_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,r])=>{this.D_===t&&this.G_(e,r)},t=>{e(()=>{let e=new C(D.UNKNOWN,"Fetching auth token failed: "+t.message);return this.z_(e)})})}G_(e,t){let r=this.W_(this.D_);this.stream=this.j_(e,t),this.stream.Xo(()=>{r(()=>this.listener.Xo())}),this.stream.t_(()=>{r(()=>(this.state=2,this.v_=this.Mi.enqueueAfterDelay(this.b_,1e4,()=>(this.O_()&&(this.state=3),Promise.resolve())),this.listener.t_()))}),this.stream.r_(e=>{r(()=>this.z_(e))}),this.stream.onMessage(e=>{r(()=>1==++this.F_?this.J_(e):this.onNext(e))})}N_(){this.state=5,this.M_.p_(async()=>{this.state=0,this.start()})}z_(e){return T(ab,`close with error: ${e}`),this.stream=null,this.close(4,e)}W_(e){return t=>{this.Mi.enqueueAndForget(()=>this.D_===e?t():(T(ab,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class a_ extends aE{constructor(e,t,r,n,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,r,n,s),this.serializer=i}j_(e,t){return this.connection.T_("Listen",e,t)}J_(e){return this.onNext(e)}onNext(e){this.M_.reset();let t=function(e,t){let r;if("targetChange"in t){var n,i;t.targetChange;let s="NO_CHANGE"===(n=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===n?1:"REMOVE"===n?2:"CURRENT"===n?3:"RESET"===n?4:S(39313,{state:n}),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(N(void 0===i||"string"==typeof i,58123),tq.fromBase64String(i||"")):(N(void 0===i||i instanceof m||i instanceof Uint8Array,16193),tq.fromUint8Array(i||new Uint8Array))),l=t.targetChange.cause;r=new nY(s,a,o,l&&new C(void 0===l.code?D.UNKNOWN:nq(l.code),l.message||"")||null)}else if("documentChange"in t){t.documentChange;let n=t.documentChange;n.document,n.document.name,n.document.updateTime;let i=is(e,n.document.name),s=n7(n.document.updateTime),a=n.document.createTime?n7(n.document.createTime):en.min(),o=new rp({mapValue:{fields:n.document.fields}}),l=ry.newFoundDocument(i,s,a,o);r=new nH(n.targetIds||[],n.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let n=t.documentDelete;n.document;let i=is(e,n.document),s=n.readTime?n7(n.readTime):en.min(),a=ry.newNoDocument(i,s);r=new nH([],n.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let n=t.documentRemove;n.document;let i=is(e,n.document);r=new nH([],n.removedTargetIds||[],i,null)}else{if(!("filter"in t))return S(11601,{Rt:t});{t.filter;let e=t.filter;e.targetId;let{count:n=0,unchangedNames:i}=e,s=new nL(n,i);r=new nJ(e.targetId,s)}}return r}(this.serializer,e),r=function(e){if(!("targetChange"in e))return en.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?en.min():t.readTime?n7(t.readTime):en.min()}(e);return this.listener.H_(t,r)}Y_(e){let t={};t.database=il(this.serializer),t.addTarget=function(e,t){let r;let n=t.target;if((r=rz(n)?{documents:ig(e,n)}:{query:ip(e,n).ft}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){r.resumeToken=n9(e,t.resumeToken);let n=n6(e,t.expectedCount);null!==n&&(r.expectedCount=n)}else if(t.snapshotVersion.compareTo(en.min())>0){r.readTime=n8(e,t.snapshotVersion.toTimestamp());let n=n6(e,t.expectedCount);null!==n&&(r.expectedCount=n)}return r}(this.serializer,e);let r=function(e,t){let r=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return S(28987,{purpose:e})}}(t.purpose);return null==r?null:{"goog-listen-tags":r}}(this.serializer,e);r&&(t.labels=r),this.q_(t)}Z_(e){let t={};t.database=il(this.serializer),t.removeTarget=e,this.q_(t)}}class aS extends aE{constructor(e,t,r,n,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,r,n,s),this.serializer=i}get X_(){return this.F_>0}start(){this.lastStreamToken=void 0,super.start()}K_(){this.X_&&this.ea([])}j_(e,t){return this.connection.T_("Write",e,t)}J_(e){return N(!!e.streamToken,31322),this.lastStreamToken=e.streamToken,N(!e.writeResults||0===e.writeResults.length,55816),this.listener.ta()}onNext(e){var t,r;N(!!e.streamToken,12678),this.lastStreamToken=e.streamToken,this.M_.reset();let n=(t=e.writeResults,r=e.commitTime,t&&t.length>0?(N(void 0!==r,14353),t.map(e=>{let t;return(t=e.updateTime?n7(e.updateTime):n7(r)).isEqual(en.min())&&(t=n7(r)),new nT(t,e.transformResults||[])})):[]),i=n7(e.commitTime);return this.listener.na(i,n)}ra(){let e={};e.database=il(this.serializer),this.q_(e)}ea(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>id(this.serializer,e))};this.q_(t)}}class ax{}class aN extends ax{constructor(e,t,r,n){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=r,this.serializer=n,this.ia=!1}sa(){if(this.ia)throw new C(D.FAILED_PRECONDITION,"The client has already been terminated.")}Go(e,t,r,n){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.Go(e,it(t,r),n,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===D.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new C(D.UNKNOWN,e.toString())})}Ho(e,t,r,n,i){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Ho(e,it(t,r),n,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===D.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new C(D.UNKNOWN,e.toString())})}terminate(){this.ia=!0,this.connection.terminate()}}class aD{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.oa=0,this._a=null,this.aa=!0}ua(){0===this.oa&&(this.ca("Unknown"),this._a=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this._a=null,this.la("Backend didn't respond within 10 seconds."),this.ca("Offline"),Promise.resolve())))}ha(e){"Online"===this.state?this.ca("Unknown"):(this.oa++,this.oa>=1&&(this.Pa(),this.la(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ca("Offline")))}set(e){this.Pa(),this.oa=0,"Online"===e&&(this.aa=!1),this.ca(e)}ca(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}la(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.aa?(b(t),this.aa=!1):T("OnlineStateTracker",t)}Pa(){null!==this._a&&(this._a.cancel(),this._a=null)}}let aC="RemoteStore";class ak{constructor(e,t,r,n,i){this.localStore=e,this.datastore=t,this.asyncQueue=r,this.remoteSyncer={},this.Ta=[],this.Ia=new Map,this.Ea=new Set,this.da=[],this.Aa=i,this.Aa.Oo(e=>{r.enqueueAndForget(async()=>{aU(this)&&(T(aC,"Restarting streams for network reachability change."),await async function(e){e.Ea.add(4),await aV(e),e.Ra.set("Unknown"),e.Ea.delete(4),await aA(e)}(this))})}),this.Ra=new aD(r,n)}}async function aA(e){if(aU(e))for(let t of e.da)await t(!0)}async function aV(e){for(let t of e.da)await t(!1)}function aR(e,t){e.Ia.has(t.targetId)||(e.Ia.set(t.targetId,t),aL(e)?aF(e):a1(e).O_()&&aO(e,t))}function aM(e,t){let r=a1(e);e.Ia.delete(t),r.O_()&&aP(e,t),0===e.Ia.size&&(r.O_()?r.L_():aU(e)&&e.Ra.set("Unknown"))}function aO(e,t){if(e.Va.Ue(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(en.min())>0){let r=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(r)}a1(e).Y_(t)}function aP(e,t){e.Va.Ue(t),a1(e).Z_(t)}function aF(e){e.Va=new nZ({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),At:t=>e.Ia.get(t)||null,ht:()=>e.datastore.serializer.databaseId}),a1(e).start(),e.Ra.ua()}function aL(e){return aU(e)&&!a1(e).x_()&&e.Ia.size>0}function aU(e){return 0===e.Ea.size}async function aq(e){e.Ra.set("Online")}async function aB(e){e.Ia.forEach((t,r)=>{aO(e,t)})}async function az(e,t){e.Va=void 0,aL(e)?(e.Ra.ha(t),aF(e)):e.Ra.set("Unknown")}async function aK(e,t,r){if(e.Ra.set("Online"),t instanceof nY&&2===t.state&&t.cause)try{await async function(e,t){let r=t.cause;for(let n of t.targetIds)e.Ia.has(n)&&(await e.remoteSyncer.rejectListen(n,r),e.Ia.delete(n),e.Va.removeTarget(n))}(e,t)}catch(r){T(aC,"Failed to remove targets %s: %s ",t.targetIds.join(","),r),await a$(e,r)}else if(t instanceof nH?e.Va.Ze(t):t instanceof nJ?e.Va.st(t):e.Va.tt(t),!r.isEqual(en.min()))try{let t=await sQ(e.localStore);r.compareTo(t)>=0&&await function(e,t){let r=e.Va.Tt(t);return r.targetChanges.forEach((r,n)=>{if(r.resumeToken.approximateByteSize()>0){let i=e.Ia.get(n);i&&e.Ia.set(n,i.withResumeToken(r.resumeToken,t))}}),r.targetMismatches.forEach((t,r)=>{let n=e.Ia.get(t);if(!n)return;e.Ia.set(t,n.withResumeToken(tq.EMPTY_BYTE_STRING,n.snapshotVersion)),aP(e,t);let i=new iT(n.target,t,r,n.sequenceNumber);aO(e,i)}),e.remoteSyncer.applyRemoteEvent(r)}(e,r)}catch(t){T(aC,"Failed to raise snapshot:",t),await a$(e,t)}}async function a$(e,t,r){if(!eE(t))throw t;e.Ea.add(1),await aV(e),e.Ra.set("Offline"),r||(r=()=>sQ(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{T(aC,"Retrying IndexedDB access"),await r(),e.Ea.delete(1),await aA(e)})}function aG(e,t){return t().catch(r=>a$(e,r,t))}async function aj(e){var t;let r=a2(e),n=e.Ta.length>0?e.Ta[e.Ta.length-1].batchId:-1;for(;aU(t=e)&&t.Ta.length<10;)try{let t=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",r=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(r,t)))}(e.localStore,n);if(null===t){0===e.Ta.length&&r.L_();break}n=t.batchId,function(e,t){e.Ta.push(t);let r=a2(e);r.O_()&&r.X_&&r.ea(t.mutations)}(e,t)}catch(t){await a$(e,t)}aQ(e)&&aW(e)}function aQ(e){return aU(e)&&!a2(e).x_()&&e.Ta.length>0}function aW(e){a2(e).start()}async function aH(e){a2(e).ra()}async function aJ(e){let t=a2(e);for(let r of e.Ta)t.ea(r.mutations)}async function aY(e,t,r){let n=e.Ta.shift(),i=nP.from(n,t,r);await aG(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await aj(e)}async function aX(e,t){t&&a2(e).X_&&await async function(e,t){var r;if(nU(r=t.code)&&r!==D.ABORTED){let r=e.Ta.shift();a2(e).B_(),await aG(e,()=>e.remoteSyncer.rejectFailedWrite(r.batchId,t)),await aj(e)}}(e,t),aQ(e)&&aW(e)}async function aZ(e,t){e.asyncQueue.verifyOperationInProgress(),T(aC,"RemoteStore received new credentials");let r=aU(e);e.Ea.add(3),await aV(e),r&&e.Ra.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ea.delete(3),await aA(e)}async function a0(e,t){t?(e.Ea.delete(2),await aA(e)):t||(e.Ea.add(2),await aV(e),e.Ra.set("Unknown"))}function a1(e){var t,r,n;return e.ma||(t=e.datastore,r=e.asyncQueue,n={Xo:aq.bind(null,e),t_:aB.bind(null,e),r_:az.bind(null,e),H_:aK.bind(null,e)},t.sa(),e.ma=new a_(r,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,n),e.da.push(async t=>{t?(e.ma.B_(),aL(e)?aF(e):e.Ra.set("Unknown")):(await e.ma.stop(),e.Va=void 0)})),e.ma}function a2(e){var t,r,n;return e.fa||(t=e.datastore,r=e.asyncQueue,n={Xo:()=>Promise.resolve(),t_:aH.bind(null,e),r_:aX.bind(null,e),ta:aJ.bind(null,e),na:aY.bind(null,e)},t.sa(),e.fa=new aS(r,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,n),e.da.push(async t=>{t?(e.fa.B_(),await aj(e)):(await e.fa.stop(),e.Ta.length>0&&(T(aC,`Stopping write stream with ${e.Ta.length} pending writes`),e.Ta=[]))})),e.fa}class a5{constructor(e,t,r,n,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=r,this.op=n,this.removalCallback=i,this.deferred=new k,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,r,n,i){let s=new a5(e,t,Date.now()+r,n,i);return s.start(r),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new C(D.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function a4(e,t){if(b("AsyncQueue",`${t}: ${e}`),eE(e))return new C(D.UNAVAILABLE,`${t}: ${e}`);throw e}class a3{static emptySet(e){return new a3(e.comparator)}constructor(e){this.comparator=e?(t,r)=>e(t,r)||H.comparator(t.key,r.key):(e,t)=>H.comparator(e.key,t.key),this.keyedMap=ne(),this.sortedSet=new tV(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,r)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof a3)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,n=r.getNext().key;if(!e.isEqual(n))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let r=new a3;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=t,r}}class a6{constructor(){this.ga=new tV(H.comparator)}track(e){let t=e.doc.key,r=this.ga.get(t);r?0!==e.type&&3===r.type?this.ga=this.ga.insert(t,e):3===e.type&&1!==r.type?this.ga=this.ga.insert(t,{type:r.type,doc:e.doc}):2===e.type&&2===r.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):2===e.type&&0===r.type?this.ga=this.ga.insert(t,{type:0,doc:e.doc}):1===e.type&&0===r.type?this.ga=this.ga.remove(t):1===e.type&&2===r.type?this.ga=this.ga.insert(t,{type:1,doc:r.doc}):0===e.type&&1===r.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):S(63341,{Rt:e,pa:r}):this.ga=this.ga.insert(t,e)}ya(){let e=[];return this.ga.inorderTraversal((t,r)=>{e.push(r)}),e}}class a8{constructor(e,t,r,n,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=r,this.docChanges=n,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,r,n,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new a8(e,t,a3.emptySet(t),s,r,n,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&r1(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,r=e.docChanges;if(t.length!==r.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==r[e].type||!t[e].doc.isEqual(r[e].doc))return!1;return!0}}class a9{constructor(){this.wa=void 0,this.Sa=[]}ba(){return this.Sa.some(e=>e.Da())}}class a7{constructor(){this.queries=oe(),this.onlineState="Unknown",this.Ca=new Set}terminate(){!function(e,t){let r=e.queries;e.queries=oe(),r.forEach((e,r)=>{for(let e of r.Sa)e.onError(t)})}(this,new C(D.ABORTED,"Firestore shutting down"))}}function oe(){return new r8(e=>r2(e),r1)}async function ot(e,t){let r=3,n=t.query,i=e.queries.get(n);i?!i.ba()&&t.Da()&&(r=2):(i=new a9,r=+!t.Da());try{switch(r){case 0:i.wa=await e.onListen(n,!0);break;case 1:i.wa=await e.onListen(n,!1);break;case 2:await e.onFirstRemoteStoreListen(n)}}catch(r){let e=a4(r,`Initialization of query '${r5(t.query)}' failed`);return void t.onError(e)}e.queries.set(n,i),i.Sa.push(t),t.va(e.onlineState),i.wa&&t.Fa(i.wa)&&os(e)}async function or(e,t){let r=t.query,n=3,i=e.queries.get(r);if(i){let e=i.Sa.indexOf(t);e>=0&&(i.Sa.splice(e,1),0===i.Sa.length?n=+!t.Da():!i.ba()&&t.Da()&&(n=2))}switch(n){case 0:return e.queries.delete(r),e.onUnlisten(r,!0);case 1:return e.queries.delete(r),e.onUnlisten(r,!1);case 2:return e.onLastRemoteStoreUnlisten(r);default:return}}function on(e,t){let r=!1;for(let n of t){let t=n.query,i=e.queries.get(t);if(i){for(let e of i.Sa)e.Fa(n)&&(r=!0);i.wa=n}}r&&os(e)}function oi(e,t,r){let n=e.queries.get(t);if(n)for(let e of n.Sa)e.onError(r);e.queries.delete(t)}function os(e){e.Ca.forEach(e=>{e.next()})}(a=s||(s={})).Ma="default",a.Cache="cache";class oa{constructor(e,t,r){this.query=e,this.xa=t,this.Oa=!1,this.Na=null,this.onlineState="Unknown",this.options=r||{}}Fa(e){if(!this.options.includeMetadataChanges){let t=[];for(let r of e.docChanges)3!==r.type&&t.push(r);e=new a8(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Oa?this.Ba(e)&&(this.xa.next(e),t=!0):this.La(e,this.onlineState)&&(this.ka(e),t=!0),this.Na=e,t}onError(e){this.xa.error(e)}va(e){this.onlineState=e;let t=!1;return this.Na&&!this.Oa&&this.La(this.Na,e)&&(this.ka(this.Na),t=!0),t}La(e,t){return!(e.fromCache&&this.Da())||(!this.options.qa||"Offline"===t)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Ba(e){if(e.docChanges.length>0)return!0;let t=this.Na&&this.Na.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}ka(e){e=a8.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Oa=!0,this.xa.next(e)}Da(){return this.options.source!==s.Cache}}class oo{constructor(e,t){this.Qa=e,this.byteLength=t}$a(){return"metadata"in this.Qa}}class ol{constructor(e){this.serializer=e}$s(e){return is(this.serializer,e)}Us(e){return e.metadata.exists?ic(this.serializer,e.document,!1):ry.newNoDocument(this.$s(e.metadata.name),this.Ks(e.metadata.readTime))}Ks(e){return n7(e)}}class ou{constructor(e,t){this.Ua=e,this.serializer=t,this.Ka=[],this.Wa=[],this.collectionGroups=new Set,this.progress=oh(e)}get queries(){return this.Ka}get documents(){return this.Wa}Ga(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Qa.namedQuery)this.Ka.push(e.Qa.namedQuery);else if(e.Qa.documentMetadata){this.Wa.push({metadata:e.Qa.documentMetadata}),e.Qa.documentMetadata.exists||++t;let r=j.fromString(e.Qa.documentMetadata.name);this.collectionGroups.add(r.get(r.length-2))}else e.Qa.document&&(this.Wa[this.Wa.length-1].document=e.Qa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,{...this.progress}):null}za(e){let t=new Map,r=new ol(this.serializer);for(let n of e)if(n.metadata.queries){let e=r.$s(n.metadata.name);for(let r of n.metadata.queries){let n=(t.get(r)||ns()).add(e);t.set(r,n)}}return t}async ja(e){let t=await s1(e,new ol(this.serializer),this.Wa,this.Ua.id),r=this.za(this.documents);for(let t of this.Ka)await s2(e,t,r.get(t.name));return this.progress.taskState="Success",{progress:this.progress,Ja:this.collectionGroups,Ha:t}}}function oh(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class oc{constructor(e){this.key=e}}class od{constructor(e){this.key=e}}class of{constructor(e,t){this.query=e,this.Ya=t,this.Za=null,this.hasCachedResults=!1,this.current=!1,this.Xa=ns(),this.mutatedKeys=ns(),this.eu=r6(e),this.tu=new a3(this.eu)}get nu(){return this.Ya}ru(e,t){let r=t?t.iu:new a6,n=t?t.tu:this.tu,i=t?t.mutatedKeys:this.mutatedKeys,s=n,a=!1,o="F"===this.query.limitType&&n.size===this.query.limit?n.last():null,l="L"===this.query.limitType&&n.size===this.query.limit?n.first():null;if(e.inorderTraversal((e,t)=>{let u=n.get(e),h=r4(this.query,t)?t:null,c=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations),f=!1;u&&h?u.data.isEqual(h.data)?c!==d&&(r.track({type:3,doc:h}),f=!0):this.su(u,h)||(r.track({type:2,doc:h}),f=!0,(o&&this.eu(h,o)>0||l&&0>this.eu(h,l))&&(a=!0)):!u&&h?(r.track({type:0,doc:h}),f=!0):u&&!h&&(r.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(h?(s=s.add(h),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),r.track({type:1,doc:e})}return{tu:s,iu:r,Cs:a,mutatedKeys:i}}su(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,r,n){let i=this.tu;this.tu=e.tu,this.mutatedKeys=e.mutatedKeys;let s=e.iu.ya();s.sort((e,t)=>(function(e,t){let r=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return S(20277,{Rt:e})}};return r(e)-r(t)})(e.type,t.type)||this.eu(e.doc,t.doc)),this.ou(r),n=n??!1;let a=t&&!n?this._u():[],o=0===this.Xa.size&&this.current&&!n?1:0,l=o!==this.Za;return(this.Za=o,0!==s.length||l)?{snapshot:new a8(this.query,e.tu,i,s,e.mutatedKeys,0===o,l,!1,!!r&&r.resumeToken.approximateByteSize()>0),au:a}:{au:a}}va(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({tu:this.tu,iu:new a6,mutatedKeys:this.mutatedKeys,Cs:!1},!1)):{au:[]}}uu(e){return!this.Ya.has(e)&&!!this.tu.has(e)&&!this.tu.get(e).hasLocalMutations}ou(e){e&&(e.addedDocuments.forEach(e=>this.Ya=this.Ya.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Ya=this.Ya.delete(e)),this.current=e.current)}_u(){if(!this.current)return[];let e=this.Xa;this.Xa=ns(),this.tu.forEach(e=>{this.uu(e.key)&&(this.Xa=this.Xa.add(e.key))});let t=[];return e.forEach(e=>{this.Xa.has(e)||t.push(new od(e))}),this.Xa.forEach(r=>{e.has(r)||t.push(new oc(r))}),t}cu(e){this.Ya=e.Qs,this.Xa=ns();let t=this.ru(e.documents);return this.applyChanges(t,!0)}lu(){return a8.fromInitialDocuments(this.query,this.tu,this.mutatedKeys,0===this.Za,this.hasCachedResults)}}let om="SyncEngine";class og{constructor(e,t,r){this.query=e,this.targetId=t,this.view=r}}class op{constructor(e){this.key=e,this.hu=!1}}class oy{constructor(e,t,r,n,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=r,this.sharedClientState=n,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Pu={},this.Tu=new r8(e=>r2(e),r1),this.Iu=new Map,this.Eu=new Set,this.du=new tV(H.comparator),this.Au=new Map,this.Ru=new sS,this.Vu={},this.mu=new Map,this.fu=si.cr(),this.onlineState="Unknown",this.gu=void 0}get isPrimaryClient(){return!0===this.gu}}async function ow(e,t,r=!0){let n;let i=oW(e),s=i.Tu.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),n=s.view.lu()):n=await oI(i,t,r,!0),n}async function ov(e,t){let r=oW(e);await oI(r,t,!0,!1)}async function oI(e,t,r,n){let i;let s=await sH(e.localStore,rY(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,r);return n&&(i=await oT(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&r&&aR(e.remoteStore,s),i}async function oT(e,t,r,n,i){e.pu=(t,r,n)=>(async function(e,t,r,n){let i=t.view.ru(r);i.Cs&&(i=await sY(e.localStore,t.query,!1).then(({documents:e})=>t.view.ru(e,i)));let s=n&&n.targetChanges.get(t.targetId),a=n&&null!=n.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return oM(e,t.targetId,o.au),o.snapshot})(e,t,r,n);let s=await sY(e.localStore,t,!0),a=new of(t,s.Qs),o=a.ru(s.documents),l=nW.createSynthesizedTargetChangeForCurrentChange(r,n&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);oM(e,r,u.au);let h=new og(t,r,a);return e.Tu.set(t,h),e.Iu.has(r)?e.Iu.get(r).push(t):e.Iu.set(r,[t]),u.snapshot}async function ob(e,t,r){let n=e.Tu.get(t),i=e.Iu.get(n.targetId);if(i.length>1)return e.Iu.set(n.targetId,i.filter(e=>!r1(e,t))),void e.Tu.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(n.targetId),e.sharedClientState.isActiveQueryTarget(n.targetId)||await sJ(e.localStore,n.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(n.targetId),r&&aM(e.remoteStore,n.targetId),oV(e,n.targetId)}).catch(eg)):(oV(e,n.targetId),await sJ(e.localStore,n.targetId,!0))}async function oE(e,t){let r=e.Tu.get(t),n=e.Iu.get(r.targetId);e.isPrimaryClient&&1===n.length&&(e.sharedClientState.removeLocalQueryTarget(r.targetId),aM(e.remoteStore,r.targetId))}async function o_(e,t,r){let n=oH(e);try{var i;let e;let s=await function(e,t){let r,n;let i=er.now(),s=t.reduce((e,t)=>e.add(t.key),ns());return e.persistence.runTransaction("Locally write mutations","readwrite",a=>{let o=r9,l=ns();return e.Ns.getEntries(a,s).next(e=>{(o=e).forEach((e,t)=>{t.isValidDocument()||(l=l.add(e))})}).next(()=>e.localDocuments.getOverlayedDocuments(a,o)).next(n=>{r=n;let s=[];for(let e of t){let t=function(e,t){let r=null;for(let n of e.fieldTransforms){let e=t.data.field(n.field),i=nc(n.transform,e||null);null!=i&&(null===r&&(r=rp.empty()),r.set(n.field,i))}return r||null}(e,r.get(e.key).overlayedDocument);null!=t&&s.push(new nC(e.key,t,function e(t){let r=[];return tk(t.fields,(t,n)=>{let i=new W([t]);if(ru(n)){let t=e(n.mapValue).fields;if(0===t.length)r.push(i);else for(let e of t)r.push(i.child(e))}else r.push(i)}),new tL(r)}(t.value.mapValue),nb.exists(!0)))}return e.mutationQueue.addMutationBatch(a,i,s,t)}).next(t=>{n=t;let i=t.applyToLocalDocumentSet(r,l);return e.documentOverlayCache.saveOverlays(a,t.batchId,i)})}).then(()=>({batchId:n.batchId,changes:nt(r)}))}(n.localStore,t);n.sharedClientState.addPendingMutation(s.batchId),i=s.batchId,(e=n.Vu[n.currentUser.toKey()])||(e=new tV(q)),e=e.insert(i,r),n.Vu[n.currentUser.toKey()]=e,await oP(n,s.changes),await aj(n.remoteStore)}catch(t){let e=a4(t,"Failed to persist write");r.reject(e)}}async function oS(e,t){try{let r=await function(e,t){let r=t.snapshotVersion,n=e.Ms;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.Ns.newChangeBuffer({trackRemovals:!0});n=e.Ms;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=n.get(o);if(!u)return;a.push(e.Pi.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.Pi.addMatchingKeys(i,s.addedDocuments,o)));let h=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?h=h.withResumeToken(tq.EMPTY_BYTE_STRING,en.min()).withLastLimboFreeSnapshotVersion(en.min()):s.resumeToken.approximateByteSize()>0&&(h=h.withResumeToken(s.resumeToken,r)),n=n.insert(o,h),l=h,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.Pi.updateTargetData(i,h))});let o=r9,l=ns();if(t.documentUpdates.forEach(r=>{t.resolvedLimboDocuments.has(r)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,r))}),a.push(sW(i,s,t.documentUpdates).next(e=>{o=e.ks,l=e.qs})),!r.isEqual(en.min())){let t=e.Pi.getLastRemoteSnapshotVersion(i).next(t=>e.Pi.setTargetsMetadata(i,i.currentSequenceNumber,r));a.push(t)}return ep.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.Ms=n,t))}(e.localStore,t);t.targetChanges.forEach((t,r)=>{let n=e.Au.get(r);n&&(N(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1,22616),t.addedDocuments.size>0?n.hu=!0:t.modifiedDocuments.size>0?N(n.hu,14607):t.removedDocuments.size>0&&(N(n.hu,42227),n.hu=!1))}),await oP(e,r,t)}catch(e){await eg(e)}}function ox(e,t,r){var n;if(e.isPrimaryClient&&0===r||!e.isPrimaryClient&&1===r){let r;let i=[];e.Tu.forEach((e,r)=>{let n=r.view.va(t);n.snapshot&&i.push(n.snapshot)}),(n=e.eventManager).onlineState=t,r=!1,n.queries.forEach((e,n)=>{for(let e of n.Sa)e.va(t)&&(r=!0)}),r&&os(n),i.length&&e.Pu.H_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function oN(e,t,r){e.sharedClientState.updateQueryState(t,"rejected",r);let n=e.Au.get(t),i=n&&n.key;if(i){let r=new tV(H.comparator);r=r.insert(i,ry.newNoDocument(i,en.min()));let n=ns().add(i),s=new nQ(en.min(),new Map,new tV(q),r,n);await oS(e,s),e.du=e.du.remove(i),e.Au.delete(t),oO(e)}else await sJ(e.localStore,t,!1).then(()=>oV(e,t,r)).catch(eg)}async function oD(e,t){var r;let n=t.batch.batchId;try{let i=await (r=e.localStore).persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let n=t.batch.keys(),i=r.Ns.newChangeBuffer({trackRemovals:!0});return(function(e,t,r,n){let i=r.batch,s=i.keys(),a=ep.resolve();return s.forEach(e=>{a=a.next(()=>n.getEntry(t,e)).next(t=>{let s=r.docVersions.get(e);N(null!==s,48541),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,r),t.isValidDocument()&&(t.setReadTime(r.commitVersion),n.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(r,e,t,i).next(()=>i.apply(e)).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t.batch.batchId)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=ns();for(let r=0;r<e.mutationResults.length;++r)e.mutationResults[r].transformResults.length>0&&(t=t.add(e.batch.mutations[r].key));return t}(t))).next(()=>r.localDocuments.getDocuments(e,n))});oA(e,n,null),ok(e,n),e.sharedClientState.updateMutationState(n,"acknowledged"),await oP(e,i)}catch(e){await eg(e)}}async function oC(e,t,r){var n;try{let i=await (n=e.localStore).persistence.runTransaction("Reject batch","readwrite-primary",e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next(t=>(N(null!==t,37113),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t))).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r)).next(()=>n.localDocuments.getDocuments(e,r))});oA(e,t,r),ok(e,t),e.sharedClientState.updateMutationState(t,"rejected",r),await oP(e,i)}catch(e){await eg(e)}}function ok(e,t){(e.mu.get(t)||[]).forEach(e=>{e.resolve()}),e.mu.delete(t)}function oA(e,t,r){let n=e.Vu[e.currentUser.toKey()];if(n){let i=n.get(t);i&&(r?i.reject(r):i.resolve(),n=n.remove(t)),e.Vu[e.currentUser.toKey()]=n}}function oV(e,t,r=null){for(let n of(e.sharedClientState.removeLocalQueryTarget(t),e.Iu.get(t)))e.Tu.delete(n),r&&e.Pu.yu(n,r);e.Iu.delete(t),e.isPrimaryClient&&e.Ru.jr(t).forEach(t=>{e.Ru.containsKey(t)||oR(e,t)})}function oR(e,t){e.Eu.delete(t.path.canonicalString());let r=e.du.get(t);null!==r&&(aM(e.remoteStore,r),e.du=e.du.remove(t),e.Au.delete(r),oO(e))}function oM(e,t,r){for(let n of r)n instanceof oc?(e.Ru.addReference(n.key,t),function(e,t){let r=t.key,n=r.path.canonicalString();e.du.get(r)||e.Eu.has(n)||(T(om,"New document in limbo: "+r),e.Eu.add(n),oO(e))}(e,n)):n instanceof od?(T(om,"Document no longer in limbo: "+n.key),e.Ru.removeReference(n.key,t),e.Ru.containsKey(n.key)||oR(e,n.key)):S(19791,{wu:n})}function oO(e){for(;e.Eu.size>0&&e.du.size<e.maxConcurrentLimboResolutions;){let t=e.Eu.values().next().value;e.Eu.delete(t);let r=new H(j.fromString(t)),n=e.fu.next();e.Au.set(n,new op(r)),e.du=e.du.insert(r,n),aR(e.remoteStore,new iT(rY(rQ(r.path)),n,"TargetPurposeLimboResolution",eA.ce))}}async function oP(e,t,r){let n=[],i=[],s=[];e.Tu.isEmpty()||(e.Tu.forEach((a,o)=>{s.push(e.pu(o,t,r).then(t=>{if((t||r)&&e.isPrimaryClient){let n=t?!t.fromCache:r?.targetChanges.get(o.targetId)?.current;e.sharedClientState.updateQueryState(o.targetId,n?"current":"not-current")}if(t){n.push(t);let e=sB.As(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.Pu.H_(n),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",r=>ep.forEach(t,t=>ep.forEach(t.Es,n=>e.persistence.referenceDelegate.addReference(r,t.targetId,n)).next(()=>ep.forEach(t.ds,n=>e.persistence.referenceDelegate.removeReference(r,t.targetId,n)))))}catch(e){if(!eE(e))throw e;T(s$,"Failed to update sequence numbers: "+e)}for(let r of t){let t=r.targetId;if(!r.fromCache){let r=e.Ms.get(t),n=r.snapshotVersion,i=r.withLastLimboFreeSnapshotVersion(n);e.Ms=e.Ms.insert(t,i)}}}(e.localStore,i))}async function oF(e,t){if(!e.currentUser.isEqual(t)){T(om,"User change. New user:",t.toKey());let r=await sj(e.localStore,t);e.currentUser=t,e.mu.forEach(e=>{e.forEach(e=>{e.reject(new C(D.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.mu.clear(),e.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await oP(e,r.Ls)}}function oL(e,t){let r=e.Au.get(t);if(r&&r.hu)return ns().add(r.key);{let r=ns(),n=e.Iu.get(t);if(!n)return r;for(let t of n){let n=e.Tu.get(t);r=r.unionWith(n.view.nu)}return r}}async function oU(e,t){let r=await sY(e.localStore,t.query,!0),n=t.view.cu(r);return e.isPrimaryClient&&oM(e,t.targetId,n.au),n}async function oq(e,t){return sZ(e.localStore,t).then(t=>oP(e,t))}async function oB(e,t,r,n){let i=await function(e,t){let r=e.mutationQueue;return e.persistence.runTransaction("Lookup mutation documents","readonly",n=>r.er(n,t).next(t=>t?e.localDocuments.getDocuments(n,t):ep.resolve(null)))}(e.localStore,t);null!==i?("pending"===r?await aj(e.remoteStore):"acknowledged"===r||"rejected"===r?(oA(e,t,n||null),ok(e,t),function(e,t){e.mutationQueue.ir(t)}(e.localStore,t)):S(6720,"Unknown batchState",{Su:r}),await oP(e,i)):T(om,"Cannot apply mutation batch with id: "+t)}async function oz(e,t){if(oW(e),oH(e),!0===t&&!0!==e.gu){let t=e.sharedClientState.getAllActiveQueryTargets(),r=await oK(e,t.toArray());for(let t of(e.gu=!0,await a0(e.remoteStore,!0),r))aR(e.remoteStore,t)}else if(!1===t&&!1!==e.gu){let t=[],r=Promise.resolve();e.Iu.forEach((n,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):r=r.then(()=>(oV(e,i),sJ(e.localStore,i,!0))),aM(e.remoteStore,i)}),await r,await oK(e,t),e.Au.forEach((t,r)=>{aM(e.remoteStore,r)}),e.Ru.Jr(),e.Au=new Map,e.du=new tV(H.comparator),e.gu=!1,await a0(e.remoteStore,!1)}}async function oK(e,t,r){let n=[],i=[];for(let r of t){let t;let s=e.Iu.get(r);if(s&&0!==s.length)for(let r of(t=await sH(e.localStore,rY(s[0])),s)){let t=e.Tu.get(r),n=await oU(e,t);n.snapshot&&i.push(n.snapshot)}else{let n=await sX(e.localStore,r);t=await sH(e.localStore,n),await oT(e,o$(n),r,!1,t.resumeToken)}n.push(t)}return e.Pu.H_(i),n}function o$(e){var t,r,n,i,s;return t=e.path,r=e.collectionGroup,n=e.orderBy,i=e.filters,s=e.limit,new rj(t,r,n,i,s,"F",e.startAt,e.endAt)}function oG(e){return e.localStore.persistence.Ts()}async function oj(e,t,r,n){if(e.gu)return void T(om,"Ignoring unexpected query state notification.");let i=e.Iu.get(t);if(i&&i.length>0)switch(r){case"current":case"not-current":{let n=await sZ(e.localStore,r3(i[0])),s=nQ.createSynthesizedRemoteEventForCurrentChange(t,"current"===r,tq.EMPTY_BYTE_STRING);await oP(e,n,s);break}case"rejected":await sJ(e.localStore,t,!0),oV(e,t,n);break;default:S(64155,r)}}async function oQ(e,t,r){let n=oW(e);if(n.gu){for(let e of t){if(n.Iu.has(e)&&n.sharedClientState.isActiveQueryTarget(e)){T(om,"Adding an already active target "+e);continue}let t=await sX(n.localStore,e),r=await sH(n.localStore,t);await oT(n,o$(t),r.targetId,!1,r.resumeToken),aR(n.remoteStore,r)}for(let e of r)n.Iu.has(e)&&await sJ(n.localStore,e,!1).then(()=>{aM(n.remoteStore,e),oV(n,e)}).catch(eg)}}function oW(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=oS.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=oL.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=oN.bind(null,e),e.Pu.H_=on.bind(null,e.eventManager),e.Pu.yu=oi.bind(null,e.eventManager),e}function oH(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=oD.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=oC.bind(null,e),e}class oJ{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=aI(e.databaseInfo.databaseId),this.sharedClientState=this.Du(e),this.persistence=this.Cu(e),await this.persistence.start(),this.localStore=this.vu(e),this.gcScheduler=this.Fu(e,this.localStore),this.indexBackfillerScheduler=this.Mu(e,this.localStore)}Fu(e,t){return null}Mu(e,t){return null}vu(e){var t,r;return t=this.persistence,r=new sK,new sG(t,r,e.initialUser,this.serializer)}Cu(e){return new sA(sR.mi,this.serializer)}Du(e){return new aa}async terminate(){this.gcScheduler?.stop(),this.indexBackfillerScheduler?.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}oJ.provider={build:()=>new oJ};class oY extends oJ{constructor(e){super(),this.cacheSizeBytes=e}Fu(e,t){return N(this.persistence.referenceDelegate instanceof sM,46915),new sh(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Cu(e){let t=void 0!==this.cacheSizeBytes?i9.withCacheSize(this.cacheSizeBytes):i9.DEFAULT;return new sA(e=>sM.mi(e,t),this.serializer)}}class oX extends oJ{constructor(e,t,r){super(),this.xu=e,this.cacheSizeBytes=t,this.forceOwnership=r,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.xu.initialize(this,e),await oH(this.xu.syncEngine),await aj(this.xu.remoteStore),await this.persistence.Ji(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}vu(e){var t,r;return t=this.persistence,r=new sK,new sG(t,r,e.initialUser,this.serializer)}Fu(e,t){return new sh(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Mu(e,t){let r=new ek(t,this.persistence);return new eC(e.asyncQueue,r)}Cu(e){let t=sq(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),r=void 0!==this.cacheSizeBytes?i9.withCacheSize(this.cacheSizeBytes):i9.DEFAULT;return new sU(this.synchronizeTabs,t,e.clientId,r,e.asyncQueue,aw(),av(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Du(e){return new aa}}class oZ extends oX{constructor(e,t){super(e,t,!1),this.xu=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);let t=this.xu.syncEngine;this.sharedClientState instanceof as&&(this.sharedClientState.syncEngine={Co:oB.bind(null,t),vo:oj.bind(null,t),Fo:oQ.bind(null,t),Ts:oG.bind(null,t),Do:oq.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ji(async e=>{await oz(this.xu.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}Du(e){let t=aw();if(!as.v(t))throw new C(D.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let r=sq(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new as(t,e.asyncQueue,r,e.clientId,e.initialUser)}}class o0{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>ox(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=oF.bind(null,this.syncEngine),await a0(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new a7}createDatastore(e){var t;let r=aI(e.databaseInfo.databaseId),n=new ay(e.databaseInfo);return t=e.authCredentials,new aN(t,e.appCheckCredentials,n,r)}createRemoteStore(e){var t,r;return t=this.localStore,r=this.datastore,new ak(t,r,e.asyncQueue,e=>ox(this.syncEngine,e,0),au.v()?new au:new ao)}createSyncEngine(e,t){return function(e,t,r,n,i,s,a){let o=new oy(e,t,r,n,i,s);return a&&(o.gu=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){await async function(e){T(aC,"RemoteStore shutting down."),e.Ea.add(5),await aV(e),e.Aa.shutdown(),e.Ra.set("Unknown")}(this.remoteStore),this.datastore?.terminate(),this.eventManager?.terminate()}}function o1(e,t=10240){let r=0;return{async read(){if(r<e.byteLength){let n={value:e.slice(r,r+t),done:!1};return r+=t,n}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}o0.provider={build:()=>new o0};class o2{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ou(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ou(this.observer.error,e):b("Uncaught Error in snapshot listener:",e.toString()))}Nu(){this.muted=!0}Ou(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class o5{constructor(e,t){this.Bu=e,this.serializer=t,this.metadata=new k,this.buffer=new Uint8Array,this.Lu=new TextDecoder("utf-8"),this.ku().then(e=>{e&&e.$a()?this.metadata.resolve(e.Qa.metadata):this.metadata.reject(Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(e?.Qa)}`))},e=>this.metadata.reject(e))}close(){return this.Bu.cancel()}async getMetadata(){return this.metadata.promise}async bu(){return await this.getMetadata(),this.ku()}async ku(){let e=await this.qu();if(null===e)return null;let t=this.Lu.decode(e),r=Number(t);return isNaN(r)&&this.Qu(`length string (${t}) is not valid number`),new oo(JSON.parse(await this.$u(r)),e.length+r)}Uu(){return this.buffer.findIndex(e=>123===e)}async qu(){for(;0>this.Uu()&&!await this.Ku(););if(0===this.buffer.length)return null;let e=this.Uu();e<0&&this.Qu("Reached the end of bundle when a length string is expected.");let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async $u(e){for(;this.buffer.length<e;)await this.Ku()&&this.Qu("Reached the end of bundle when more is expected.");let t=this.Lu.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Qu(e){throw this.Bu.cancel(),Error(`Invalid bundle format: ${e}`)}async Ku(){let e=await this.Bu.read();if(!e.done){let t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class o4{constructor(e,t){this.bundleData=e,this.serializer=t,this.cursor=0,this.elements=[];let r=this.bu();if(!r||!r.$a())throw Error(`The first element of the bundle is not a metadata object, it is
         ${JSON.stringify(r?.Qa)}`);this.metadata=r;do null!==(r=this.bu())&&this.elements.push(r);while(null!==r)}getMetadata(){return this.metadata}Wu(){return this.elements}bu(){if(this.cursor===this.bundleData.length)return null;let e=this.qu();return new oo(JSON.parse(this.$u(e)),e)}$u(e){if(this.cursor+e>this.bundleData.length)throw new C(D.INTERNAL,"Reached the end of bundle when more is expected.");return this.bundleData.slice(this.cursor,this.cursor+=e)}qu(){let e=this.cursor,t=this.cursor;for(;t<this.bundleData.length;){if("{"===this.bundleData[t]){if(t===e)throw Error("First character is a bracket and not a number");return this.cursor=t,Number(this.bundleData.slice(e,t))}t++}throw Error("Reached the end of bundle when more is expected.")}}class o3{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new C(D.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=await async function(e,t){let r={documents:t.map(t=>ii(e.serializer,t))},n=await e.Ho("BatchGetDocuments",e.serializer.databaseId,j.emptyPath(),r,t.length),i=new Map;n.forEach(t=>{var r;let n=(r=e.serializer,"found"in t?function(e,t){N(!!t.found,43571),t.found.name,t.found.updateTime;let r=is(e,t.found.name),n=n7(t.found.updateTime),i=t.found.createTime?n7(t.found.createTime):en.min(),s=new rp({mapValue:{fields:t.found.fields}});return ry.newFoundDocument(r,n,i,s)}(r,t):"missing"in t?function(e,t){N(!!t.missing,3894),N(!!t.readTime,22933);let r=is(e,t.missing),n=n7(t.readTime);return ry.newNoDocument(r,n)}(r,t):S(7234,{result:t}));i.set(n.key.toString(),n)});let s=[];return t.forEach(e=>{let t=i.get(e.toString());N(!!t,55234,{key:e}),s.push(t)}),s}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new nR(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{let r=H.fromPath(t);this.mutations.push(new nM(r,this.precondition(r)))}),await async function(e,t){let r={writes:t.map(t=>id(e.serializer,t))};await e.Go("Commit",e.serializer.databaseId,j.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw S(50498,{Gu:e.constructor.name});t=en.min()}let r=this.readVersions.get(e.key.toString());if(r){if(!t.isEqual(r))throw new C(D.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(en.min())?nb.exists(!1):nb.updateTime(t):nb.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(en.min()))throw new C(D.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return nb.updateTime(t)}return nb.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}let o6="FirestoreClient";class o8{constructor(e,t,r,n,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=r,this.databaseInfo=n,this.user=y.UNAUTHENTICATED,this.clientId=U.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(r,async e=>{T(o6,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(r,e=>(T(o6,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new k;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(r){let t=a4(r,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function o9(e,t){e.asyncQueue.verifyOperationInProgress(),T(o6,"Initializing OfflineComponentProvider");let r=e.configuration;await t.initialize(r);let n=r.initialUser;e.setCredentialChangeListener(async e=>{n.isEqual(e)||(await sj(t.localStore,e),n=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function o7(e,t){e.asyncQueue.verifyOperationInProgress();let r=await le(e);T(o6,"Initializing OnlineComponentProvider"),await t.initialize(r,e.configuration),e.setCredentialChangeListener(e=>aZ(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,r)=>aZ(t.remoteStore,r)),e._onlineComponents=t}async function le(e){if(!e._offlineComponents){if(e._uninitializedComponentsProvider){T(o6,"Using user provided OfflineComponentProvider");try{await o9(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===D.FAILED_PRECONDITION||t.code===D.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;E("Error using user provided cache. Falling back to memory cache: "+t),await o9(e,new oJ)}}else T(o6,"Using default OfflineComponentProvider"),await o9(e,new oY(void 0))}return e._offlineComponents}async function lt(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(T(o6,"Using user provided OnlineComponentProvider"),await o7(e,e._uninitializedComponentsProvider._online)):(T(o6,"Using default OnlineComponentProvider"),await o7(e,new o0))),e._onlineComponents}function lr(e){return lt(e).then(e=>e.syncEngine)}async function ln(e){let t=await lt(e),r=t.eventManager;return r.onListen=ow.bind(null,t.syncEngine),r.onUnlisten=ob.bind(null,t.syncEngine),r.onFirstRemoteStoreListen=ov.bind(null,t.syncEngine),r.onLastRemoteStoreUnlisten=oE.bind(null,t.syncEngine),r}function li(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let ls=new Map,la="firestore.googleapis.com";class lo{constructor(e){if(void 0===e.host){if(void 0!==e.ssl)throw new C(D.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=la,this.ssl=!0}else this.host=e.host,this.ssl=e.ssl??!0;if(this.isUsingEmulator=void 0!==e.emulatorOptions,this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new C(D.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,r,n){if(!0===t&&!0===n)throw new C(D.INVALID_ARGUMENT,`${e} and ${r} cannot be used together.`)})("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=li(e.experimentalLongPollingOptions??{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new C(D.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new C(D.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new C(D.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,r;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,r=e.experimentalLongPollingOptions,t.timeoutSeconds===r.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class ll{constructor(e,t,r,n){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=r,this._app=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new lo({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new C(D.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new C(D.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new lo(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new V;switch(e.type){case"firstParty":return new P(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new C(D.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=ls.get(e);t&&(T("ComponentProvider","Removing Datastore"),ls.delete(e),t.terminate())}(this),Promise.resolve()}}class lu{constructor(e,t,r){this.converter=t,this._query=r,this.type="query",this.firestore=e}withConverter(e){return new lu(this.firestore,e,this._query)}}class lh{constructor(e,t,r){this.converter=t,this._key=r,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new lc(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new lh(this.firestore,e,this._key)}toJSON(){return{type:lh._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(e,t,r){if(et(t,lh._jsonSchema))return new lh(e,r||null,new H(j.fromString(t.referencePath)))}}lh._jsonSchemaVersion="firestore/documentReference/1.0",lh._jsonSchema={type:ee("string",lh._jsonSchemaVersion),referencePath:ee("string")};class lc extends lu{constructor(e,t,r){super(e,t,rQ(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new lh(this.firestore,null,new H(e))}withConverter(e){return new lc(this.firestore,e,this._path)}}function ld(e,t,...r){if(e=(0,h.Ku)(e),1==arguments.length&&(t=U.newId()),function(e,t,r){if(!r)throw new C(D.INVALID_ARGUMENT,`Function doc() cannot be called with an empty ${t}.`)}("doc","path",t),e instanceof ll){let n=j.fromString(t,...r);return J(n),new lh(e,null,new H(n))}{if(!(e instanceof lh||e instanceof lc))throw new C(D.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let n=e._path.child(j.fromString(t,...r));return J(n),new lh(e.firestore,e instanceof lc?e.converter:null,new H(n))}}let lf="AsyncQueue";class lm{constructor(e=Promise.resolve()){this.Xu=[],this.ec=!1,this.tc=[],this.nc=null,this.rc=!1,this.sc=!1,this.oc=[],this.M_=new aT(this,"async_queue_retry"),this._c=()=>{let e=av();e&&T(lf,"Visibility state changed to "+e.visibilityState),this.M_.w_()},this.ac=e;let t=av();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this._c)}get isShuttingDown(){return this.ec}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.uc(),this.cc(e)}enterRestrictedMode(e){if(!this.ec){this.ec=!0,this.sc=e||!1;let t=av();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this._c)}}enqueue(e){if(this.uc(),this.ec)return new Promise(()=>{});let t=new k;return this.cc(()=>this.ec&&this.sc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Xu.push(e),this.lc()))}async lc(){if(0!==this.Xu.length){try{await this.Xu[0](),this.Xu.shift(),this.M_.reset()}catch(e){if(!eE(e))throw e;T(lf,"Operation failed with retryable error: "+e)}this.Xu.length>0&&this.M_.p_(()=>this.lc())}}cc(e){let t=this.ac.then(()=>(this.rc=!0,e().catch(e=>{throw this.nc=e,this.rc=!1,b("INTERNAL UNHANDLED ERROR: ",lg(e)),e}).then(e=>(this.rc=!1,e))));return this.ac=t,t}enqueueAfterDelay(e,t,r){this.uc(),this.oc.indexOf(e)>-1&&(t=0);let n=a5.createAndSchedule(this,e,t,r,e=>this.hc(e));return this.tc.push(n),n}uc(){this.nc&&S(47125,{Pc:lg(this.nc)})}verifyOperationInProgress(){}async Tc(){let e;do e=this.ac,await e;while(e!==this.ac)}Ic(e){for(let t of this.tc)if(t.timerId===e)return!0;return!1}Ec(e){return this.Tc().then(()=>{for(let t of(this.tc.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.tc))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Tc()})}dc(e){this.oc.push(e)}hc(e){let t=this.tc.indexOf(e);this.tc.splice(t,1)}}function lg(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}function lp(e){return function(e,t){if("object"!=typeof e||null===e)return!1;for(let r of t)if(r in e&&"function"==typeof e[r])return!0;return!1}(e,["next","error","complete"])}class ly{constructor(){this._progressObserver={},this._taskCompletionResolver=new k,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,r){this._progressObserver={next:e,error:t,complete:r}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class lw extends ll{constructor(e,t,r,n){super(e,t,r,n),this.type="firestore",this._queue=new lm,this._persistenceKey=n?.name||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new lm(e),this._firestoreClient=void 0,await e}}}function lv(e,t){let r="object"==typeof e?e:(0,o.Sx)(),n=(0,o.j6)(r,"firestore").getImmediate({identifier:"string"==typeof e?e:t||tZ});if(!n._initialized){let e=(0,h.yU)("firestore");e&&function(e,t,r,n={}){e=Z(e,ll);let i=(0,h.zJ)(t),s=e._getSettings(),a={...s,emulatorOptions:e._getEmulatorOptions()},o=`${t}:${r}`;i&&((0,h.gE)(`https://${o}`),(0,h.P1)("Firestore",!0)),s.host!==la&&s.host!==o&&E("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");let l={...s,host:o,ssl:i,emulatorOptions:n};if(!(0,h.bD)(l,a)&&(e._setSettings(l),n.mockUserToken)){let t,r;if("string"==typeof n.mockUserToken)t=n.mockUserToken,r=y.MOCK_USER;else{t=(0,h.Fy)(n.mockUserToken,e._app?.options.projectId);let i=n.mockUserToken.sub||n.mockUserToken.user_id;if(!i)throw new C(D.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");r=new y(i)}e._authCredentials=new R(new A(t,r))}}(n,...e)}return n}function lI(e){if(e._terminated)throw new C(D.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||lT(e),e._firestoreClient}function lT(e){var t,r;let n=e._freezeSettings(),i=(t=e._databaseId,r=e._app?.options.appId||"",new tX(t,r,e._persistenceKey,n.host,n.ssl,n.experimentalForceLongPolling,n.experimentalAutoDetectLongPolling,li(n.experimentalLongPollingOptions),n.useFetchStreams,n.isUsingEmulator));e._componentsProvider||n.localCache?._offlineComponentProvider&&n.localCache?._onlineComponentProvider&&(e._componentsProvider={_offline:n.localCache._offlineComponentProvider,_online:n.localCache._onlineComponentProvider}),e._firestoreClient=new o8(e._authCredentials,e._appCheckCredentials,e._queue,i,e._componentsProvider&&function(e){let t=e?._online.build();return{_offline:e?._offline.build(t),_online:t}}(e._componentsProvider))}class lb{constructor(e){this._byteString=e}static fromBase64String(e){try{return new lb(tq.fromBase64String(e))}catch(e){throw new C(D.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new lb(tq.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}toJSON(){return{type:lb._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(e){if(et(e,lb._jsonSchema))return lb.fromBase64String(e.bytes)}}lb._jsonSchemaVersion="firestore/bytes/1.0",lb._jsonSchema={type:ee("string",lb._jsonSchemaVersion),bytes:ee("string")};class lE{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new C(D.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new W(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class l_{constructor(e){this._methodName=e}}class lS{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new C(D.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new C(D.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}_compareTo(e){return q(this._lat,e._lat)||q(this._long,e._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:lS._jsonSchemaVersion}}static fromJSON(e){if(et(e,lS._jsonSchema))return new lS(e.latitude,e.longitude)}}lS._jsonSchemaVersion="firestore/geoPoint/1.0",lS._jsonSchema={type:ee("string",lS._jsonSchemaVersion),latitude:ee("number"),longitude:ee("number")};class lx{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0}(this._values,e._values)}toJSON(){return{type:lx._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(e){if(et(e,lx._jsonSchema)){if(Array.isArray(e.vectorValues)&&e.vectorValues.every(e=>"number"==typeof e))return new lx(e.vectorValues);throw new C(D.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}lx._jsonSchemaVersion="firestore/vectorValue/1.0",lx._jsonSchema={type:ee("string",lx._jsonSchemaVersion),vectorValues:ee("object")};let lN=/^__.*__$/;class lD{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return null!==this.fieldMask?new nC(e,this.data,this.fieldMask,t,this.fieldTransforms):new nD(e,this.data,t,this.fieldTransforms)}}class lC{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return new nC(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function lk(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw S(40011,{Ac:e})}}class lA{constructor(e,t,r,n,i,s){this.settings=e,this.databaseId=t,this.serializer=r,this.ignoreUndefinedProperties=n,void 0===i&&this.Rc(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Ac(){return this.settings.Ac}Vc(e){return new lA({...this.settings,...e},this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}mc(e){let t=this.path?.child(e),r=this.Vc({path:t,fc:!1});return r.gc(e),r}yc(e){let t=this.path?.child(e),r=this.Vc({path:t,fc:!1});return r.Rc(),r}wc(e){return this.Vc({path:void 0,fc:!0})}Sc(e){return lY(e,this.settings.methodName,this.settings.bc||!1,this.path,this.settings.Dc)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Rc(){if(this.path)for(let e=0;e<this.path.length;e++)this.gc(this.path.get(e))}gc(e){if(0===e.length)throw this.Sc("Document fields must not be empty");if(lk(this.Ac)&&lN.test(e))throw this.Sc('Document fields cannot begin and end with "__"')}}class lV{constructor(e,t,r){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=r||aI(e)}Cc(e,t,r,n=!1){return new lA({Ac:e,methodName:t,Dc:r,path:W.emptyPath(),fc:!1,bc:n},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function lR(e){let t=e._freezeSettings(),r=aI(e._databaseId);return new lV(e._databaseId,!!t.ignoreUndefinedProperties,r)}function lM(e,t,r,n,i,s={}){let a,o;let l=e.Cc(s.merge||s.mergeFields?2:0,t,r,i);lQ("Data must be an object, but it was:",l,n);let u=lG(n,l);if(s.merge)a=new tL(l.fieldMask),o=l.fieldTransforms;else if(s.mergeFields){let e=[];for(let n of s.mergeFields){let i=lW(t,n,r);if(!l.contains(i))throw new C(D.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);lX(e,i)||e.push(i)}a=new tL(e),o=l.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,o=l.fieldTransforms;return new lD(new rp(u),a,o)}class lO extends l_{_toFieldTransform(e){if(2!==e.Ac)throw 1===e.Ac?e.Sc(`${this._methodName}() can only appear at the top level of your update data`):e.Sc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof lO}}function lP(e,t,r){return new lA({Ac:3,Dc:t.settings.Dc,methodName:e._methodName,fc:r},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class lF extends null{_toFieldTransform(e){return new nI(e.path,new nd)}isEqual(e){return e instanceof lF}}class lL extends l_{constructor(e,t){super(e),this.vc=t}_toFieldTransform(e){let t=lP(this,e,!0),r=new nf(this.vc.map(e=>l$(e,t)));return new nI(e.path,r)}isEqual(e){return e instanceof lL&&(0,h.bD)(this.vc,e.vc)}}class lU extends l_{constructor(e,t){super(e),this.vc=t}_toFieldTransform(e){let t=lP(this,e,!0),r=new ng(this.vc.map(e=>l$(e,t)));return new nI(e.path,r)}isEqual(e){return e instanceof lU&&(0,h.bD)(this.vc,e.vc)}}class lq extends l_{constructor(e,t){super(e),this.Fc=t}_toFieldTransform(e){let t=new ny(e.serializer,nu(e.serializer,this.Fc));return new nI(e.path,t)}isEqual(e){return e instanceof lq&&this.Fc===e.Fc}}function lB(e,t,r,n){let i=e.Cc(1,t,r);lQ("Data must be an object, but it was:",i,n);let s=[],a=rp.empty();return tk(n,(e,n)=>{let o=lJ(t,e,r);n=(0,h.Ku)(n);let l=i.yc(o);if(n instanceof lO)s.push(o);else{let e=l$(n,l);null!=e&&(s.push(o),a.set(o,e))}}),new lC(a,new tL(s),i.fieldTransforms)}function lz(e,t,r,n,i,s){let a=e.Cc(1,t,r),o=[lW(t,n,r)],l=[i];if(s.length%2!=0)throw new C(D.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(lW(t,s[e])),l.push(s[e+1]);let u=[],c=rp.empty();for(let e=o.length-1;e>=0;--e)if(!lX(u,o[e])){let t=o[e],r=l[e];r=(0,h.Ku)(r);let n=a.yc(t);if(r instanceof lO)u.push(t);else{let e=l$(r,n);null!=e&&(u.push(t),c.set(t,e))}}return new lC(c,new tL(u),a.fieldTransforms)}function lK(e,t,r,n=!1){return l$(r,e.Cc(n?4:3,t))}function l$(e,t){if(lj(e=(0,h.Ku)(e)))return lQ("Unsupported field value:",t,e),lG(e,t);if(e instanceof l_)return function(e,t){if(!lk(t.Ac))throw t.Sc(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Sc(`${e._methodName}() is not currently supported inside arrays`);let r=e._toFieldTransform(t);r&&t.fieldTransforms.push(r)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.fc&&4!==t.Ac)throw t.Sc("Nested arrays are not supported");return function(e,t){let r=[],n=0;for(let i of e){let e=l$(i,t.wc(n));null==e&&(e={nullValue:"NULL_VALUE"}),r.push(e),n++}return{arrayValue:{values:r}}}(e,t)}return function(e,t){if(null===(e=(0,h.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return nu(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let r=er.fromDate(e);return{timestampValue:n8(t.serializer,r)}}if(e instanceof er){let r=new er(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:n8(t.serializer,r)}}if(e instanceof lS)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof lb)return{bytesValue:n9(t.serializer,e._byteString)};if(e instanceof lh){let r=t.databaseId,n=e.firestore._databaseId;if(!n.isEqual(r))throw t.Sc(`Document reference is for database ${n.projectId}/${n.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:ie(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof lx)return{mapValue:{fields:{[t1]:{stringValue:t4},[t3]:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Sc("VectorValues must only contain numeric values.");return no(t.serializer,e)})}}}}};throw t.Sc(`Unsupported field value: ${X(e)}`)}(e,t)}function lG(e,t){let r={};return tA(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):tk(e,(e,n)=>{let i=l$(n,t.mc(e));null!=i&&(r[e]=i)}),{mapValue:{fields:r}}}function lj(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof er||e instanceof lS||e instanceof lb||e instanceof lh||e instanceof l_||e instanceof lx)}function lQ(e,t,r){if(!lj(r)||!Y(r)){let n=X(r);throw"an object"===n?t.Sc(e+" a custom object"):t.Sc(e+" "+n)}}function lW(e,t,r){if((t=(0,h.Ku)(t))instanceof lE)return t._internalPath;if("string"==typeof t)return lJ(e,t);throw lY("Field path arguments must be of type string or ",e,!1,void 0,r)}let lH=RegExp("[~\\*/\\[\\]]");function lJ(e,t,r){if(t.search(lH)>=0)throw lY(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,r);try{return new lE(...t.split("."))._internalPath}catch(n){throw lY(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,r)}}function lY(e,t,r,n,i){let s=n&&!n.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;r&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${n}`),a&&(l+=` in document ${i}`),l+=")"),new C(D.INVALID_ARGUMENT,o+e+l)}function lX(e,t){return e.some(e=>e.isEqual(t))}class lZ{constructor(e,t,r,n,i){this._firestore=e,this._userDataWriter=t,this._key=r,this._document=n,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new lh(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new l0(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(l1("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class l0 extends lZ{data(){return super.data()}}function l1(e,t){return"string"==typeof t?lJ(e,t):t instanceof lE?t._internalPath:t._delegate._internalPath}class l2{}class l5 extends l2{}class l4 extends l5{constructor(e,t,r){super(),this._field=e,this._op=t,this._value=r,this.type="where"}static _create(e,t,r){return new l4(e,t,r)}_apply(e){let t=this._parse(e);return un(e._query,t),new lu(e.firestore,e.converter,rZ(e._query,t))}_parse(e){let t=lR(e.firestore);return function(e,t,r,n,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new C(D.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){ur(a,s);let t=[];for(let r of a)t.push(ut(n,e,r));o={arrayValue:{values:t}}}else o=ut(n,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||ur(a,s),o=lK(r,t,a,"in"===s||"not-in"===s);return rE.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class l3 extends l2{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new l3(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:r_.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let r=e;for(let e of t.getFlattenedFilters())un(r,e),r=rZ(r,e)}(e._query,t),new lu(e.firestore,e.converter,rZ(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class l6 extends l5{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new l6(e,t)}_apply(e){let t=function(e,t,r){if(null!==e.startAt)throw new C(D.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new C(D.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new rT(t,r)}(e._query,this._field,this._direction);return new lu(e.firestore,e.converter,function(e,t){let r=e.explicitOrderBy.concat([t]);return new rj(e.path,e.collectionGroup,r,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}class l8 extends l5{constructor(e,t,r){super(),this.type=e,this._limit=t,this._limitType=r}static _create(e,t,r){return new l8(e,t,r)}_apply(e){return new lu(e.firestore,e.converter,r0(e._query,this._limit,this._limitType))}}class l9 extends l5{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new l9(e,t,r)}_apply(e){var t;let r=ue(e,this.type,this._docOrFields,this._inclusive);return new lu(e.firestore,e.converter,new rj((t=e._query).path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,r,t.endAt))}}class l7 extends l5{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new l7(e,t,r)}_apply(e){var t;let r=ue(e,this.type,this._docOrFields,this._inclusive);return new lu(e.firestore,e.converter,new rj((t=e._query).path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,r))}}function ue(e,t,r,n){if(r[0]=(0,h.Ku)(r[0]),r[0]instanceof lZ)return function(e,t,r,n,i){if(!n)throw new C(D.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${r}().`);let s=[];for(let r of rJ(e))if(r.field.isKeyField())s.push(ri(t,n.key));else{let e=n.data.field(r.field);if(tH(e))throw new C(D.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+r.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=r.field.canonicalString();throw new C(D.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new rw(s,i)}(e._query,e.firestore._databaseId,t,r[0]._document,n);{let i=lR(e.firestore);return function(e,t,r,n,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new C(D.INVALID_ARGUMENT,`Too many arguments provided to ${n}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new C(D.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${n}(), but got a ${typeof l}`);if(!rH(e)&&-1!==l.indexOf("/"))throw new C(D.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${n}() must be a plain document ID, but '${l}' contains a slash.`);let r=e.path.child(j.fromString(l));if(!H.isDocumentKey(r))throw new C(D.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${n}() must result in a valid document path, but '${r}' is not because it contains an odd number of segments.`);let i=new H(r);o.push(ri(t,i))}else{let e=lK(r,n,l);o.push(e)}}return new rw(o,s)}(e._query,e.firestore._databaseId,i,t,r,n)}}function ut(e,t,r){if("string"==typeof(r=(0,h.Ku)(r))){if(""===r)throw new C(D.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!rH(t)&&-1!==r.indexOf("/"))throw new C(D.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${r}' contains a '/' character.`);let n=t.path.child(j.fromString(r));if(!H.isDocumentKey(n))throw new C(D.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${n}' is not because it has an odd number of segments (${n.length}).`);return ri(e,new H(n))}if(r instanceof lh)return ri(e,r._key);throw new C(D.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${X(r)}.`)}function ur(e,t){if(!Array.isArray(e)||0===e.length)throw new C(D.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function un(e,t){let r=function(e,t){for(let r of e)for(let e of r.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==r)throw r===t.op?new C(D.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new C(D.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}class ui{convertValue(e,t="none"){switch(t8(e)){case 0:return null;case 1:return e.booleanValue;case 2:return tK(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(t$(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw S(62114,{value:e})}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let r={};return tk(e,(e,n)=>{r[e]=this.convertValue(n,t)}),r}convertVectorValue(e){return new lx(e.fields?.[t3].arrayValue?.values?.map(e=>tK(e.doubleValue)))}convertGeoPoint(e){return new lS(tK(e.latitude),tK(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let r=tJ(e);return null==r?null:this.convertValue(r,t);case"estimate":return this.convertTimestamp(tY(e));default:return null}}convertTimestamp(e){let t=tz(e);return new er(t.seconds,t.nanos)}convertDocumentKey(e,t){let r=j.fromString(e);N(iI(r),9688,{name:e});let n=new t0(r.get(1),r.get(3)),i=new H(r.popFirst(5));return n.isEqual(t)||b(`Document ${i} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function us(e,t,r){return e?r&&(r.merge||r.mergeFields)?e.toFirestore(t,r):e.toFirestore(t):t}class ua extends ui{constructor(e){super(),this.firestore=e}convertBytes(e){return new lb(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lh(this.firestore,null,t)}}class uo{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class ul extends lZ{constructor(e,t,r,n,i,s){super(e,t,r,n,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new uu(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let r=this._document.data.field(l1("DocumentSnapshot.get",e));if(null!==r)return this._userDataWriter.convertValue(r,t.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new C(D.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");let e=this._document,t={};return t.type=ul._jsonSchemaVersion,t.bundle="",t.bundleSource="DocumentSnapshot",t.bundleName=this._key.toString(),e&&e.isValidDocument()&&e.isFoundDocument()&&(this._userDataWriter.convertObjectMap(e.data.value.mapValue.fields,"previous"),this._firestore,this.ref.path,t.bundle="NOT SUPPORTED"),t}}ul._jsonSchemaVersion="firestore/documentSnapshot/1.0",ul._jsonSchema={type:ee("string",ul._jsonSchemaVersion),bundleSource:ee("string","DocumentSnapshot"),bundleName:ee("string"),bundle:ee("string")};class uu extends ul{data(e={}){return super.data(e)}}class uh{constructor(e,t,r,n){this._firestore=e,this._userDataWriter=t,this._snapshot=n,this.metadata=new uo(n.hasPendingWrites,n.fromCache),this.query=r}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(r=>{e.call(t,new uu(this._firestore,this._userDataWriter,r.key,r,new uo(this._snapshot.mutatedKeys.has(r.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new C(D.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(r=>{let n=new uu(e._firestore,e._userDataWriter,r.doc.key,r.doc,new uo(e._snapshot.mutatedKeys.has(r.doc.key),e._snapshot.fromCache),e.query.converter);return r.doc,{type:"added",doc:n,oldIndex:-1,newIndex:t++}})}{let r=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{let n=new uu(e._firestore,e._userDataWriter,t.doc.key,t.doc,new uo(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,s=-1;return 0!==t.type&&(i=r.indexOf(t.doc.key),r=r.delete(t.doc.key)),1!==t.type&&(s=(r=r.add(t.doc)).indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return S(61501,{type:e})}}(t.type),doc:n,oldIndex:i,newIndex:s}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new C(D.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");let e={};e.type=uh._jsonSchemaVersion,e.bundleSource="QuerySnapshot",e.bundleName=U.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;let t=[],r=[],n=[];return this.docs.forEach(e=>{null!==e._document&&(t.push(e._document),r.push(this._userDataWriter.convertObjectMap(e._document.data.value.mapValue.fields,"previous")),n.push(e.ref.path))}),this._firestore,this.query._query,e.bundleName,e.bundle="NOT SUPPORTED",e}}uh._jsonSchemaVersion="firestore/querySnapshot/1.0",uh._jsonSchema={type:ee("string",uh._jsonSchemaVersion),bundleSource:ee("string","QuerySnapshot"),bundleName:ee("string"),bundle:ee("string")};class uc extends ui{constructor(e){super(),this.firestore=e}convertBytes(e){return new lb(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lh(this.firestore,null,t)}}function ud(e,t,r){e=Z(e,lh);let n=Z(e.firestore,lw),i=us(e.converter,t,r);return function(e,t){return function(e,t){let r=new k;return e.asyncQueue.enqueueAndForget(async()=>o_(await lr(e),t,r)),r.promise}(lI(e),t)}(n,[lM(lR(n),"setDoc",e._key,i,null!==e.converter,r).toMutation(e._key,nb.none())])}class uf{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=o0.provider,this._offlineComponentProvider={build:t=>new oX(t,e?.cacheSizeBytes,this.forceOwnership)}}}function um(e,t){if((e=(0,h.Ku)(e)).firestore!==t)throw new C(D.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class ug{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=lR(e)}get(e){let t=um(e,this._firestore),r=new ua(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return S(24041);let n=e[0];if(n.isFoundDocument())return new lZ(this._firestore,r,n.key,n,t.converter);if(n.isNoDocument())return new lZ(this._firestore,r,t._key,null,t.converter);throw S(18433,{doc:n})})}set(e,t,r){let n=um(e,this._firestore),i=us(n.converter,t,r),s=lM(this._dataReader,"Transaction.set",n._key,i,null!==n.converter,r);return this._transaction.set(n._key,s),this}update(e,t,r,...n){let i;let s=um(e,this._firestore);return i="string"==typeof(t=(0,h.Ku)(t))||t instanceof lE?lz(this._dataReader,"Transaction.update",s._key,t,r,n):lB(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){let t=um(e,this._firestore);return this._transaction.delete(t._key),this}}new WeakMap,!function(e,t=!0){w=o.MF,(0,o.om)(new l.uA("firestore",(e,{instanceIdentifier:r,options:n})=>{let i=e.getProvider("app").getImmediate(),s=new lw(new M(e.getProvider("auth-internal")),new L(i,e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new C(D.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new t0(e.options.projectId,t)}(i,r),i);return n={useFetchStreams:t,...n},s._setSettings(n),s},"PUBLIC").setMultipleInstances(!0)),(0,o.KO)(g,p,void 0),(0,o.KO)(g,p,"esm2020")}()}}]);